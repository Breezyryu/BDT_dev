diff --git a/BatteryDataTool.py b/BatteryDataTool_optRCD.py
index 47a293d..e1b3b32 100644
--- a/BatteryDataTool.py
+++ b/BatteryDataTool_optRCD.py
@@ -4,18 +4,21 @@ import re
 import bisect
 import warnings
 import json
+from functools import lru_cache
 from concurrent.futures import ThreadPoolExecutor, as_completed
 import pyodbc
 import pandas as pd
 import numpy as np
 import matplotlib.pyplot as plt
+import matplotlib.cm as cm
+import matplotlib.colors as mcolors
 from scipy.optimize import curve_fit, root_scalar
 from scipy.stats import linregress
 from datetime import datetime
 from tkinter import filedialog, Tk
 from PyQt6 import QtCore, QtGui, QtWidgets
-from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas
-from matplotlib.backends.backend_qt5agg import NavigationToolbar2QT as NavigationToolbar
+from matplotlib.backends.backend_qtagg import FigureCanvasQTAgg as FigureCanvas
+from matplotlib.backends.backend_qtagg import NavigationToolbar2QT as NavigationToolbar
 from datetime import timezone
 import glob
 import xlwings as xw
@@ -25,9 +28,60 @@ import xlwings as xw
 
 # 寃쎄퀬 臾댁떆
 warnings.simplefilter("ignore")
-# ?쒓? ?ㅼ젙
+
+# ?? Pro-Nature ?뚮쭏 (Presentation + Nature ?쇳빀) ??
+THEME = {
+    'PALETTE': ['#3C5488', '#E64B35', '#00A087', '#F39B7F', '#4DBBD5',
+                '#8491B4', '#B09C85', '#91D1C2', '#DC0000', '#7E6148'],
+    'FIG_FACECOLOR': '#FFFFFF',
+    'AX_FACECOLOR': '#FAFBFD',
+    'TITLE_SIZE': 15,
+    'LABEL_SIZE': 12,
+    'TICK_SIZE': 10,
+    'SCATTER_SIZE': 7,
+    'SCATTER_EMPTY_SIZE': 7,
+    'SCATTER_ALPHA': 0.55,
+    'SCATTER_SET_SIZE': 4,
+    'EDGE_WIDTH': 0,
+    'EDGE_COLOR': 'none',
+    'LINE_WIDTH': 1.4,
+    'LINE_ALPHA': 0.6,
+    'MARKER_SIZE': 5,
+    'GRID_ALPHA': 0.18,
+    'GRID_STYLE': '--',
+    'GRID_WIDTH': 0.5,
+    'GRID_COLOR': '#666666',
+    'SPINE_COLOR': '#666666',
+    'SPINE_WIDTH': 0.6,
+    'CMAP': 'coolwarm',
+    'SUPTITLE_SIZE': 15,
+    'SUPTITLE_WEIGHT': 'bold',
+    'LEGEND_SIZE': 'small',
+    'LEGEND_FRAMEALPHA': 0.85,
+    'LEGEND_EDGECOLOR': '#CCCCCC',
+    'DPI': 150,
+}
+
+# ?쒓? ?ㅼ젙 + Pro-Nature rcParams ?꾩뿭 ?곸슜
 plt.rcParams["font.family"] = "Malgun gothic"
 plt.rcParams["axes.unicode_minus"] = False
+plt.rcParams["figure.facecolor"] = THEME['FIG_FACECOLOR']
+plt.rcParams["axes.facecolor"] = THEME['AX_FACECOLOR']
+plt.rcParams["axes.spines.top"] = False
+plt.rcParams["axes.spines.right"] = False
+plt.rcParams["axes.edgecolor"] = THEME['SPINE_COLOR']
+plt.rcParams["axes.linewidth"] = THEME['SPINE_WIDTH']
+plt.rcParams["axes.grid"] = True
+plt.rcParams["grid.alpha"] = THEME['GRID_ALPHA']
+plt.rcParams["grid.linestyle"] = THEME['GRID_STYLE']
+plt.rcParams["grid.linewidth"] = THEME['GRID_WIDTH']
+plt.rcParams["grid.color"] = THEME['GRID_COLOR']
+plt.rcParams["xtick.direction"] = "in"
+plt.rcParams["ytick.direction"] = "in"
+plt.rcParams["xtick.labelsize"] = THEME['TICK_SIZE']
+plt.rcParams["ytick.labelsize"] = THEME['TICK_SIZE']
+plt.rcParams["lines.linewidth"] = THEME['LINE_WIDTH']
+plt.rcParams["axes.prop_cycle"] = plt.cycler(color=THEME['PALETTE'])
 
 # timestamp 蹂???⑥닔 ?뺤쓽
 def to_timestamp(date_str):
@@ -159,6 +213,18 @@ def check_cycler(raw_file_path):
     cycler = os.path.isdir(raw_file_path + "\\Pattern")
     return cycler
 
+# 肄붿씤?/PNE21쨌22 關A ?⑥쐞 ?ъ슜 ?щ? ?먮퀎
+_coincell_mode = False
+
+def set_coincell_mode(enabled):
+    """肄붿씤? 泥댄겕諛뺤뒪 ?곹깭 ?ㅼ젙 (泥섎━ ?쒖옉 ???몄텧)"""
+    global _coincell_mode
+    _coincell_mode = enabled
+
+def is_micro_unit(raw_file_path):
+    """PNE21/22 ?먮뒗 肄붿씤? 紐⑤뱶?먯꽌 關A/關Ah ?⑥쐞 ?ъ슜 ?щ? ?먮퀎"""
+    return ('PNE21' in raw_file_path) or ('PNE22' in raw_file_path) or _coincell_mode
+
 # 二쇱뼱吏?臾몄옄?댁쓣 由ъ뒪?몃줈 蹂?? def convert_steplist(input_str):
     output_list = []
@@ -180,11 +246,15 @@ def same_add(df, column_name):
     return df
     
 # 洹몃옒??base 湲곕낯 ?ㅼ젙 ?⑥닔 (x?쇰꺼, y?쇰꺼, 洹몃━???묒떇)
+# 踰붾? ?쒖떆 ?꾧퀎媛? ???섎? 珥덇낵?섎㈃ 洹몃씪?곗씠??而щ윭諛붾줈 ?꾪솚
+LEGEND_THRESHOLD = 15
+
 def graph_base_parameter(graph_ax, xlabel, ylabel): 
-    graph_ax.set_xlabel(xlabel, fontsize= 12, fontweight='bold')
-    graph_ax.set_ylabel(ylabel, fontsize= 10, fontweight='bold')
-    graph_ax.tick_params(direction='in')
-    graph_ax.grid(True, which='both', linestyle='--', linewidth=1.0)
+    graph_ax.set_xlabel(xlabel, fontsize=THEME['LABEL_SIZE'], fontweight='bold')
+    graph_ax.set_ylabel(ylabel, fontsize=THEME['LABEL_SIZE'] - 1, fontweight='bold')
+    graph_ax.tick_params(direction='in', labelsize=THEME['TICK_SIZE'])
+    graph_ax.grid(True, which='both', linestyle=THEME['GRID_STYLE'],
+                  linewidth=THEME['GRID_WIDTH'], alpha=THEME['GRID_ALPHA'], color=THEME['GRID_COLOR'])
 
 # Cycle 洹몃옒??湲곕낯, x異? y異?min, max 諛?踰붿쐞 ?ㅼ젙
 def graph_cycle_base(x_data, ax, lowlimit, highlimit, y_gap, xlabel, ylabel, xscale, overall_xlimit):
@@ -196,7 +266,7 @@ def graph_cycle_base(x_data, ax, lowlimit, highlimit, y_gap, xlabel, ylabel, xsc
     else:
         xlimit = xscale
         xrangemax = xscale
-    xrangegap = ((xlimit >= 400) + (xlimit >= 800) * 2 + (xlimit >= 1200) * 4 + (xlimit >= 2000) * 2 + 1) * 50
+    xrangegap = ((xlimit >= 400) + (xlimit >= 800) + (xlimit >= 1500) * 2 + (xlimit >= 3000) * 2 + (xlimit >= 6000) * 4 + 1) * 50
     ax.set_xticks(np.arange(0, xrangemax + xrangegap, xrangegap))
     if highlimit != 0:
         ax.set_yticks(np.arange(lowlimit, highlimit, y_gap))
@@ -207,47 +277,60 @@ def graph_cycle_base(x_data, ax, lowlimit, highlimit, y_gap, xlabel, ylabel, xsc
 def graph_cycle(x, y, ax, lowlimt, highlimit, ygap, xlabel, ylabel, tlabel, xscale, cyc_color, overall_xlimit = 0):
     # 吏?뺤깋???놁쑝硫?湲곕낯???ъ슜
     if cyc_color != 0:
-        ax.scatter(x, y, label=tlabel, s=5, color=cyc_color)
+        sc = ax.scatter(x, y, label=tlabel, s=THEME['SCATTER_SIZE'], color=cyc_color,
+                   alpha=THEME['SCATTER_ALPHA'], edgecolors=THEME['EDGE_COLOR'],
+                   linewidths=THEME['EDGE_WIDTH'], zorder=3)
     else:
-        ax.scatter(x, y, label=tlabel, s=5)
-    graph_cycle_base(x, ax, lowlimt, highlimit, ygap, xlabel, ylabel, xscale, overall_xlimit = 0)    
+        sc = ax.scatter(x, y, label=tlabel, s=THEME['SCATTER_SIZE'],
+                   alpha=THEME['SCATTER_ALPHA'], edgecolors=THEME['EDGE_COLOR'],
+                   linewidths=THEME['EDGE_WIDTH'], zorder=3)
+    graph_cycle_base(x, ax, lowlimt, highlimit, ygap, xlabel, ylabel, xscale, overall_xlimit)
+    return sc    
 
 # Cycle 洹몃옒??洹몃━湲?- 吏?뺤깋 湲곗? ?ъ슜/ scatter 梨꾩슦湲??놁쓬
 def graph_cycle_empty(x, y, ax, lowlimt, highlimit, ygap, xlabel, ylabel, tlabel, xscale, cyc_color, overall_xlimit = 0):
-    # 吏?뺤깋???놁쑝硫?湲곕낯???ъ슜
+    # empty scatter???뚮몢由щ줈留?蹂댁씠誘濡?linewidths瑜?蹂꾨룄 吏??     if cyc_color != 0:
-        ax.scatter(x, y, label=tlabel, s=8, edgecolors=cyc_color, facecolors ='none')
+        sc = ax.scatter(x, y, label=tlabel, s=THEME['SCATTER_EMPTY_SIZE'], edgecolors=cyc_color,
+                   facecolors='none', alpha=THEME['SCATTER_ALPHA'],
+                   linewidths=0.6, zorder=3)
     else:
-        ax.scatter(x, y, label=tlabel, s=8, facecolors = 'none')
-    graph_cycle_base(x, ax, lowlimt, highlimit, ygap, xlabel, ylabel, xscale, overall_xlimit = 0)    
+        sc = ax.scatter(x, y, label=tlabel, s=THEME['SCATTER_EMPTY_SIZE'],
+                   facecolors='none', alpha=THEME['SCATTER_ALPHA'],
+                   linewidths=0.6, zorder=3)
+    graph_cycle_base(x, ax, lowlimt, highlimit, ygap, xlabel, ylabel, xscale, overall_xlimit)
+    return sc    
 
 def graph_output_cycle(df, xscale, ylimitlow, ylimithigh, irscale, lgnd, temp_lgnd, colorno, graphcolor,
                        dcir, ax1, ax2, ax3, ax4, ax5, ax6):
-    graph_cycle(df.NewData.index, df.NewData.Dchg, ax1, ylimitlow, ylimithigh, 0.05,
-                "Cycle", "Discharge Capacity Ratio", temp_lgnd, xscale, graphcolor[colorno % 9])
-    graph_cycle(df.NewData.index, df.NewData.Eff, ax2, 0.992, 1.004, 0.002,
-                "Cycle", "Discharge/Charge Efficiency", temp_lgnd, xscale, graphcolor[colorno % 9])
-    graph_cycle(df.NewData.index, df.NewData.Temp, ax3, 0, 50, 5,
-                "Cycle", "Temperature (??", temp_lgnd, xscale, graphcolor[colorno % 9])
-    graph_cycle(df.NewData.index, df.NewData.RndV, ax6, 3.00, 4.00, 0.1,
-                "Cycle", "Rest End Voltage (V)", "", xscale, graphcolor[colorno % 9])
-    graph_cycle_empty(df.NewData.index, df.NewData.Eff2, ax5, 0.996, 1.008, 0.002,
-                      "Cycle", "Charge/Discharge Efficiency", temp_lgnd, xscale, graphcolor[colorno % 9])
-    graph_cycle_empty(df.NewData.index, df.NewData.AvgV, ax6, 3.00, 4.00, 0.1,
-                      "Cycle", "Average/Rest Voltage (V)", temp_lgnd, xscale, graphcolor[colorno % 9])
+    artists = []  # ??梨꾨꼸??紐⑤뱺 scatter artist ?섏쭛
+    color = graphcolor[colorno % len(THEME['PALETTE'])]
+    artists.append(graph_cycle(df.NewData.index, df.NewData.Dchg, ax1, ylimitlow, ylimithigh, 0.05,
+                "Cycle", "Discharge Capacity Ratio", temp_lgnd, xscale, color))
+    artists.append(graph_cycle(df.NewData.index, df.NewData.Eff, ax2, 0.992, 1.004, 0.002,
+                "Cycle", "Discharge/Charge Efficiency", temp_lgnd, xscale, color))
+    artists.append(graph_cycle(df.NewData.index, df.NewData.Temp, ax3, 0, 50, 5,
+                "Cycle", "Temperature (??", temp_lgnd, xscale, color))
+    artists.append(graph_cycle(df.NewData.index, df.NewData.RndV, ax6, 3.00, 4.00, 0.1,
+                "Cycle", "Rest End Voltage (V)", "", xscale, color))
+    artists.append(graph_cycle(df.NewData.index, df.NewData.Eff2, ax5, 0.996, 1.008, 0.002,
+                      "Cycle", "Charge/Discharge Efficiency", temp_lgnd, xscale, color))
+    artists.append(graph_cycle_empty(df.NewData.index, df.NewData.AvgV, ax6, 3.00, 4.00, 0.1,
+                      "Cycle", "Average/Rest Voltage (V)", temp_lgnd, xscale, color))
     if dcir.isChecked() and hasattr(df.NewData, "dcir2"):
-        graph_cycle_empty(df.NewData.index, df.NewData.soc70_dcir, ax4, 0, 120.0 * irscale, 20 * irscale,
-                        "Cycle", "RSS/ 1s DC-IR (m??", "", xscale, graphcolor[colorno % 9])
-        graph_cycle(df.NewData.index, df.NewData.soc70_rss_dcir, ax4, 0, 120.0 * irscale, 20 * irscale,
-                    "Cycle", "RSS/ 1s DC-IR (m??", temp_lgnd, xscale, graphcolor[colorno % 9])
+        artists.append(graph_cycle_empty(df.NewData.index, df.NewData.soc70_dcir, ax4, 0, 120.0 * irscale, 20 * irscale,
+                        "Cycle", "RSS/ 1s DC-IR (m廓)", "", xscale, color))
+        artists.append(graph_cycle(df.NewData.index, df.NewData.soc70_rss_dcir, ax4, 0, 120.0 * irscale, 20 * irscale,
+                    "Cycle", "RSS/ 1s DC-IR (m廓)", temp_lgnd, xscale, color))
     else:
-        graph_cycle(df.NewData.index, df.NewData.dcir, ax4, 0, 120.0 * irscale, 20 * irscale,
-                    "Cycle", "DC-IR (m??", temp_lgnd, xscale, graphcolor[colorno % 9])
-    colorno = colorno % 9 + 1
+        artists.append(graph_cycle(df.NewData.index, df.NewData.dcir, ax4, 0, 120.0 * irscale, 20 * irscale,
+                    "Cycle", "DC-IR (m廓)", temp_lgnd, xscale, color))
+    colorno = colorno % len(THEME['PALETTE']) + 1
+    return artists, color
 
 # Step charge Profile 洹몃옒??洹몃━湲? def graph_step(x, y, ax, lowlimit, highlimit, limitgap, xlabel, ylabel, tlabel):
-    ax.plot(x, y, label=tlabel)
+    ax.plot(x, y, label=tlabel, linewidth=THEME['LINE_WIDTH'], alpha=THEME['LINE_ALPHA'])
     ax.set_yticks(np.arange(lowlimit, highlimit, limitgap))
     ax.set_ylim(lowlimit, highlimit - limitgap)
     graph_base_parameter(ax, xlabel, ylabel)
@@ -255,9 +338,10 @@ def graph_step(x, y, ax, lowlimit, highlimit, limitgap, xlabel, ylabel, tlabel):
 # ?곗냽 洹몃옒??洹몃━湲? def graph_continue(x, y, ax, lowlimit, highlimit, limitgap, xlabel, ylabel, tlabel, type = "-"):
     if type == "-":
-        ax.plot(x, y, label=tlabel)
+        ax.plot(x, y, label=tlabel, linewidth=THEME['LINE_WIDTH'], alpha=THEME['LINE_ALPHA'])
     else:
-        ax.plot(x, y, label=tlabel, marker='o', markersize = 3)
+        ax.plot(x, y, label=tlabel, marker='o', markersize=THEME['MARKER_SIZE'],
+                linewidth=THEME['LINE_WIDTH'], alpha=THEME['LINE_ALPHA'])
     ax.set_yticks(np.arange(lowlimit, highlimit, limitgap))
     ax.set_ylim(lowlimit, highlimit - limitgap)
     graph_base_parameter(ax, xlabel, ylabel)
@@ -265,9 +349,10 @@ def graph_continue(x, y, ax, lowlimit, highlimit, limitgap, xlabel, ylabel, tlab
 # ?곗냽 洹몃옒??洹몃━湲? def graph_soc_continue(x, y, ax, lowlimit, highlimit, limitgap, xlabel, ylabel, tlabel, type = "-"):
     if type == "-":
-        ax.plot(x, y, label=tlabel)
+        ax.plot(x, y, label=tlabel, linewidth=THEME['LINE_WIDTH'], alpha=THEME['LINE_ALPHA'])
     else:
-        ax.plot(x, y, label=tlabel, marker='o', markersize = 3)
+        ax.plot(x, y, label=tlabel, marker='o', markersize=THEME['MARKER_SIZE'],
+                linewidth=THEME['LINE_WIDTH'], alpha=THEME['LINE_ALPHA'])
     ax.set_xticks(np.arange(0, 110, 10))
     ax.set_yticks(np.arange(lowlimit, highlimit, limitgap))
     ax.set_ylim(lowlimit, highlimit - limitgap)
@@ -276,23 +361,25 @@ def graph_soc_continue(x, y, ax, lowlimit, highlimit, limitgap, xlabel, ylabel,
 # OCV 湲곕컲 DCIR 洹몃옒??洹몃━湲? def graph_dcir(x, y, ax, xlabel, ylabel, tlabel, type = "-"):
     if type == "-":
-        ax.plot(x, y, label=tlabel)
+        ax.plot(x, y, label=tlabel, linewidth=THEME['LINE_WIDTH'], alpha=THEME['LINE_ALPHA'])
     else:
-        ax.plot(x, y, label=tlabel, marker='o', markersize = 3)
+        ax.plot(x, y, label=tlabel, marker='o', markersize=THEME['MARKER_SIZE'],
+                linewidth=THEME['LINE_WIDTH'], alpha=THEME['LINE_ALPHA'])
     graph_base_parameter(ax, xlabel, ylabel)
 
 # SOC蹂?DCIR 洹몃옒??洹몃━湲? def graph_soc_dcir(x, y, ax, xlabel, ylabel, tlabel, type = "-"):
     if type == "-":
-        ax.plot(x, y, label=tlabel)
+        ax.plot(x, y, label=tlabel, linewidth=THEME['LINE_WIDTH'], alpha=THEME['LINE_ALPHA'])
     else:
-        ax.plot(x, y, label=tlabel, marker='o', markersize = 3)
+        ax.plot(x, y, label=tlabel, marker='o', markersize=THEME['MARKER_SIZE'],
+                linewidth=THEME['LINE_WIDTH'], alpha=THEME['LINE_ALPHA'])
     ax.set_xticks(np.arange(0, 110, 10))
     graph_base_parameter(ax, xlabel, ylabel)
 
 # 異⑸갑??Profile 洹몃옒??洹몃━湲? def graph_profile(x, y, ax, xlowlimit, xhighlimit, xlimitgap, ylowlimit, yhighlimit, ylimitgap, xlabel, ylabel, tlabel):
-    ax.plot(x, y, label=tlabel)
+    ax.plot(x, y, label=tlabel, linewidth=THEME['LINE_WIDTH'], alpha=THEME['LINE_ALPHA'])
     ax.set_xticks(np.arange(xlowlimit, xhighlimit, xlimitgap))
     ax.set_xlim(xlowlimit, xhighlimit - xlimitgap)
     ax.set_yticks(np.arange(ylowlimit, yhighlimit, ylimitgap))
@@ -301,13 +388,14 @@ def graph_profile(x, y, ax, xlowlimit, xhighlimit, xlimitgap, ylowlimit, yhighli
 
 # set profile 洹몃옒??洹몃━湲? def graph_soc_set(x, y, ax, lowlimit, highlimit, limitgap, xlabel, ylabel, tlabel, xlimit):
-    colors = {3: 'red', 4: 'blue', 5: 'green', 6: 'magenta', 7: 'cyan', 8: 'red', 9: 'red'}
+    _P = THEME['PALETTE']
+    colors = {3: _P[1], 4: _P[0], 5: _P[2], 6: _P[3], 7: _P[4], 8: _P[1], 9: _P[1]}
     if xlimit == {0, 1, 2}:
-        ax.scatter(x, y, label=tlabel, s=1)
+        ax.scatter(x, y, label=tlabel, s=THEME['SCATTER_SET_SIZE'], alpha=THEME['SCATTER_ALPHA'])
     elif xlimit in colors:
-        ax.scatter(x, y, label=tlabel, s=1, color = colors[xlimit])
+        ax.scatter(x, y, label=tlabel, s=THEME['SCATTER_SET_SIZE'], color=colors[xlimit], alpha=THEME['SCATTER_ALPHA'])
     else:
-        ax.scatter(x, y, label=tlabel, s=1)
+        ax.scatter(x, y, label=tlabel, s=THEME['SCATTER_SET_SIZE'], alpha=THEME['SCATTER_ALPHA'])
     if limitgap != 0:
         ax.set_yticks(np.arange(lowlimit, highlimit, limitgap))
         ax.set_ylim(lowlimit, highlimit - limitgap)
@@ -315,7 +403,8 @@ def graph_soc_set(x, y, ax, lowlimit, highlimit, limitgap, xlabel, ylabel, tlabe
 
 # ECT SOC ?먮윭 ?뺤씤 洹몃옒?? def graph_soc_err(x, y, ax, lowlimit, highlimit, limitgap, xlabel, ylabel, tlabel, xlimit):
-    colors = {3: 'red', 4: 'blue', 5: 'green', 6: 'magenta', 7: 'cyan', 8: 'red', 9: 'red'}
+    _P = THEME['PALETTE']
+    colors = {3: _P[1], 4: _P[0], 5: _P[2], 6: _P[3], 7: _P[4], 8: _P[1], 9: _P[1]}
     df = pd.DataFrame({'x': x, 'y': abs(y)})
     grouped = df.groupby(df['x']//5).mean()
     index_x = grouped.index * 5
@@ -328,11 +417,12 @@ def graph_soc_err(x, y, ax, lowlimit, highlimit, limitgap, xlabel, ylabel, tlabe
 
 # set profile 洹몃옒??洹몃━湲? def graph_set_profile(x, y, ax, y_llimit, y_hlimit, y_gap, xlabel, ylabel, tlabel, graphcolor, x_llimit, x_hlimit, x_gap):
-    colors = {1: 'red', 2: 'blue', 3: 'green', 4: 'magenta', 5: 'cyan'}
+    _P = THEME['PALETTE']
+    colors = {1: _P[1], 2: _P[0], 3: _P[2], 4: _P[3], 5: _P[4]}
     if graphcolor in colors:
-        ax.scatter(x, y, label=tlabel, s=1, color=colors[graphcolor])
+        ax.scatter(x, y, label=tlabel, s=THEME['SCATTER_SET_SIZE'], color=colors[graphcolor], alpha=THEME['SCATTER_ALPHA'])
     else:
-        ax.scatter(x, y, label=tlabel, s=1)
+        ax.scatter(x, y, label=tlabel, s=THEME['SCATTER_SET_SIZE'], alpha=THEME['SCATTER_ALPHA'])
     if x_gap != 0:
         ax.set_xticks(np.arange(x_llimit, x_hlimit, x_gap))
         ax.set_xlim(x_llimit, x_hlimit - x_gap)
@@ -363,22 +453,25 @@ def graph_simulation(ax, x, y, pltcolor, pltlabel, x_limit, y_min, y_limit, xlab
 
 def graph_eu_set(ax, y_min, y_max):
     ax.set_ylim(y_min, y_max)
-    ax.set_ylabel('capacity ratio', fontsize= 20, fontweight='bold')
-    ax.set_xlabel('cycle', fontsize= 20, fontweight='bold')
+    ax.set_ylabel('capacity ratio', fontsize=THEME['TITLE_SIZE'] + 3, fontweight='bold')
+    ax.set_xlabel('cycle', fontsize=THEME['TITLE_SIZE'] + 3, fontweight='bold')
     ax.tick_params(direction='in')
-    ax.tick_params(axis='x', labelsize=16)
-    ax.tick_params(axis='y', labelsize=16)
-    ax.grid(True, which='both', linestyle='--', linewidth=0.5)
-    ax.legend(prop={"size": 16})
+    ax.tick_params(axis='x', labelsize=THEME['TICK_SIZE'] + 4)
+    ax.tick_params(axis='y', labelsize=THEME['TICK_SIZE'] + 4)
+    ax.grid(True, which='both', linestyle=THEME['GRID_STYLE'],
+            linewidth=THEME['GRID_WIDTH'], alpha=THEME['GRID_ALPHA'])
+    ax.legend(prop={"size": THEME['TICK_SIZE'] + 4})
 
 def graph_default(ax, x, y, x_llimit, x_hlimit, x_gap, y_llimit, y_hlimit, y_gap,
-                  xlabel, ylabel, lgnd, size, graphcolor,facecolor, graphmarker):
-    colors = {0: 'red', 1: 'blue', 2: 'green', 3: 'magenta', 4: 'cyan'}
+                  xlabel, ylabel, lgnd, size, graphcolor, facecolor, graphmarker):
+    _P = THEME['PALETTE']
+    colors = {0: _P[1], 1: _P[0], 2: _P[2], 3: _P[3], 4: _P[4]}
     if graphcolor in colors:
         ax.scatter(x, y, label=lgnd, s=size, color=colors[graphcolor],
-                   edgecolors=colors[graphcolor], facecolors=colors[graphcolor], marker = graphmarker)
+                   edgecolors=colors[graphcolor], facecolors=colors[graphcolor],
+                   marker=graphmarker, alpha=THEME['SCATTER_ALPHA'])
     else:
-        ax.scatter(x, y, label=lgnd, s=size)
+        ax.scatter(x, y, label=lgnd, s=size, alpha=THEME['SCATTER_ALPHA'])
     if x_gap != 0:
         ax.set_xticks(np.arange(x_llimit, x_hlimit, x_gap))
         ax.set_xlim(x_llimit, x_hlimit - x_gap)
@@ -397,7 +490,8 @@ def output_para_fig(figsaveokchk, filename):
         if os.path.isfile('d:/'+ filename +'.png'):
             os.remove('d:/'+ filename +'.png')
         fig = plt.gcf()
-        fig.savefig('d:/'+ filename +'.png')
+        fig.savefig('d:/'+ filename +'.png', dpi=THEME['DPI'],
+                    facecolor=THEME['FIG_FACECOLOR'], bbox_inches='tight')
 
 # 洹몃옒?꾨? D?쒕씪?대툕??洹몃┝ ?뚯씪濡???ν븯???듭뀡
 def output_fig(figsaveokchk, filename):
@@ -405,7 +499,8 @@ def output_fig(figsaveokchk, filename):
     if figsaveokchk.isChecked():
         if os.path.isfile('d:/'+ filename +'.png'):
             os.remove('d:/'+ filename +'.png')
-        plt.savefig('d:/'+ filename +'.png')
+        plt.savefig('d:/'+ filename +'.png', dpi=THEME['DPI'],
+                    facecolor=THEME['FIG_FACECOLOR'], bbox_inches='tight')
 
 # ?쒕뜡??媛??앹꽦 ?⑥닔
 def generate_params(ca_mass_min, ca_mass_max, ca_slip_min, ca_slip_max, an_mass_min, an_mass_max, an_slip_min, an_slip_max):
@@ -570,7 +665,6 @@ def toyo_cycle_data(raw_file_path, mincapacity, inirate, chkir):
         Dchg = Dchgdata["Cap[mAh]"]
         Temp= Dchgdata["PeakTemp[Deg]"]
         DchgEng = Dchgdata["Pow[mWh]"]
-        Chg2 = Chg.shift(periods=-1)
         AvgV = Dchgdata["AveVolt[V]"]
         OriCycle = Dchgdata.loc[:,"OriCycle"]
         # dcir 湲곕낯 泥섎━
@@ -605,9 +699,29 @@ def toyo_cycle_data(raw_file_path, mincapacity, inirate, chkir):
                         n = n + dcirstep - 1
         dcir["Cyc"] = cyccal
         dcir = dcir.set_index(dcir["Cyc"])
-        # 異⑸갑???⑥쑉 怨꾩궛
-        Eff = Dchg/Chg
-        Eff2 = Chg2/Dchg
+        # ?? 異⑸갑???⑥쑉 怨꾩궛 (蹂묓빀 ??TotlCycle ?몃뜳??蹂댁젙) ??
+        # Toyo 蹂묓빀 ??Chg ?몃뜳??8,13,18??? Dchg ?몃뜳??9,14,19??媛
+        # 1移몄뵫 ?닿툔?섎?濡? ?쒖꽌(?꾩튂) 湲곕컲?쇰줈 ?ъ젙?ы븯??留ㅼ묶
+        if len(Dchg) > 0 and len(Chg) > 0:
+            # 珥덇린 遺遺?諛⑹쟾(留ㅼ묶 異⑹쟾 ?놁쓬) ?쒓굅
+            if Dchg.index[0] < Chg.index[0]:
+                Dchg = Dchg.iloc[1:]
+                Temp = Temp.iloc[1:]
+                DchgEng = DchgEng.iloc[1:]
+                AvgV = AvgV.iloc[1:]
+                OriCycle = OriCycle.iloc[1:]
+            # Chg/Ocv瑜?Dchg ?몃뜳?ㅼ뿉 ?꾩튂 湲곕컲 ?ъ젙??+            _nmin = min(len(Chg), len(Dchg))
+            Chg = pd.Series(Chg.values[:_nmin], index=Dchg.index[:_nmin])
+            Ocv = pd.Series(Ocv.values[:_nmin], index=Dchg.index[:_nmin])
+            Dchg = Dchg.iloc[:_nmin]
+            Temp = Temp.iloc[:_nmin]
+            DchgEng = DchgEng.iloc[:_nmin]
+            AvgV = AvgV.iloc[:_nmin]
+            OriCycle = OriCycle.iloc[:_nmin]
+        Chg2 = Chg.shift(periods=-1)
+        Eff = Dchg / Chg
+        Eff2 = Chg2 / Dchg
         # ?⑸웾 ratio
         Dchg = Dchg/mincapacity
         Chg = Chg/mincapacity
@@ -627,6 +741,56 @@ def toyo_cycle_data(raw_file_path, mincapacity, inirate, chkir):
     return [mincapacity, df]
 
 
+def toyo_build_cycle_map(raw_file_path, mincapacity, inirate):
+    """capacity.log 湲곕컲 ?쇰━ ?ъ씠??踰덊샇(1-based) ???먮낯 ?뚯씪 踰붿쐞(start, end) 留ㅽ븨 ?앹꽦.
+    toyo_cycle_data()? ?숈씪???ъ씠???ъ젙??濡쒖쭅(諛⑹쟾?쒖옉 蹂댁젙, ?곗냽 Condition 蹂묓빀)???곸슜.
+    Returns: (cycle_map, mincapacity)
+      cycle_map: {logical_cycle: (first_file_no, last_file_no)}
+    """
+    mincapacity = toyo_min_cap(raw_file_path, mincapacity, inirate)
+    tempdata = toyo_cycle_import(raw_file_path)
+    if not (hasattr(tempdata, "dataraw") and not tempdata.dataraw.empty):
+        return {}, mincapacity
+
+    Cycleraw = tempdata.dataraw.copy()
+    Cycleraw["OriCycle"] = Cycleraw["TotlCycle"].copy()
+
+    # 諛⑹쟾 ?쒖옉 ??data 蹂寃?(toyo_cycle_data? ?숈씪)
+    if Cycleraw.iloc[0]["Condition"] == 2 and len(Cycleraw) > 2:
+        if Cycleraw.iloc[1]["TotlCycle"] == 1:
+            Cycleraw.loc[Cycleraw["Condition"] == 2, "TotlCycle"] -= 1
+            Cycleraw = Cycleraw.drop(0, axis=0).reset_index(drop=True)
+
+    # ?곗냽 ?숈씪 Condition 踰≫꽣 洹몃９ (toyo_cycle_data? ?숈씪)
+    cond_series = Cycleraw["Condition"]
+    merge_group = ((cond_series != cond_series.shift()) | (~cond_series.isin([1, 2]))).cumsum()
+
+    # 洹몃９蹂?OriCycle 踰붿쐞 + ?붿빟 ?뺣낫 異붿텧
+    group_info = Cycleraw.groupby(merge_group).agg(
+        TotlCycle=("TotlCycle", "last"),
+        Condition=("Condition", "first"),
+        Cap=("Cap[mAh]", "sum"),
+        OriMin=("OriCycle", "min"),
+        OriMax=("OriCycle", "max")
+    ).reset_index(drop=True)
+
+    # 諛⑹쟾 洹몃９ 以??좏슚 ?ъ씠?대쭔 ?꾪꽣留?(toyo_cycle_data??Dchgdata 議곌굔)
+    dchg_mask = (group_info["Condition"] == 2) & (group_info["Cap"] > mincapacity / 60)
+    dchg_indices = group_info[dchg_mask].index.tolist()
+
+    # ?쇰━ ?ъ씠????(?쒖옉?뚯씪, ?앺뙆?? 留ㅽ븨
+    cycle_map = {}
+    for logical_num, dchg_idx in enumerate(dchg_indices, start=1):
+        dchg_ori_max = int(group_info.loc[dchg_idx, "OriMax"])
+        # 吏곸쟾 洹몃９??異⑹쟾(Condition=1)?대㈃, ?대떦 異⑹쟾??OriMin???ъ씠???쒖옉
+        if dchg_idx > 0 and group_info.loc[dchg_idx - 1, "Condition"] == 1:
+            first_file = int(group_info.loc[dchg_idx - 1, "OriMin"])
+        else:
+            first_file = int(group_info.loc[dchg_idx, "OriMin"])
+        cycle_map[logical_num] = (first_file, dchg_ori_max)
+
+    return cycle_map, mincapacity
+
 
 def toyo_step_Profile_batch(raw_file_path, cycle_list, mincapacity, cutoff, inirate):
     """
@@ -751,8 +915,8 @@ def pne_step_Profile_batch(raw_file_path, cycle_list, mincapacity, cutoff, inira
             results[cyc] = [mincapacity, pd.DataFrame()]
         return results
     
-    # PNE21/22 ?⑥쐞 蹂??怨꾩닔 寃곗젙
-    is_pne21_22 = ('PNE21' in raw_file_path) or ('PNE22' in raw_file_path)
+    # PNE21/22/肄붿씤? ?⑥쐞 蹂??怨꾩닔 寃곗젙
+    is_pne21_22 = is_micro_unit(raw_file_path)
     current_divisor = mincapacity * 1000000 if is_pne21_22 else mincapacity * 1000
     cap_divisor = current_divisor
     
@@ -792,6 +956,262 @@ def pne_step_Profile_batch(raw_file_path, cycle_list, mincapacity, cutoff, inira
     return results
 
 
+# ??? PNE SaveData ?쇨큵 濡쒕뵫 ?ы띁 (諛곗튂 怨듯넻) ???
+def _pne_load_profile_raw(raw_file_path, min_cycle, max_cycle, mincapacity, inirate):
+    """PNE SaveData ?뚯씪???쇨큵 濡쒕뵫?섎뒗 諛곗튂 怨듯넻 ?ы띁.
+    min_cycle ~ max_cycle 踰붿쐞???먯떆 ?곗씠?곕? 1???붿뒪??I/O濡?痍⑤뱷?쒕떎.
+    Returns: (mincapacity, all_raw: pd.DataFrame|None, is_pne21_22: bool)
+    """
+    if (raw_file_path[-4:-1]) == "ter":
+        return (mincapacity, None, False)
+
+    mincapacity = pne_min_cap(raw_file_path, mincapacity, inirate)
+
+    rawdir = raw_file_path + "\\Restore\\"
+    if not os.path.isdir(rawdir):
+        return (mincapacity, None, False)
+
+    subfile = [f for f in os.listdir(rawdir) if f.endswith(".csv")]
+    save_end_data = None
+    file_index_list = None
+    for files in subfile:
+        if "SaveEndData" in files:
+            save_end_data = pd.read_csv(rawdir + files, sep=",", skiprows=0, engine="c",
+                                         header=None, encoding="cp949", on_bad_lines='skip')
+        if files == "savingFileIndex_start.csv":
+            df2 = pd.read_csv(rawdir + files, sep=r"\s+", skiprows=0, engine="c",
+                               header=None, encoding="cp949", on_bad_lines='skip')
+            file_index_list = df2[3].str.replace(',', '').astype(int).tolist()
+
+    if save_end_data is None or file_index_list is None:
+        return (mincapacity, None, False)
+
+    # ?뚯씪 踰붿쐞 寃곗젙
+    if min_cycle != 1:
+        index_min = save_end_data.loc[(save_end_data.loc[:, 27] == (min_cycle - 1)), 0].tolist()
+    else:
+        index_min = [0]
+    index_max = save_end_data.loc[(save_end_data.loc[:, 27] == max_cycle), 0].tolist()
+    if not index_max:
+        index_max = save_end_data.loc[(save_end_data.loc[:, 27] == save_end_data.loc[:, 27].max()), 0].tolist()
+
+    if len(index_min) == 0:
+        file_start = 0
+    else:
+        file_start = binary_search(file_index_list, index_min[-1] + 1) - 1
+    file_end = binary_search(file_index_list, index_max[-1]) - 1
+    if file_start < 0:
+        file_start = 0
+
+    # SaveData ?쇨큵 濡쒕뵫
+    all_raw = None
+    for files in subfile[file_start:(file_end + 1)]:
+        if "SaveData" in files:
+            chunk = pd.read_csv(rawdir + files, sep=",", skiprows=0, engine="c",
+                                header=None, encoding="cp949", on_bad_lines='skip')
+            if all_raw is None:
+                all_raw = chunk
+            else:
+                all_raw = pd.concat([all_raw, chunk], ignore_index=True)
+
+    is_pne21_22 = is_micro_unit(raw_file_path)
+    return (mincapacity, all_raw, is_pne21_22)
+
+
+# ??? Rate Profile 諛곗튂 ?⑥닔 ???
+def toyo_rate_Profile_batch(raw_file_path, cycle_list, mincapacity, cutoff, inirate):
+    """Toyo Rate ?꾨줈?뚯씪 諛곗튂 濡쒕뵫: min_cap 1???곗젙 ???ъ씠??諛섎났."""
+    mincapacity = toyo_min_cap(raw_file_path, mincapacity, inirate)
+    results = {}
+    for inicycle in cycle_list:
+        results[inicycle] = toyo_rate_Profile_data(raw_file_path, inicycle, mincapacity, cutoff, inirate)
+    return results
+
+
+def pne_rate_Profile_batch(raw_file_path, cycle_list, mincapacity, cutoff, inirate):
+    """PNE Rate ?꾨줈?뚯씪 諛곗튂 濡쒕뵫: SaveData 1??濡쒕뵫 ???ъ씠?대퀎 遺꾨같."""
+    mincapacity, all_raw, is_pne21_22 = _pne_load_profile_raw(
+        raw_file_path, min(cycle_list), max(cycle_list) + 1, mincapacity, inirate)
+    results = {}
+    if all_raw is None:
+        for cyc in cycle_list:
+            results[cyc] = [mincapacity, pd.DataFrame()]
+        return results
+
+    current_divisor = mincapacity * 1000000 if is_pne21_22 else mincapacity * 1000
+    cap_divisor = current_divisor
+
+    for inicycle in cycle_list:
+        df = pd.DataFrame()
+        cycle_raw = all_raw[(all_raw[27] == inicycle) & (all_raw[2].isin([9, 1]))].copy()
+        if len(cycle_raw) > 0:
+            cycle_raw = cycle_raw[[17, 8, 9, 21, 10, 7]]
+            cycle_raw.columns = ["PassTime[Sec]", "Voltage[V]", "Current[mA]", "Temp1[Deg]", "Chgcap", "step"]
+            cycle_raw["PassTime[Sec]"] = cycle_raw["PassTime[Sec]"] / 100 / 60
+            cycle_raw["Voltage[V]"] = cycle_raw["Voltage[V]"] / 1000000
+            cycle_raw["Current[mA]"] = cycle_raw["Current[mA]"] / current_divisor
+            cycle_raw["Chgcap"] = cycle_raw["Chgcap"] / cap_divisor
+            cycle_raw["Temp1[Deg]"] = cycle_raw["Temp1[Deg]"] / 1000
+            cycle_raw = cycle_raw[(cycle_raw["Current[mA]"] >= cutoff)]
+            df.rateProfile = cycle_raw[["PassTime[Sec]", "Chgcap", "Voltage[V]", "Current[mA]", "Temp1[Deg]"]]
+            df.rateProfile.columns = ["TimeMin", "SOC", "Vol", "Crate", "Temp"]
+        results[inicycle] = [mincapacity, df]
+    return results
+
+
+# ??? Chg Profile 諛곗튂 ?⑥닔 ???
+def toyo_chg_Profile_batch(raw_file_path, cycle_list, mincapacity, cutoff, inirate, smoothdegree):
+    """Toyo Chg ?꾨줈?뚯씪 諛곗튂 濡쒕뵫: min_cap 1???곗젙 ???ъ씠??諛섎났."""
+    mincapacity = toyo_min_cap(raw_file_path, mincapacity, inirate)
+    results = {}
+    for inicycle in cycle_list:
+        results[inicycle] = toyo_chg_Profile_data(raw_file_path, inicycle, mincapacity, cutoff, inirate, smoothdegree)
+    return results
+
+
+def pne_chg_Profile_batch(raw_file_path, cycle_list, mincapacity, cutoff, inirate, smoothdegree):
+    """PNE Chg ?꾨줈?뚯씪 諛곗튂 濡쒕뵫: SaveData 1??濡쒕뵫 ???ъ씠?대퀎 遺꾨같."""
+    mincapacity, all_raw, is_pne21_22 = _pne_load_profile_raw(
+        raw_file_path, min(cycle_list), max(cycle_list) + 1, mincapacity, inirate)
+    results = {}
+    if all_raw is None:
+        for cyc in cycle_list:
+            results[cyc] = [mincapacity, pd.DataFrame()]
+        return results
+
+    current_divisor = mincapacity * 1000000 if is_pne21_22 else mincapacity * 1000
+    cap_divisor = current_divisor
+
+    for inicycle in cycle_list:
+        df = pd.DataFrame()
+        cycle_raw = all_raw[(all_raw[27] == inicycle) & (all_raw[2].isin([9, 1]))].copy()
+        if len(cycle_raw) > 0:
+            cycle_raw = cycle_raw[[17, 8, 9, 10, 14, 21, 7]]
+            cycle_raw.columns = ["PassTime[Sec]", "Voltage[V]", "Current[mA]", "Chgcap", "Chgwh", "Temp1[Deg]", "step"]
+            cycle_raw["PassTime[Sec]"] = cycle_raw["PassTime[Sec]"] / 100 / 60
+            cycle_raw["Voltage[V]"] = cycle_raw["Voltage[V]"] / 1000000
+            cycle_raw["Current[mA]"] = cycle_raw["Current[mA]"] / current_divisor
+            cycle_raw["Chgcap"] = cycle_raw["Chgcap"] / cap_divisor
+            cycle_raw["Temp1[Deg]"] = cycle_raw["Temp1[Deg]"] / 1000
+            # ?ㅽ뀦 ?곌껐 泥섎━
+            stepmin = cycle_raw.step.min()
+            stepmax = cycle_raw.step.max()
+            stepdiv = stepmax - stepmin
+            if not np.isnan(stepdiv):
+                if stepdiv == 0:
+                    df.Profile = cycle_raw
+                else:
+                    Profiles = [cycle_raw.loc[cycle_raw.step == stepmin]]
+                    for si in range(1, int(stepdiv) + 1):
+                        Profiles.append(cycle_raw.loc[cycle_raw.step == stepmin + si])
+                        Profiles[-1]["PassTime[Sec]"] += Profiles[-2]["PassTime[Sec]"].max()
+                        Profiles[-1]["Chgcap"] += Profiles[-2]["Chgcap"].max()
+                    df.Profile = pd.concat(Profiles)
+            if hasattr(df, "Profile"):
+                df.Profile = df.Profile.reset_index()
+                df.Profile = df.Profile[(df.Profile["Current[mA]"] >= cutoff)]
+                sd = smoothdegree if smoothdegree != 0 else max(int(len(df.Profile) / 30), 1)
+                df.Profile["delvol"] = df.Profile["Voltage[V]"].diff(periods=sd)
+                df.Profile["delcap"] = df.Profile["Chgcap"].diff(periods=sd)
+                df.Profile["dQdV"] = df.Profile["delcap"] / df.Profile["delvol"]
+                df.Profile["dVdQ"] = df.Profile["delvol"] / df.Profile["delcap"]
+                df.Profile = df.Profile[["PassTime[Sec]", "Chgcap", "Chgwh", "Voltage[V]", "Current[mA]",
+                                         "dQdV", "dVdQ", "Temp1[Deg]"]]
+                df.Profile.columns = ["TimeMin", "SOC", "Energy", "Vol", "Crate", "dQdV", "dVdQ", "Temp"]
+        results[inicycle] = [mincapacity, df]
+    return results
+
+
+# ??? Dchg Profile 諛곗튂 ?⑥닔 ???
+def toyo_dchg_Profile_batch(raw_file_path, cycle_list, mincapacity, cutoff, inirate, smoothdegree):
+    """Toyo Dchg ?꾨줈?뚯씪 諛곗튂 濡쒕뵫: min_cap 1???곗젙 ???ъ씠??諛섎났."""
+    mincapacity = toyo_min_cap(raw_file_path, mincapacity, inirate)
+    results = {}
+    for inicycle in cycle_list:
+        results[inicycle] = toyo_dchg_Profile_data(raw_file_path, inicycle, mincapacity, cutoff, inirate, smoothdegree)
+    return results
+
+
+def pne_dchg_Profile_batch(raw_file_path, cycle_list, mincapacity, cutoff, inirate, smoothdegree):
+    """PNE Dchg ?꾨줈?뚯씪 諛곗튂 濡쒕뵫: SaveData 1??濡쒕뵫 ???ъ씠?대퀎 遺꾨같."""
+    mincapacity, all_raw, is_pne21_22 = _pne_load_profile_raw(
+        raw_file_path, min(cycle_list), max(cycle_list) + 1, mincapacity, inirate)
+    results = {}
+    if all_raw is None:
+        for cyc in cycle_list:
+            results[cyc] = [mincapacity, pd.DataFrame()]
+        return results
+
+    current_divisor = mincapacity * 1000000 if is_pne21_22 else mincapacity * 1000
+    cap_divisor = current_divisor
+
+    for inicycle in cycle_list:
+        df = pd.DataFrame()
+        cycle_raw = all_raw[(all_raw[27] == inicycle) & (all_raw[2].isin([9, 2]))].copy()
+        if len(cycle_raw) > 0:
+            cycle_raw = cycle_raw[[17, 8, 9, 11, 15, 21, 7]]
+            cycle_raw.columns = ["PassTime[Sec]", "Voltage[V]", "Current[mA]", "Dchgcap", "Dchgwh", "Temp1[Deg]", "step"]
+            cycle_raw["PassTime[Sec]"] = cycle_raw["PassTime[Sec]"] / 100 / 60
+            cycle_raw["Voltage[V]"] = cycle_raw["Voltage[V]"] / 1000000
+            cycle_raw["Current[mA]"] = cycle_raw["Current[mA]"] / current_divisor * (-1)
+            cycle_raw["Dchgcap"] = cycle_raw["Dchgcap"] / cap_divisor
+            cycle_raw["Temp1[Deg]"] = cycle_raw["Temp1[Deg]"] / 1000
+            # ?ㅽ뀦 ?곌껐 泥섎━
+            stepmin = cycle_raw.step.min()
+            stepmax = cycle_raw.step.max()
+            stepdiv = stepmax - stepmin
+            if not np.isnan(stepdiv):
+                if stepdiv == 0:
+                    df.Profile = cycle_raw
+                else:
+                    Profiles = [cycle_raw.loc[cycle_raw.step == stepmin]]
+                    for si in range(1, int(stepdiv) + 1):
+                        Profiles.append(cycle_raw.loc[cycle_raw.step == stepmin + si])
+                        Profiles[-1]["PassTime[Sec]"] += Profiles[-2]["PassTime[Sec]"].max()
+                        Profiles[-1]["Dchgcap"] += Profiles[-2]["Dchgcap"].max()
+                    df.Profile = pd.concat(Profiles)
+            if hasattr(df, 'Profile'):
+                df.Profile = df.Profile.reset_index()
+                df.Profile = df.Profile[(df.Profile["Voltage[V]"] >= cutoff)]
+                sd = smoothdegree if smoothdegree != 0 else max(int(len(df.Profile) / 30), 1)
+                df.Profile["delvol"] = df.Profile["Voltage[V]"].diff(periods=sd)
+                df.Profile["delcap"] = df.Profile["Dchgcap"].diff(periods=sd)
+                df.Profile["dQdV"] = df.Profile["delcap"] / df.Profile["delvol"]
+                df.Profile["dVdQ"] = df.Profile["delvol"] / df.Profile["delcap"]
+                df.Profile = df.Profile[["PassTime[Sec]", "Dchgcap", "Dchgwh", "Voltage[V]", "Current[mA]",
+                                         "dQdV", "dVdQ", "Temp1[Deg]"]]
+                df.Profile.columns = ["TimeMin", "SOC", "Energy", "Vol", "Crate", "dQdV", "dVdQ", "Temp"]
+        results[inicycle] = [mincapacity, df]
+    return results
+
+
+# ??? Continue Profile 諛곗튂 ?⑥닔 ???
+def toyo_continue_Profile_batch(raw_file_path, step_ranges, mincapacity, inirate):
+    """Toyo Continue ?꾨줈?뚯씪 諛곗튂 濡쒕뵫: ?쇰━ ?ъ씠?????뚯씪 踰덊샇 ?먮룞 蹂????濡쒕뵫."""
+    mincapacity = toyo_min_cap(raw_file_path, mincapacity, inirate)
+    # ?쇰━ ?ъ씠?????뚯씪 踰덊샇 留ㅽ븨 ?먮룞 ?앹꽦
+    cycle_map, _ = toyo_build_cycle_map(raw_file_path, mincapacity, inirate)
+    results = {}
+    for (start, end) in step_ranges:
+        # ?쇰━ ?ъ씠??踰덊샇 ???먮낯 ?뚯씪 踰덊샇 踰붿쐞 蹂??+        if cycle_map:
+            file_start = cycle_map.get(start, (start, start))[0]
+            file_end = cycle_map.get(end, (end, end))[1]
+        else:
+            file_start, file_end = start, end
+        results[(start, end)] = toyo_Profile_continue_data(raw_file_path, file_start, file_end, mincapacity, inirate)
+    return results
+
+
+def pne_continue_Profile_batch(raw_file_path, step_ranges, mincapacity, inirate, CDstate):
+    """PNE Continue ?꾨줈?뚯씪 諛곗튂 濡쒕뵫: min_cap 1???곗젙 ??step_range 諛섎났."""
+    mincapacity = pne_min_cap(raw_file_path, mincapacity, inirate)
+    results = {}
+    for (start, end) in step_ranges:
+        results[(start, end)] = pne_Profile_continue_data(raw_file_path, start, end, mincapacity, inirate, CDstate)
+    return results
+
+
 # Toyo Step charge Profile data 泥섎━
 def toyo_step_Profile_data(raw_file_path, inicycle, mincapacity, cutoff, inirate):
     df = pd.DataFrame()
@@ -989,51 +1409,100 @@ def toyo_dchg_Profile_data(raw_file_path, inicycle, mincapacity, cutoff, inirate
 # Toyo Step charge Profile data 泥섎━
 def toyo_Profile_continue_data(raw_file_path, inicycle, endcycle, mincapacity, inirate):
     df = pd.DataFrame()
+    CycfileSOC = pd.DataFrame()
     # ?⑸웾 ?곗젙
     tempmincap = toyo_min_cap(raw_file_path, mincapacity, inirate)
     mincapacity = tempmincap
     # data 湲곕낯 泥섎━
     if os.path.isfile(raw_file_path + "\\%06d" % inicycle):
         tempdata = toyo_Profile_import(raw_file_path, inicycle)
-        stepcyc = inicycle
-        lasttime = 0
-        if int(tempdata.dataraw["Condition"].max()) < 2:
-            df.stepchg = tempdata.dataraw
-            lasttime = df.stepchg["PassTime[Sec]"].max()
-            maxcon = 1
-            while maxcon == 1:
-                stepcyc = stepcyc + 1
+        df.stepchg = tempdata.dataraw
+        file_boundaries = [(0, inicycle)]
+        if endcycle > inicycle:
+            # 紐낆떆??踰붿쐞: inicycle+1 ~ endcycle源뚯? raw ?곗씠???곌껐
+            for stepcyc in range(inicycle + 1, endcycle + 1):
+                if not os.path.isfile(raw_file_path + "\\%06d" % stepcyc):
+                    break
                 tempdata = toyo_Profile_import(raw_file_path, stepcyc)
-                maxcon = int(tempdata.dataraw["Condition"].max())
-                tempdata.dataraw["PassTime[Sec]"] = tempdata.dataraw["PassTime[Sec]"] + lasttime
-                df.stepchg = pd.concat([df.stepchg, tempdata.dataraw])
-                lasttime = df.stepchg["PassTime[Sec]"].max()
+                if hasattr(tempdata, 'dataraw') and not tempdata.dataraw.empty:
+                    file_boundaries.append((len(df.stepchg), stepcyc))
+                    df.stepchg = pd.concat([df.stepchg, tempdata.dataraw])
         else:
-            df.stepchg = tempdata.dataraw
+            # ?⑥씪 ?ъ씠?? Condition < 2?대㈃ ?꾩냽 ?뚯씪源뚯? ?뺤옣 (湲곗〈 濡쒖쭅)
+            if int(tempdata.dataraw["Condition"].max()) < 2:
+                stepcyc = inicycle
+                maxcon = 1
+                while maxcon == 1:
+                    stepcyc = stepcyc + 1
+                    tempdata = toyo_Profile_import(raw_file_path, stepcyc)
+                    maxcon = int(tempdata.dataraw["Condition"].max())
+                    file_boundaries.append((len(df.stepchg), stepcyc))
+                    df.stepchg = pd.concat([df.stepchg, tempdata.dataraw])
         if not df.stepchg.empty:
-            df.stepchg["Cap[mAh]"] = 0
-            # 異⑹쟾 ?⑸웾 ?곗젙
-            df.stepchg = df.stepchg.reset_index()
-            # for i in range(len(df.stepchg) - 1):
-            #     df.stepchg.loc[i + 1, "Cap[mAh]"] = (df.stepchg.loc[i + 1, "PassTime[Sec]"] - df.stepchg.loc[i, "PassTime[Sec]"])/3600 * (df.stepchg.loc[i + 1, "Current[mA]"]) + df.stepchg.loc[i, "Cap[mAh]"]
+            # PassTime 由ъ뀑 蹂댁젙: 援ш컙 ?꾪솚 ???뚯닔 diff瑜?0?쇰줈 ?대━?????꾩쟻??+            df.stepchg = df.stepchg.reset_index(drop=True)
+            time_diffs = df.stepchg["PassTime[Sec]"].diff().clip(lower=0).fillna(0)
+            df.stepchg["PassTime[Sec]"] = time_diffs.cumsum()
+            # SOC ?곗젙: 諛⑹쟾(Condition==2) ???꾨쪟 遺??諛섏쟾
+            signed_current = df.stepchg["Current[mA]"].copy()
+            signed_current.loc[df.stepchg["Condition"] == 2] *= -1
+            df.stepchg["Cap[mAh]"] = 0.0
             if len(df.stepchg) > 1:
-                # PassTime[Sec]??李⑥씠 怨꾩궛 (泥??됱? NaN)
-                time_diffs = df.stepchg["PassTime[Sec]"].diff().iloc[1:]
-                # (?쒓컙 李⑥씠 / 3600) * Current[mA] 怨꾩궛
-                increments = (time_diffs / 3600) * df.stepchg["Current[mA]"].iloc[1:]
-                # ?꾩쟻 ??怨꾩궛
-                cum_increments = increments.cumsum()
-                # 泥??됱쓽 Cap[mAh] 媛?媛?몄삤湲?-                initial_cap = df.stepchg["Cap[mAh]"].iloc[0]
-                # ??踰덉㎏ ?됰???Cap[mAh] ?낅뜲?댄듃
-                df.stepchg.iloc[1:, df.stepchg.columns.get_loc("Cap[mAh]")] = initial_cap + cum_increments.values
-            # 異⑹쟾 ?⑥쐞 蹂??-            df.stepchg["PassTime[Sec]"] = df.stepchg["PassTime[Sec]"]/60
-            df.stepchg["Current[mA]"] = df.stepchg["Current[mA]"]/mincapacity
-            df.stepchg["Cap[mAh]"] = df.stepchg["Cap[mAh]"]/mincapacity
-            df.stepchg = df.stepchg[["PassTime[Sec]", "Cap[mAh]", "Voltage[V]", "Current[mA]", "Temp1[Deg]"]]
-            df.stepchg.columns = ["TimeMin", "SOC", "Vol", "Crate", "Temp"]
-    return [mincapacity, df]
+                increments = (time_diffs / 3600) * signed_current
+                df.stepchg["Cap[mAh]"] = increments.cumsum().fillna(0.0)
+            # OCV/CCV: ?꾨줈?뚯씪 ?곗씠?곗쓽 Condition ?꾪솚?먯뿉??吏곸젒 異붿텧
+            # OCV = rest 醫낅즺 ?꾩븬 (rest?뭖harge/discharge ?꾪솚, rest ??
+            # CCV = 遺??醫낅즺 ?꾩븬 (charge/discharge?뭨est ?꾪솚, rest ??
+            cond = df.stepchg["Condition"]
+            next_cond = cond.shift(-1)
+            df.stepchg["OCV"] = float('nan')
+            df.stepchg["CCV"] = float('nan')
+            # rest(0)?뭠oad(1,2): OCV = rest 留덉?留????꾩븬
+            ocv_mask = (cond == 0) & (next_cond.isin([1, 2]))
+            df.stepchg.loc[ocv_mask, "OCV"] = df.stepchg.loc[ocv_mask, "Voltage[V]"]
+            # load(1,2)?뭨est(0): CCV = load 留덉?留????꾩븬
+            ccv_mask = (cond.isin([1, 2])) & (next_cond == 0)
+            df.stepchg.loc[ccv_mask, "CCV"] = df.stepchg.loc[ccv_mask, "Voltage[V]"]
+            # 泥??됱씠 charge/discharge??寃쎌슦: ?쒖옉 ?꾩븬??OCV濡?+            if len(cond) > 0 and cond.iloc[0] in [1, 2]:
+                df.stepchg.loc[df.stepchg.index[0], "OCV"] = df.stepchg.iloc[0]["Voltage[V]"]
+            # CycfileSOC: capacity.log AccCap + ?꾨줈?뚯씪 OCV/CCV
+            cycdata = toyo_cycle_import(raw_file_path)
+            has_caplog = hasattr(cycdata, "dataraw") and not cycdata.dataraw.empty
+            if has_caplog:
+                cap_log = cycdata.dataraw
+                relevant = cap_log[(cap_log["TotlCycle"] >= inicycle) & (cap_log["TotlCycle"] <= endcycle)]
+                chg_dchg = relevant[relevant["Condition"].isin([1, 2])].copy()
+                if not chg_dchg.empty:
+                    chg_dchg = chg_dchg.reset_index(drop=True)
+                    chg_cap = chg_dchg["Cap[mAh]"].where(chg_dchg["Condition"] == 1, 0.0)
+                    dchg_cap = chg_dchg["Cap[mAh]"].where(chg_dchg["Condition"] == 2, 0.0)
+                    chg_dchg["AccCap"] = chg_cap.cumsum() - dchg_cap.cumsum()
+                    if len(chg_dchg) > 0:
+                        chg_dchg["AccCap"] = chg_dchg["AccCap"] - chg_dchg["AccCap"].iloc[0]
+                    Cap = (chg_dchg["AccCap"].abs() / mincapacity).tolist()
+                    # OCV/CCV 紐⑸줉: ?꾨줈?뚯씪 ?꾪솚?먯뿉??異붿텧
+                    ocv_list = df.stepchg.loc[ocv_mask, "Voltage[V]"].tolist()
+                    if len(cond) > 0 and cond.iloc[0] in [1, 2]:
+                        ocv_list.insert(0, df.stepchg.iloc[0]["Voltage[V]"])
+                    ccv_list = df.stepchg.loc[ccv_mask, "Voltage[V]"].tolist()
+                    min_length = min(len(Cap), len(ocv_list), len(ccv_list))
+                    if min_length > 0:
+                        CycfileSOC = pd.DataFrame({
+                            "AccCap": Cap[:min_length],
+                            "OCV": ocv_list[:min_length],
+                            "CCV": ccv_list[:min_length]
+                        })
+            # ?⑥쐞 蹂??(PNE ?명솚 異쒕젰)
+            df.stepchg["TimeSec"] = df.stepchg["PassTime[Sec]"].round(1)
+            df.stepchg["Curr"] = (signed_current / 1000.0).round(4)
+            df.stepchg["PassTime[Sec]"] = df.stepchg["PassTime[Sec]"] / 60
+            df.stepchg["Current[mA]"] = signed_current / mincapacity
+            df.stepchg["Cap[mAh]"] = df.stepchg["Cap[mAh]"] / mincapacity
+            df.stepchg = df.stepchg[["TimeSec", "PassTime[Sec]", "Cap[mAh]", "Voltage[V]",
+                                     "Curr", "Current[mA]", "Temp1[Deg]", "OCV", "CCV"]]
+            df.stepchg.columns = ["TimeSec", "TimeMin", "SOC", "Vol", "Curr", "Crate", "Temp", "OCV", "CCV"]
+    return [mincapacity, df, CycfileSOC]
 
 # PNE Profile data 湲곕낯 input 泥섎━
 def pne_data(raw_file_path, inicycle):
@@ -1058,36 +1527,60 @@ def pne_data(raw_file_path, inicycle):
                         df.Profileraw = df.Profilerawtemp 
     return df
 
-# PNE?먯꽌 ?먰븯???ъ씠?댁씠 ?ㅼ뼱?덈뒗 ?뚯씪紐낆쓣 李얜뒗 肄붾뱶
+# PNE ?몃뜳???뚯씪 罹먯떛 (?숈씪 寃쎈줈 諛섎났 I/O ?쒓굅)
+@lru_cache(maxsize=32)
+def _load_pne_index_files(rawdir):
+    """SaveEndData? savingFileIndex_start瑜?1?뚮쭔 ?쎌뼱 罹먯떛"""
+    save_end = None
+    file_index = None
+    subfile = [f for f in os.listdir(rawdir) if f.endswith(".csv")]
+    for fname in subfile:
+        if "SaveEndData" in fname:
+            save_end = pd.read_csv(
+                rawdir + fname, sep=",", skiprows=0, engine="c",
+                header=None, encoding="cp949", on_bad_lines='skip'
+            )
+        if fname == "savingFileIndex_start.csv":
+            df2 = pd.read_csv(
+                rawdir + fname, sep=r"\s+", skiprows=0, engine="c",
+                header=None, encoding="cp949", on_bad_lines='skip'
+            )
+            file_index = df2[3].str.replace(',', '').astype(int).tolist()
+    return save_end, file_index
+
+def pne_search_cycle_cache_clear():
+    """?곗씠??寃쎈줈 蹂寃???罹먯떆 珥덇린??""
+    _load_pne_index_files.cache_clear()
+
+# PNE?먯꽌 ?먰븯???ъ씠?댁씠 ?ㅼ뼱?덈뒗 ?뚯씪紐낆쓣 李얜뒗 肄붾뱶 (罹먯떆 理쒖쟻??
 def pne_search_cycle(rawdir, start, end):
-    # Profile???ъ슜???뚯씪 ?좎젙
-    if os.path.isdir(rawdir):
-        subfile = [f for f in os.listdir(rawdir) if f.endswith(".csv")]
-        for files in subfile:
-            # SaveEndData媛 ?덈뒗 ?뚯씪 ?뺤씤
-            if "SaveEndData" in files:
-                df = pd.read_csv(rawdir + files, sep=",", skiprows=0, engine="c", header=None, encoding="cp949",
-                                 on_bad_lines='skip')
-                if start != 1:
-                    index_min = df.loc[(df.loc[:,27] == (start - 1)), 0].tolist()
-                else:
-                    index_min = [0]
-                index_max = df.loc[(df.loc[:,27] == end), 0].tolist()
-                if not index_max:
-                    index_max = df.loc[(df.loc[:,27] == df.loc[:,27].max()), 0].tolist()
-                df2 = pd.read_csv(rawdir + "savingFileIndex_start.csv", sep=r"\s+", skiprows=0, engine="c",
-                                  header=None, encoding="cp949", on_bad_lines='skip') #pandas>=3.0.0 / 湲곗〈 2.2.1
-                df2 = df2.loc[:,3].tolist()
-                index2 = []
-                for element in df2:
-                    new_element = int(element.replace(',', ''))
-                    index2.append(new_element)
-                if len(index_min) != 0:
-                    file_start = binary_search(index2, index_min[-1] + 1) - 1
-                    file_end = binary_search(index2, index_max[-1]) - 1
-                else:
-                    file_start = -1
-                    file_end = -1
+    if not os.path.isdir(rawdir):
+        return [-1, -1]
+    
+    save_end, file_index = _load_pne_index_files(rawdir)
+    
+    if save_end is None or file_index is None:
+        return [-1, -1]
+    
+    # start???대떦?섎뒗 ?몃뜳??寃??+    if start != 1:
+        index_min = save_end.loc[save_end[27] == (start - 1), 0].tolist()
+    else:
+        index_min = [0]
+    
+    # end???대떦?섎뒗 ?몃뜳??寃??+    index_max = save_end.loc[save_end[27] == end, 0].tolist()
+    if not index_max:
+        index_max = save_end.loc[save_end[27] == save_end[27].max(), 0].tolist()
+    
+    # ?뚯씪 ?꾩튂 ?곗젙
+    if len(index_min) != 0:
+        file_start = binary_search(file_index, index_min[-1] + 1) - 1
+        file_end = binary_search(file_index, index_max[-1]) - 1
+    else:
+        file_start = -1
+        file_end = -1
+    
     return [file_start, file_end]
 
 # ?곗냽???곗씠?곗쓽 Profile??李얠븘???뺤씤
@@ -1200,9 +1693,13 @@ def pne_simul_cycle_data(raw_file_path, min_capacity, ini_crate):
         df_all = pd.DataFrame({"Temp": avg_temp.iloc[:,0], "Curr": min_crate.iloc[:,0], "Dchg": max_cap.iloc[:, 0],
                                "max_vol": max_vol.iloc[:, 0], "min_vol": min_vol.iloc[:, 0]})
         df_all["Temp"] = df_all["Temp"]/1000
-        df_all["Curr"] = - 1 * df_all["Curr"]/mincapacity/1000
+        if is_micro_unit(raw_file_path):
+            df_all["Curr"] = - 1 * df_all["Curr"]/mincapacity/1000000
+            df_all["Dchg"] = df_all["Dchg"]/mincapacity/1000000
+        else:
+            df_all["Curr"] = - 1 * df_all["Curr"]/mincapacity/1000
+            df_all["Dchg"] = df_all["Dchg"]/mincapacity/1000
         df_all["max_vol"] = df_all["max_vol"]/1000
-        df_all["Dchg"] = df_all["Dchg"]/mincapacity/1000
         df_all["min_vol"] = df_all["min_vol"]/1000
         df05 = df_all.query('0.490 < Curr < 0.510')
         j = 0
@@ -1310,7 +1807,7 @@ def pne_cycle_data(raw_file_path, mincapacity, ini_crate, chkir, chkir2, mkdcir)
                         Cycleraw.columns = ["TotlCycle", "Condition", "chgCap", "DchgCap", "Ocv", "imp", "volmax",
                                             "DchgEngD", "steptime", "Curr", "Temp", "AvgV", "EndState"]
                         # PNE 湲곕낯 DCIR (?곗냽 湲곗? 10s pulse, 10s ?대궡 ?쒓컙??寃쎌슦 ?⑥닚 pulse 湲곗? ?앸굹???쒓컙 湲곗?)
-                        if ('PNE21' in raw_file_path) or ('PNE22' in raw_file_path):
+                        if is_micro_unit(raw_file_path):
                             Cycleraw.DchgCap = Cycleraw.DchgCap/1000
                             Cycleraw.chgCap = Cycleraw.chgCap/1000
                             Cycleraw.Curr = Cycleraw.Curr/1000
@@ -1480,7 +1977,7 @@ def pne_step_Profile_data(raw_file_path, inicycle, mincapacity, cutoff, inirate)
             # 異⑹쟾 ?⑥쐞 蹂??             profile_raw.Profileraw["PassTime[Sec]"] = profile_raw.Profileraw["PassTime[Sec]"]/100/60
             profile_raw.Profileraw["Voltage[V]"] = profile_raw.Profileraw["Voltage[V]"]/1000000
-            if ('PNE21' in raw_file_path) or ('PNE22' in raw_file_path):
+            if is_micro_unit(raw_file_path):
                 profile_raw.Profileraw["Current[mA]"] = profile_raw.Profileraw["Current[mA]"]/mincapacity/1000000
                 profile_raw.Profileraw["Chgcap"] = profile_raw.Profileraw["Chgcap"]/mincapacity/1000000
             else:
@@ -1525,7 +2022,7 @@ def pne_rate_Profile_data(raw_file_path, inicycle, mincapacity, cutoff, inirate)
             # 異⑹쟾 ?⑥쐞 蹂??             Profileraw["PassTime[Sec]"] = Profileraw["PassTime[Sec]"]/100/60
             Profileraw["Voltage[V]"] = Profileraw["Voltage[V]"]/1000000
-            if ('PNE21' in raw_file_path) or ('PNE22' in raw_file_path):
+            if is_micro_unit(raw_file_path):
                 Profileraw["Current[mA]"] = Profileraw["Current[mA]"]/mincapacity/1000000
                 Profileraw["Chgcap"] = Profileraw["Chgcap"]/mincapacity/1000000
             else:
@@ -1556,7 +2053,7 @@ def pne_chg_Profile_data(raw_file_path, inicycle, mincapacity, cutoff, inirate,
             # 異⑹쟾 ?⑥쐞 蹂??             df.Profileraw["PassTime[Sec]"] = df.Profileraw["PassTime[Sec]"]/100/60
             df.Profileraw["Voltage[V]"] = df.Profileraw["Voltage[V]"]/1000000
-            if ('PNE21' in raw_file_path) or ('PNE22' in raw_file_path):
+            if is_micro_unit(raw_file_path):
                 df.Profileraw["Current[mA]"] = df.Profileraw["Current[mA]"]/mincapacity/1000000
                 df.Profileraw["Chgcap"] = df.Profileraw["Chgcap"]/mincapacity/1000000
             else:
@@ -1613,7 +2110,7 @@ def pne_dchg_Profile_data(raw_file_path, inicycle, mincapacity, cutoff, inirate,
             # 異⑹쟾 ?⑥쐞 蹂??             Profileraw["PassTime[Sec]"] = Profileraw["PassTime[Sec]"]/100/60
             Profileraw["Voltage[V]"] = Profileraw["Voltage[V]"]/1000000
-            if ('PNE21' in raw_file_path) or ('PNE22' in raw_file_path):
+            if is_micro_unit(raw_file_path):
                 Profileraw["Current[mA]"] = Profileraw["Current[mA]"]/mincapacity/1000000 * (-1)
                 Profileraw["Dchgcap"] = Profileraw["Dchgcap"]/mincapacity/1000000
             else:
@@ -1664,7 +2161,7 @@ def pne_continue_profile_scale_change(raw_file_path, df, mincapacity):
     df["TotTime[Sec]"] = (df["TotTime[Sec]"] - df.loc[0, "TotTime[Sec]"])
     df["TotTime[Min]"] = (df["TotTime[Sec]"]/60)
     df["Voltage[V]"] = df["Voltage[V]"]/1000000
-    if ('PNE21' in raw_file_path) or ('PNE22' in raw_file_path):
+    if is_micro_unit(raw_file_path):
         df["Crate"] = (df["Current[mA]"]/mincapacity/1000000).round(2)
         df["Current[mA]"] = (df["Current[mA]"]/1000000000)
         df["ChgCap"] = df["ChgCap"]/mincapacity/1000000
@@ -1690,6 +2187,7 @@ def pne_Profile_continue_data(raw_file_path, inicycle, endcycle, mincapacity, in
     31: 32: 33:date 34:time 35: 36: 37: 38: 39: 40: 
     41: 42: 43: 44:?꾩쟻step(Loop, ?꾨즺 ?쒖쇅) 45:voltage max 46: '''
     df = pd.DataFrame()
+    CycfileSOC = pd.DataFrame()
     if (raw_file_path[-4:-1]) != "ter":
         if CDstate != "":
             # PNE 梨꾨꼸, ?⑸웾 ?곗젙
@@ -1727,8 +2225,9 @@ def pne_Profile_continue_data(raw_file_path, inicycle, endcycle, mincapacity, in
                 pnecyc.Cycrawtemp = pnecyc.Cycrawtemp.loc[(pnecyc.Cycrawtemp[27] >= inicycle) & (pnecyc.Cycrawtemp[27] <= endcycle)]
                 CycfileCap =  pnecyc.Cycrawtemp.loc[((pnecyc.Cycrawtemp[2] == 1) | (pnecyc.Cycrawtemp[2] == 2)), [0, 8, 10, 11]]
                 CycfileCap["AccCap"] = (CycfileCap[10].cumsum() - CycfileCap[11].cumsum())
-                CycfileCap = CycfileCap.reset_index()
-                CycfileCap["AccCap"] = (CycfileCap["AccCap"] - CycfileCap.loc[0,"AccCap"])/1000
+                CycfileCap = CycfileCap.reset_index(drop=True)
+                if not CycfileCap.empty:
+                    CycfileCap["AccCap"] = (CycfileCap["AccCap"] - CycfileCap["AccCap"].iloc[0])/1000
                 CycfileOCV =  pnecyc.Cycrawtemp.loc[(pnecyc.Cycrawtemp[2] == 3), [0, 8]]
                 CycfileCCV =  pnecyc.Cycrawtemp.loc[((pnecyc.Cycrawtemp[2] == 1) | (pnecyc.Cycrawtemp[2] == 2)), [0, 8]]
                 Cycfileraw = pd.merge(CycfileOCV, CycfileCCV, on = 0, how='outer')
@@ -1822,7 +2321,7 @@ def pne_dcir_Profile_data(raw_file_path, inicycle, endcycle, mincapacity, inirat
             dcir_base.reset_index(drop=True, inplace=True)
             dcir_step = list(set(dcir_base["step"].tolist()))
             # ?⑤퀎 pulse C-rate ?뺤씤
-            if ('PNE21' in raw_file_path) or ('PNE22' in raw_file_path):
+            if is_micro_unit(raw_file_path):
                 dcir_crate = [((dcir_base.loc[i, "Current[mA]"] / 1000000)/mincapacity).round(2) for i in range(0,4)]
             else:
                 dcir_crate = [((dcir_base.loc[i, "Current[mA]"] / 1000)/mincapacity).round(2) for i in range(0,4)]
@@ -1853,9 +2352,10 @@ def pne_dcir_Profile_data(raw_file_path, inicycle, endcycle, mincapacity, inirat
                 ]
                 real_ocv = real_ocv.reset_index()
                 CycfileCap["AccCap"] = (CycfileCap.loc[:,10].cumsum() - CycfileCap[11].cumsum())
-                CycfileCap = CycfileCap.reset_index()
-                CycfileCap["AccCap"] = abs((CycfileCap.loc[:,"AccCap"] - CycfileCap.loc[0,"AccCap"])/1000)
-                if ('PNE21' in raw_file_path) or ('PNE22' in raw_file_path):
+                CycfileCap = CycfileCap.reset_index(drop=True)
+                if not CycfileCap.empty:
+                    CycfileCap["AccCap"] = abs((CycfileCap["AccCap"] - CycfileCap["AccCap"].iloc[0])/1000)
+                if is_micro_unit(raw_file_path):
                     CycfileCap["AccCap"] = CycfileCap["AccCap"]/1000
                 if dcir_crate[-2] < 0:
                     CycfileCap["SOC"] = (1 - CycfileCap["AccCap"]/mincapacity) * 100
@@ -2472,8 +2972,8 @@ class Ui_sitool(object):
         self.horizontalLayout_108 = QtWidgets.QHBoxLayout()
         self.horizontalLayout_108.setObjectName("horizontalLayout_108")
         self.chk_cyclepath = QtWidgets.QCheckBox(parent=self.CycTab)
-        self.chk_cyclepath.setMinimumSize(QtCore.QSize(240, 30))
-        self.chk_cyclepath.setMaximumSize(QtCore.QSize(100, 30))
+        self.chk_cyclepath.setMinimumSize(QtCore.QSize(120, 30))
+        self.chk_cyclepath.setMaximumSize(QtCore.QSize(240, 30))
         font = QtGui.QFont()
         font.setFamily("留묒? 怨좊뵓")
         font.setPointSize(9)
@@ -2484,8 +2984,8 @@ class Ui_sitool(object):
         self.chk_cyclepath.setObjectName("chk_cyclepath")
         self.horizontalLayout_108.addWidget(self.chk_cyclepath)
         self.chk_ectpath = QtWidgets.QCheckBox(parent=self.CycTab)
-        self.chk_ectpath.setMinimumSize(QtCore.QSize(240, 30))
-        self.chk_ectpath.setMaximumSize(QtCore.QSize(100, 30))
+        self.chk_ectpath.setMinimumSize(QtCore.QSize(120, 30))
+        self.chk_ectpath.setMaximumSize(QtCore.QSize(240, 30))
         font = QtGui.QFont()
         font.setFamily("留묒? 怨좊뵓")
         font.setPointSize(9)
@@ -2495,6 +2995,7 @@ class Ui_sitool(object):
         self.chk_ectpath.setChecked(False)
         self.chk_ectpath.setObjectName("chk_ectpath")
         self.horizontalLayout_108.addWidget(self.chk_ectpath)
+        self.horizontalLayout_108.addStretch(1)
         self.verticalLayout_6.addLayout(self.horizontalLayout_108)
         self.horizontalLayout_119 = QtWidgets.QHBoxLayout()
         self.horizontalLayout_119.setObjectName("horizontalLayout_119")
@@ -2870,6 +3371,17 @@ class Ui_sitool(object):
         self.CellProfile.setFont(font)
         self.CellProfile.setObjectName("CellProfile")
         self.horizontalLayout_15.addWidget(self.CellProfile)
+        self.AllProfile = QtWidgets.QRadioButton(parent=self.tab_6)
+        self.AllProfile.setMinimumSize(QtCore.QSize(0, 30))
+        self.AllProfile.setMaximumSize(QtCore.QSize(300, 30))
+        font = QtGui.QFont()
+        font.setFamily("留묒? 怨좊뵓")
+        font.setPointSize(9)
+        font.setBold(False)
+        font.setWeight(50)
+        self.AllProfile.setFont(font)
+        self.AllProfile.setObjectName("AllProfile")
+        self.horizontalLayout_15.addWidget(self.AllProfile)
         self.chk_dqdv = QtWidgets.QCheckBox(parent=self.tab_6)
         self.chk_dqdv.setMinimumSize(QtCore.QSize(120, 30))
         self.chk_dqdv.setMaximumSize(QtCore.QSize(120, 30))
@@ -2882,6 +3394,18 @@ class Ui_sitool(object):
         self.chk_dqdv.setChecked(False)
         self.chk_dqdv.setObjectName("chk_dqdv")
         self.horizontalLayout_15.addWidget(self.chk_dqdv)
+        self.chk_coincell_cyc = QtWidgets.QCheckBox(parent=self.tab_6)
+        self.chk_coincell_cyc.setMinimumSize(QtCore.QSize(80, 30))
+        self.chk_coincell_cyc.setMaximumSize(QtCore.QSize(100, 30))
+        font = QtGui.QFont()
+        font.setFamily("留묒? 怨좊뵓")
+        font.setPointSize(9)
+        font.setBold(False)
+        font.setWeight(50)
+        self.chk_coincell_cyc.setFont(font)
+        self.chk_coincell_cyc.setChecked(False)
+        self.chk_coincell_cyc.setObjectName("chk_coincell_cyc")
+        self.horizontalLayout_15.addWidget(self.chk_coincell_cyc)
         self.verticalLayout_4.addLayout(self.horizontalLayout_15)
         self.horizontalLayout_111 = QtWidgets.QHBoxLayout()
         self.horizontalLayout_111.setObjectName("horizontalLayout_111")
@@ -3157,652 +3681,368 @@ class Ui_sitool(object):
         self.tabWidget.addTab(self.CycTab, "")
         self.tab_2 = QtWidgets.QWidget()
         self.tab_2.setObjectName("tab_2")
+        # ???꾩껜 怨듯넻 ?고듃 ?ㅼ젙
+        _ptn_font = QtGui.QFont("留묒? 怨좊뵓", 9)
+        self.tab_2.setFont(_ptn_font)
         self.horizontalLayout_135 = QtWidgets.QHBoxLayout(self.tab_2)
+        self.horizontalLayout_135.setContentsMargins(6, 6, 6, 6)
         self.horizontalLayout_135.setObjectName("horizontalLayout_135")
         self.horizontalLayout_134 = QtWidgets.QHBoxLayout()
         self.horizontalLayout_134.setObjectName("horizontalLayout_134")
         self.verticalLayout_9 = QtWidgets.QVBoxLayout()
+        self.verticalLayout_9.setSpacing(4)
         self.verticalLayout_9.setObjectName("verticalLayout_9")
+        self.verticalLayout_9.setAlignment(QtCore.Qt.AlignmentFlag.AlignLeft | QtCore.Qt.AlignmentFlag.AlignTop)
         self.verticalLayout_8 = QtWidgets.QVBoxLayout()
+        self.verticalLayout_8.setSpacing(2)
         self.verticalLayout_8.setObjectName("verticalLayout_8")
         self.horizontalLayout_129 = QtWidgets.QHBoxLayout()
         self.horizontalLayout_129.setObjectName("horizontalLayout_129")
         self.label_10 = QtWidgets.QLabel(parent=self.tab_2)
-        self.label_10.setMinimumSize(QtCore.QSize(369, 30))
-        self.label_10.setMaximumSize(QtCore.QSize(369, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.label_10.setFont(font)
+        self.label_10.setFixedHeight(28)
         self.label_10.setObjectName("label_10")
         self.horizontalLayout_129.addWidget(self.label_10)
-        spacerItem1 = QtWidgets.QSpacerItem(201, 30, QtWidgets.QSizePolicy.Policy.Expanding, QtWidgets.QSizePolicy.Policy.Minimum)
+        spacerItem1 = QtWidgets.QSpacerItem(40, 28, QtWidgets.QSizePolicy.Policy.Expanding, QtWidgets.QSizePolicy.Policy.Minimum)
         self.horizontalLayout_129.addItem(spacerItem1)
         self.chk_coincell = QtWidgets.QCheckBox(parent=self.tab_2)
-        self.chk_coincell.setMinimumSize(QtCore.QSize(70, 18))
-        self.chk_coincell.setMaximumSize(QtCore.QSize(70, 18))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        self.chk_coincell.setFont(font)
+        self.chk_coincell.setFixedSize(QtCore.QSize(80, 24))
         self.chk_coincell.setObjectName("chk_coincell")
         self.horizontalLayout_129.addWidget(self.chk_coincell)
         self.verticalLayout_8.addLayout(self.horizontalLayout_129)
         self.horizontalLayout_14 = QtWidgets.QHBoxLayout()
         self.horizontalLayout_14.setObjectName("horizontalLayout_14")
         self.cycxlabel_7 = QtWidgets.QLabel(parent=self.tab_2)
-        self.cycxlabel_7.setMinimumSize(QtCore.QSize(526, 30))
-        self.cycxlabel_7.setMaximumSize(QtCore.QSize(526, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_7.setFont(font)
+        self.cycxlabel_7.setFixedHeight(28)
         self.cycxlabel_7.setObjectName("cycxlabel_7")
         self.horizontalLayout_14.addWidget(self.cycxlabel_7)
+        _ptn_btn_font = QtGui.QFont("留묒? 怨좊뵓", 9)
+        _ptn_btn_font.setBold(True)
         self.ptn_load = QtWidgets.QPushButton(parent=self.tab_2)
-        self.ptn_load.setMinimumSize(QtCore.QSize(120, 50))
-        self.ptn_load.setMaximumSize(QtCore.QSize(120, 50))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(True)
-        font.setWeight(75)
-        self.ptn_load.setFont(font)
+        self.ptn_load.setFixedSize(QtCore.QSize(120, 40))
+        self.ptn_load.setFont(_ptn_btn_font)
         self.ptn_load.setObjectName("ptn_load")
         self.horizontalLayout_14.addWidget(self.ptn_load)
         self.verticalLayout_8.addLayout(self.horizontalLayout_14)
         self.ptn_ori_path = QtWidgets.QLineEdit(parent=self.tab_2)
-        self.ptn_ori_path.setMinimumSize(QtCore.QSize(640, 30))
-        self.ptn_ori_path.setMaximumSize(QtCore.QSize(640, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_ori_path.setFont(font)
+        self.ptn_ori_path.setMinimumWidth(640)
+        self.ptn_ori_path.setFixedHeight(28)
         self.ptn_ori_path.setObjectName("ptn_ori_path")
         self.verticalLayout_8.addWidget(self.ptn_ori_path)
         self.line_16 = QtWidgets.QFrame(parent=self.tab_2)
-        self.line_16.setMinimumSize(QtCore.QSize(654, 3))
-        self.line_16.setMaximumSize(QtCore.QSize(654, 3))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        self.line_16.setFont(font)
+        self.line_16.setFixedHeight(3)
         self.line_16.setFrameShape(QtWidgets.QFrame.Shape.HLine)
         self.line_16.setFrameShadow(QtWidgets.QFrame.Shadow.Sunken)
         self.line_16.setObjectName("line_16")
         self.verticalLayout_8.addWidget(self.line_16)
         self.verticalLayout_9.addLayout(self.verticalLayout_8)
-        self.horizontalLayout_133 = QtWidgets.QHBoxLayout()
-        self.horizontalLayout_133.setObjectName("horizontalLayout_133")
-        self.verticalLayout_69 = QtWidgets.QVBoxLayout()
-        self.verticalLayout_69.setObjectName("verticalLayout_69")
+        _gb_grid = QtWidgets.QGridLayout()
+        _gb_grid.setHorizontalSpacing(8)
+        _gb_grid.setVerticalSpacing(6)
+        # 怨듯넻 GroupBox ?ш린/?ㅽ????곸닔
+        _GB_W, _GB_H = 140, 280
+        _LBL_SZ = QtCore.QSize(115, 20)
+        _INP_SZ = QtCore.QSize(115, 28)
+        _BTN_SZ = QtCore.QSize(115, 40)
+        _input_hints = QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly
+        _align_c = QtCore.Qt.AlignmentFlag.AlignCenter
         self.groupBox_8 = QtWidgets.QGroupBox(parent=self.tab_2)
-        self.groupBox_8.setMinimumSize(QtCore.QSize(140, 300))
-        self.groupBox_8.setMaximumSize(QtCore.QSize(140, 300))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.groupBox_8.setFont(font)
+        self.groupBox_8.setFixedSize(QtCore.QSize(_GB_W, _GB_H))
+        self.groupBox_8.setAlignment(_align_c)
         self.groupBox_8.setObjectName("groupBox_8")
         self.gridLayout = QtWidgets.QGridLayout(self.groupBox_8)
+        self.gridLayout.setContentsMargins(6, 12, 6, 6)
         self.gridLayout.setObjectName("gridLayout")
         self.verticalLayout_34 = QtWidgets.QVBoxLayout()
+        self.verticalLayout_34.setSpacing(4)
         self.verticalLayout_34.setObjectName("verticalLayout_34")
         self.cycxlabel_5 = QtWidgets.QLabel(parent=self.groupBox_8)
-        self.cycxlabel_5.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_5.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_5.setFont(font)
+        self.cycxlabel_5.setFixedSize(_LBL_SZ)
         self.cycxlabel_5.setObjectName("cycxlabel_5")
+        self.cycxlabel_5.setAlignment(_align_c)
         self.verticalLayout_34.addWidget(self.cycxlabel_5)
         self.ptn_crate = QtWidgets.QLineEdit(parent=self.groupBox_8)
-        self.ptn_crate.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_crate.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_crate.setFont(font)
-        self.ptn_crate.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_crate.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_crate.setFixedSize(_INP_SZ)
+        self.ptn_crate.setInputMethodHints(_input_hints)
+        self.ptn_crate.setAlignment(_align_c)
         self.ptn_crate.setObjectName("ptn_crate")
         self.verticalLayout_34.addWidget(self.ptn_crate)
         self.cycxlabel_6 = QtWidgets.QLabel(parent=self.groupBox_8)
-        self.cycxlabel_6.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_6.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_6.setFont(font)
+        self.cycxlabel_6.setFixedSize(_LBL_SZ)
         self.cycxlabel_6.setObjectName("cycxlabel_6")
+        self.cycxlabel_6.setAlignment(_align_c)
         self.verticalLayout_34.addWidget(self.cycxlabel_6)
         self.ptn_capacity = QtWidgets.QLineEdit(parent=self.groupBox_8)
-        self.ptn_capacity.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_capacity.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_capacity.setFont(font)
-        self.ptn_capacity.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_capacity.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_capacity.setFixedSize(_INP_SZ)
+        self.ptn_capacity.setInputMethodHints(_input_hints)
+        self.ptn_capacity.setAlignment(_align_c)
         self.ptn_capacity.setObjectName("ptn_capacity")
         self.verticalLayout_34.addWidget(self.ptn_capacity)
-        spacerItem2 = QtWidgets.QSpacerItem(118, 50, QtWidgets.QSizePolicy.Policy.Minimum, QtWidgets.QSizePolicy.Policy.Fixed)
-        self.verticalLayout_34.addItem(spacerItem2)
+        self.verticalLayout_34.addStretch()
         self.chg_ptn = QtWidgets.QPushButton(parent=self.groupBox_8)
-        self.chg_ptn.setMinimumSize(QtCore.QSize(125, 50))
-        self.chg_ptn.setMaximumSize(QtCore.QSize(125, 50))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(True)
-        font.setWeight(75)
-        self.chg_ptn.setFont(font)
+        self.chg_ptn.setFixedSize(_BTN_SZ)
+        self.chg_ptn.setFont(_ptn_btn_font)
         self.chg_ptn.setObjectName("chg_ptn")
         self.verticalLayout_34.addWidget(self.chg_ptn)
-        self.gridLayout.addLayout(self.verticalLayout_34, 0, 0, 1, 1)
-        self.verticalLayout_69.addWidget(self.groupBox_8)
+        self.gridLayout.addLayout(self.verticalLayout_34, 0, 0, 1, 1, _align_c)
+        _gb_grid.addWidget(self.groupBox_8, 0, 0)
         self.groupBox_5 = QtWidgets.QGroupBox(parent=self.tab_2)
-        self.groupBox_5.setMinimumSize(QtCore.QSize(140, 300))
-        self.groupBox_5.setMaximumSize(QtCore.QSize(140, 300))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.groupBox_5.setFont(font)
+        self.groupBox_5.setFixedSize(QtCore.QSize(_GB_W, _GB_H))
+        self.groupBox_5.setAlignment(_align_c)
         self.groupBox_5.setObjectName("groupBox_5")
         self.gridLayout_17 = QtWidgets.QGridLayout(self.groupBox_5)
+        self.gridLayout_17.setContentsMargins(6, 12, 6, 6)
         self.gridLayout_17.setObjectName("gridLayout_17")
         self.verticalLayout_31 = QtWidgets.QVBoxLayout()
+        self.verticalLayout_31.setSpacing(4)
         self.verticalLayout_31.setObjectName("verticalLayout_31")
         self.cycxlabel_19 = QtWidgets.QLabel(parent=self.groupBox_5)
-        self.cycxlabel_19.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_19.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_19.setFont(font)
+        self.cycxlabel_19.setFixedSize(_LBL_SZ)
         self.cycxlabel_19.setObjectName("cycxlabel_19")
+        self.cycxlabel_19.setAlignment(_align_c)
         self.verticalLayout_31.addWidget(self.cycxlabel_19)
         self.ptn_chgv_pre = QtWidgets.QLineEdit(parent=self.groupBox_5)
-        self.ptn_chgv_pre.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_chgv_pre.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_chgv_pre.setFont(font)
-        self.ptn_chgv_pre.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_chgv_pre.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_chgv_pre.setFixedSize(_INP_SZ)
+        self.ptn_chgv_pre.setInputMethodHints(_input_hints)
+        self.ptn_chgv_pre.setAlignment(_align_c)
         self.ptn_chgv_pre.setObjectName("ptn_chgv_pre")
         self.verticalLayout_31.addWidget(self.ptn_chgv_pre)
         self.cycxlabel_20 = QtWidgets.QLabel(parent=self.groupBox_5)
-        self.cycxlabel_20.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_20.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_20.setFont(font)
+        self.cycxlabel_20.setFixedSize(_LBL_SZ)
         self.cycxlabel_20.setObjectName("cycxlabel_20")
+        self.cycxlabel_20.setAlignment(_align_c)
         self.verticalLayout_31.addWidget(self.cycxlabel_20)
         self.ptn_chgv_after = QtWidgets.QLineEdit(parent=self.groupBox_5)
-        self.ptn_chgv_after.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_chgv_after.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_chgv_after.setFont(font)
-        self.ptn_chgv_after.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_chgv_after.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_chgv_after.setFixedSize(_INP_SZ)
+        self.ptn_chgv_after.setInputMethodHints(_input_hints)
+        self.ptn_chgv_after.setAlignment(_align_c)
         self.ptn_chgv_after.setObjectName("ptn_chgv_after")
         self.verticalLayout_31.addWidget(self.ptn_chgv_after)
-        spacerItem3 = QtWidgets.QSpacerItem(118, 50, QtWidgets.QSizePolicy.Policy.Minimum, QtWidgets.QSizePolicy.Policy.Fixed)
-        self.verticalLayout_31.addItem(spacerItem3)
+        self.verticalLayout_31.addStretch()
         self.chg_ptn_chgv = QtWidgets.QPushButton(parent=self.groupBox_5)
-        self.chg_ptn_chgv.setMinimumSize(QtCore.QSize(125, 50))
-        self.chg_ptn_chgv.setMaximumSize(QtCore.QSize(125, 50))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(True)
-        font.setWeight(75)
-        self.chg_ptn_chgv.setFont(font)
+        self.chg_ptn_chgv.setFixedSize(_BTN_SZ)
+        self.chg_ptn_chgv.setFont(_ptn_btn_font)
         self.chg_ptn_chgv.setObjectName("chg_ptn_chgv")
         self.verticalLayout_31.addWidget(self.chg_ptn_chgv)
-        self.gridLayout_17.addLayout(self.verticalLayout_31, 0, 0, 1, 1)
-        self.verticalLayout_69.addWidget(self.groupBox_5)
-        self.horizontalLayout_133.addLayout(self.verticalLayout_69)
-        spacerItem4 = QtWidgets.QSpacerItem(17, 608, QtWidgets.QSizePolicy.Policy.Expanding, QtWidgets.QSizePolicy.Policy.Minimum)
-        self.horizontalLayout_133.addItem(spacerItem4)
-        self.verticalLayout_70 = QtWidgets.QVBoxLayout()
-        self.verticalLayout_70.setObjectName("verticalLayout_70")
+        self.gridLayout_17.addLayout(self.verticalLayout_31, 0, 0, 1, 1, _align_c)
+        _gb_grid.addWidget(self.groupBox_5, 1, 0)
         self.groupBox_2 = QtWidgets.QGroupBox(parent=self.tab_2)
-        self.groupBox_2.setMinimumSize(QtCore.QSize(140, 300))
-        self.groupBox_2.setMaximumSize(QtCore.QSize(140, 300))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.groupBox_2.setFont(font)
+        self.groupBox_2.setFixedSize(QtCore.QSize(_GB_W, _GB_H))
+        self.groupBox_2.setAlignment(_align_c)
         self.groupBox_2.setObjectName("groupBox_2")
         self.gridLayout_12 = QtWidgets.QGridLayout(self.groupBox_2)
+        self.gridLayout_12.setContentsMargins(6, 12, 6, 6)
         self.gridLayout_12.setObjectName("gridLayout_12")
         self.verticalLayout_21 = QtWidgets.QVBoxLayout()
+        self.verticalLayout_21.setSpacing(4)
         self.verticalLayout_21.setObjectName("verticalLayout_21")
         self.cycxlabel_9 = QtWidgets.QLabel(parent=self.groupBox_2)
-        self.cycxlabel_9.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_9.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_9.setFont(font)
+        self.cycxlabel_9.setFixedSize(_LBL_SZ)
         self.cycxlabel_9.setObjectName("cycxlabel_9")
+        self.cycxlabel_9.setAlignment(_align_c)
         self.verticalLayout_21.addWidget(self.cycxlabel_9)
         self.ptn_refi_pre = QtWidgets.QLineEdit(parent=self.groupBox_2)
-        self.ptn_refi_pre.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_refi_pre.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_refi_pre.setFont(font)
-        self.ptn_refi_pre.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_refi_pre.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_refi_pre.setFixedSize(_INP_SZ)
+        self.ptn_refi_pre.setInputMethodHints(_input_hints)
+        self.ptn_refi_pre.setAlignment(_align_c)
         self.ptn_refi_pre.setObjectName("ptn_refi_pre")
         self.verticalLayout_21.addWidget(self.ptn_refi_pre)
         self.cycxlabel_10 = QtWidgets.QLabel(parent=self.groupBox_2)
-        self.cycxlabel_10.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_10.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_10.setFont(font)
+        self.cycxlabel_10.setFixedSize(_LBL_SZ)
         self.cycxlabel_10.setObjectName("cycxlabel_10")
+        self.cycxlabel_10.setAlignment(_align_c)
         self.verticalLayout_21.addWidget(self.cycxlabel_10)
         self.ptn_refi_after = QtWidgets.QLineEdit(parent=self.groupBox_2)
-        self.ptn_refi_after.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_refi_after.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_refi_after.setFont(font)
-        self.ptn_refi_after.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_refi_after.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_refi_after.setFixedSize(_INP_SZ)
+        self.ptn_refi_after.setInputMethodHints(_input_hints)
+        self.ptn_refi_after.setAlignment(_align_c)
         self.ptn_refi_after.setObjectName("ptn_refi_after")
         self.verticalLayout_21.addWidget(self.ptn_refi_after)
-        spacerItem5 = QtWidgets.QSpacerItem(118, 50, QtWidgets.QSizePolicy.Policy.Minimum, QtWidgets.QSizePolicy.Policy.Fixed)
-        self.verticalLayout_21.addItem(spacerItem5)
+        self.verticalLayout_21.addStretch()
         self.chg_ptn_refi = QtWidgets.QPushButton(parent=self.groupBox_2)
-        self.chg_ptn_refi.setMinimumSize(QtCore.QSize(125, 50))
-        self.chg_ptn_refi.setMaximumSize(QtCore.QSize(125, 50))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(True)
-        font.setWeight(75)
-        self.chg_ptn_refi.setFont(font)
+        self.chg_ptn_refi.setFixedSize(_BTN_SZ)
+        self.chg_ptn_refi.setFont(_ptn_btn_font)
         self.chg_ptn_refi.setObjectName("chg_ptn_refi")
         self.verticalLayout_21.addWidget(self.chg_ptn_refi)
-        self.gridLayout_12.addLayout(self.verticalLayout_21, 0, 0, 1, 1)
-        self.verticalLayout_70.addWidget(self.groupBox_2)
+        self.gridLayout_12.addLayout(self.verticalLayout_21, 0, 0, 1, 1, _align_c)
+        _gb_grid.addWidget(self.groupBox_2, 0, 1)
         self.groupBox_7 = QtWidgets.QGroupBox(parent=self.tab_2)
-        self.groupBox_7.setMinimumSize(QtCore.QSize(140, 300))
-        self.groupBox_7.setMaximumSize(QtCore.QSize(140, 300))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.groupBox_7.setFont(font)
+        self.groupBox_7.setFixedSize(QtCore.QSize(_GB_W, _GB_H))
+        self.groupBox_7.setAlignment(_align_c)
         self.groupBox_7.setObjectName("groupBox_7")
         self.gridLayout_21 = QtWidgets.QGridLayout(self.groupBox_7)
+        self.gridLayout_21.setContentsMargins(6, 12, 6, 6)
         self.gridLayout_21.setObjectName("gridLayout_21")
         self.verticalLayout_35 = QtWidgets.QVBoxLayout()
+        self.verticalLayout_35.setSpacing(4)
         self.verticalLayout_35.setObjectName("verticalLayout_35")
         self.cycxlabel_27 = QtWidgets.QLabel(parent=self.groupBox_7)
-        self.cycxlabel_27.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_27.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_27.setFont(font)
+        self.cycxlabel_27.setFixedSize(_LBL_SZ)
         self.cycxlabel_27.setObjectName("cycxlabel_27")
+        self.cycxlabel_27.setAlignment(_align_c)
         self.verticalLayout_35.addWidget(self.cycxlabel_27)
         self.ptn_dchgv_pre = QtWidgets.QLineEdit(parent=self.groupBox_7)
-        self.ptn_dchgv_pre.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_dchgv_pre.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_dchgv_pre.setFont(font)
-        self.ptn_dchgv_pre.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_dchgv_pre.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_dchgv_pre.setFixedSize(_INP_SZ)
+        self.ptn_dchgv_pre.setInputMethodHints(_input_hints)
+        self.ptn_dchgv_pre.setAlignment(_align_c)
         self.ptn_dchgv_pre.setObjectName("ptn_dchgv_pre")
         self.verticalLayout_35.addWidget(self.ptn_dchgv_pre)
         self.cycxlabel_28 = QtWidgets.QLabel(parent=self.groupBox_7)
-        self.cycxlabel_28.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_28.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_28.setFont(font)
+        self.cycxlabel_28.setFixedSize(_LBL_SZ)
         self.cycxlabel_28.setObjectName("cycxlabel_28")
+        self.cycxlabel_28.setAlignment(_align_c)
         self.verticalLayout_35.addWidget(self.cycxlabel_28)
         self.ptn_dchgv_after = QtWidgets.QLineEdit(parent=self.groupBox_7)
-        self.ptn_dchgv_after.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_dchgv_after.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_dchgv_after.setFont(font)
-        self.ptn_dchgv_after.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_dchgv_after.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_dchgv_after.setFixedSize(_INP_SZ)
+        self.ptn_dchgv_after.setInputMethodHints(_input_hints)
+        self.ptn_dchgv_after.setAlignment(_align_c)
         self.ptn_dchgv_after.setObjectName("ptn_dchgv_after")
         self.verticalLayout_35.addWidget(self.ptn_dchgv_after)
-        spacerItem6 = QtWidgets.QSpacerItem(118, 50, QtWidgets.QSizePolicy.Policy.Minimum, QtWidgets.QSizePolicy.Policy.Fixed)
-        self.verticalLayout_35.addItem(spacerItem6)
+        self.verticalLayout_35.addStretch()
         self.chg_ptn_dchgv = QtWidgets.QPushButton(parent=self.groupBox_7)
-        self.chg_ptn_dchgv.setMinimumSize(QtCore.QSize(125, 50))
-        self.chg_ptn_dchgv.setMaximumSize(QtCore.QSize(125, 50))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(True)
-        font.setWeight(75)
-        self.chg_ptn_dchgv.setFont(font)
+        self.chg_ptn_dchgv.setFixedSize(_BTN_SZ)
+        self.chg_ptn_dchgv.setFont(_ptn_btn_font)
         self.chg_ptn_dchgv.setObjectName("chg_ptn_dchgv")
         self.verticalLayout_35.addWidget(self.chg_ptn_dchgv)
-        self.gridLayout_21.addLayout(self.verticalLayout_35, 0, 0, 1, 1)
-        self.verticalLayout_70.addWidget(self.groupBox_7)
-        self.horizontalLayout_133.addLayout(self.verticalLayout_70)
-        spacerItem7 = QtWidgets.QSpacerItem(18, 608, QtWidgets.QSizePolicy.Policy.Expanding, QtWidgets.QSizePolicy.Policy.Minimum)
-        self.horizontalLayout_133.addItem(spacerItem7)
-        self.verticalLayout_71 = QtWidgets.QVBoxLayout()
-        self.verticalLayout_71.setObjectName("verticalLayout_71")
+        self.gridLayout_21.addLayout(self.verticalLayout_35, 0, 0, 1, 1, _align_c)
+        _gb_grid.addWidget(self.groupBox_7, 1, 1)
         self.groupBox_3 = QtWidgets.QGroupBox(parent=self.tab_2)
-        self.groupBox_3.setMinimumSize(QtCore.QSize(140, 300))
-        self.groupBox_3.setMaximumSize(QtCore.QSize(140, 300))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.groupBox_3.setFont(font)
+        self.groupBox_3.setFixedSize(QtCore.QSize(_GB_W, _GB_H))
+        self.groupBox_3.setAlignment(_align_c)
         self.groupBox_3.setObjectName("groupBox_3")
         self.gridLayout_13 = QtWidgets.QGridLayout(self.groupBox_3)
+        self.gridLayout_13.setContentsMargins(6, 12, 6, 6)
         self.gridLayout_13.setObjectName("gridLayout_13")
         self.verticalLayout_23 = QtWidgets.QVBoxLayout()
+        self.verticalLayout_23.setSpacing(4)
         self.verticalLayout_23.setObjectName("verticalLayout_23")
         self.cycxlabel_11 = QtWidgets.QLabel(parent=self.groupBox_3)
-        self.cycxlabel_11.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_11.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_11.setFont(font)
+        self.cycxlabel_11.setFixedSize(_LBL_SZ)
         self.cycxlabel_11.setObjectName("cycxlabel_11")
+        self.cycxlabel_11.setAlignment(_align_c)
         self.verticalLayout_23.addWidget(self.cycxlabel_11)
         self.ptn_endi_pre = QtWidgets.QLineEdit(parent=self.groupBox_3)
-        self.ptn_endi_pre.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_endi_pre.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_endi_pre.setFont(font)
-        self.ptn_endi_pre.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_endi_pre.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_endi_pre.setFixedSize(_INP_SZ)
+        self.ptn_endi_pre.setInputMethodHints(_input_hints)
+        self.ptn_endi_pre.setAlignment(_align_c)
         self.ptn_endi_pre.setObjectName("ptn_endi_pre")
         self.verticalLayout_23.addWidget(self.ptn_endi_pre)
         self.cycxlabel_13 = QtWidgets.QLabel(parent=self.groupBox_3)
-        self.cycxlabel_13.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_13.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_13.setFont(font)
+        self.cycxlabel_13.setFixedSize(_LBL_SZ)
         self.cycxlabel_13.setObjectName("cycxlabel_13")
+        self.cycxlabel_13.setAlignment(_align_c)
         self.verticalLayout_23.addWidget(self.cycxlabel_13)
         self.ptn_endi_after = QtWidgets.QLineEdit(parent=self.groupBox_3)
-        self.ptn_endi_after.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_endi_after.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_endi_after.setFont(font)
-        self.ptn_endi_after.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_endi_after.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_endi_after.setFixedSize(_INP_SZ)
+        self.ptn_endi_after.setInputMethodHints(_input_hints)
+        self.ptn_endi_after.setAlignment(_align_c)
         self.ptn_endi_after.setObjectName("ptn_endi_after")
         self.verticalLayout_23.addWidget(self.ptn_endi_after)
-        spacerItem8 = QtWidgets.QSpacerItem(118, 50, QtWidgets.QSizePolicy.Policy.Minimum, QtWidgets.QSizePolicy.Policy.Fixed)
-        self.verticalLayout_23.addItem(spacerItem8)
+        self.verticalLayout_23.addStretch()
         self.chg_ptn_endi = QtWidgets.QPushButton(parent=self.groupBox_3)
-        self.chg_ptn_endi.setMinimumSize(QtCore.QSize(125, 50))
-        self.chg_ptn_endi.setMaximumSize(QtCore.QSize(125, 50))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(True)
-        font.setWeight(75)
-        self.chg_ptn_endi.setFont(font)
+        self.chg_ptn_endi.setFixedSize(_BTN_SZ)
+        self.chg_ptn_endi.setFont(_ptn_btn_font)
         self.chg_ptn_endi.setObjectName("chg_ptn_endi")
         self.verticalLayout_23.addWidget(self.chg_ptn_endi)
-        self.gridLayout_13.addLayout(self.verticalLayout_23, 0, 0, 1, 1)
-        self.verticalLayout_71.addWidget(self.groupBox_3)
+        self.gridLayout_13.addLayout(self.verticalLayout_23, 0, 0, 1, 1, _align_c)
+        _gb_grid.addWidget(self.groupBox_3, 0, 2)
         self.groupBox_6 = QtWidgets.QGroupBox(parent=self.tab_2)
-        self.groupBox_6.setMinimumSize(QtCore.QSize(140, 300))
-        self.groupBox_6.setMaximumSize(QtCore.QSize(140, 300))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.groupBox_6.setFont(font)
+        self.groupBox_6.setFixedSize(QtCore.QSize(_GB_W, _GB_H))
+        self.groupBox_6.setAlignment(_align_c)
         self.groupBox_6.setObjectName("groupBox_6")
         self.gridLayout_18 = QtWidgets.QGridLayout(self.groupBox_6)
+        self.gridLayout_18.setContentsMargins(6, 12, 6, 6)
         self.gridLayout_18.setObjectName("gridLayout_18")
         self.verticalLayout_32 = QtWidgets.QVBoxLayout()
+        self.verticalLayout_32.setSpacing(4)
         self.verticalLayout_32.setObjectName("verticalLayout_32")
         self.cycxlabel_21 = QtWidgets.QLabel(parent=self.groupBox_6)
-        self.cycxlabel_21.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_21.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_21.setFont(font)
+        self.cycxlabel_21.setFixedSize(_LBL_SZ)
         self.cycxlabel_21.setObjectName("cycxlabel_21")
+        self.cycxlabel_21.setAlignment(_align_c)
         self.verticalLayout_32.addWidget(self.cycxlabel_21)
         self.ptn_endv_pre = QtWidgets.QLineEdit(parent=self.groupBox_6)
-        self.ptn_endv_pre.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_endv_pre.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_endv_pre.setFont(font)
-        self.ptn_endv_pre.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_endv_pre.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_endv_pre.setFixedSize(_INP_SZ)
+        self.ptn_endv_pre.setInputMethodHints(_input_hints)
+        self.ptn_endv_pre.setAlignment(_align_c)
         self.ptn_endv_pre.setObjectName("ptn_endv_pre")
         self.verticalLayout_32.addWidget(self.ptn_endv_pre)
         self.cycxlabel_22 = QtWidgets.QLabel(parent=self.groupBox_6)
-        self.cycxlabel_22.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_22.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_22.setFont(font)
+        self.cycxlabel_22.setFixedSize(_LBL_SZ)
         self.cycxlabel_22.setObjectName("cycxlabel_22")
+        self.cycxlabel_22.setAlignment(_align_c)
         self.verticalLayout_32.addWidget(self.cycxlabel_22)
         self.ptn_endv_after = QtWidgets.QLineEdit(parent=self.groupBox_6)
-        self.ptn_endv_after.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_endv_after.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_endv_after.setFont(font)
-        self.ptn_endv_after.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_endv_after.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_endv_after.setFixedSize(_INP_SZ)
+        self.ptn_endv_after.setInputMethodHints(_input_hints)
+        self.ptn_endv_after.setAlignment(_align_c)
         self.ptn_endv_after.setObjectName("ptn_endv_after")
         self.verticalLayout_32.addWidget(self.ptn_endv_after)
-        spacerItem9 = QtWidgets.QSpacerItem(118, 50, QtWidgets.QSizePolicy.Policy.Minimum, QtWidgets.QSizePolicy.Policy.Fixed)
-        self.verticalLayout_32.addItem(spacerItem9)
+        self.verticalLayout_32.addStretch()
         self.chg_ptn_endv = QtWidgets.QPushButton(parent=self.groupBox_6)
-        self.chg_ptn_endv.setMinimumSize(QtCore.QSize(125, 50))
-        self.chg_ptn_endv.setMaximumSize(QtCore.QSize(125, 50))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(True)
-        font.setWeight(75)
-        self.chg_ptn_endv.setFont(font)
+        self.chg_ptn_endv.setFixedSize(_BTN_SZ)
+        self.chg_ptn_endv.setFont(_ptn_btn_font)
         self.chg_ptn_endv.setObjectName("chg_ptn_endv")
         self.verticalLayout_32.addWidget(self.chg_ptn_endv)
-        self.gridLayout_18.addLayout(self.verticalLayout_32, 0, 0, 1, 1)
-        self.verticalLayout_71.addWidget(self.groupBox_6)
-        self.horizontalLayout_133.addLayout(self.verticalLayout_71)
-        spacerItem10 = QtWidgets.QSpacerItem(17, 608, QtWidgets.QSizePolicy.Policy.Expanding, QtWidgets.QSizePolicy.Policy.Minimum)
-        self.horizontalLayout_133.addItem(spacerItem10)
+        self.gridLayout_18.addLayout(self.verticalLayout_32, 0, 0, 1, 1, _align_c)
+        _gb_grid.addWidget(self.groupBox_6, 1, 2)
+        # Step 蹂寃?+ Toyo ?⑦꽩 蹂????         self.groupBox_4 = QtWidgets.QGroupBox(parent=self.tab_2)
-        self.groupBox_4.setMinimumSize(QtCore.QSize(140, 400))
-        self.groupBox_4.setMaximumSize(QtCore.QSize(140, 400))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.groupBox_4.setFont(font)
+        self.groupBox_4.setFixedSize(QtCore.QSize(_GB_W, _GB_H))
+        self.groupBox_4.setAlignment(_align_c)
         self.groupBox_4.setObjectName("groupBox_4")
         self.gridLayout_14 = QtWidgets.QGridLayout(self.groupBox_4)
+        self.gridLayout_14.setContentsMargins(6, 12, 6, 6)
         self.gridLayout_14.setObjectName("gridLayout_14")
         self.verticalLayout_30 = QtWidgets.QVBoxLayout()
+        self.verticalLayout_30.setSpacing(4)
         self.verticalLayout_30.setObjectName("verticalLayout_30")
         self.cycxlabel_16 = QtWidgets.QLabel(parent=self.groupBox_4)
-        self.cycxlabel_16.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_16.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_16.setFont(font)
+        self.cycxlabel_16.setFixedSize(_LBL_SZ)
         self.cycxlabel_16.setObjectName("cycxlabel_16")
+        self.cycxlabel_16.setAlignment(_align_c)
         self.verticalLayout_30.addWidget(self.cycxlabel_16)
         self.ptn_step_pre = QtWidgets.QLineEdit(parent=self.groupBox_4)
-        self.ptn_step_pre.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_step_pre.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_step_pre.setFont(font)
-        self.ptn_step_pre.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_step_pre.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_step_pre.setFixedSize(_INP_SZ)
+        self.ptn_step_pre.setInputMethodHints(_input_hints)
+        self.ptn_step_pre.setAlignment(_align_c)
         self.ptn_step_pre.setObjectName("ptn_step_pre")
         self.verticalLayout_30.addWidget(self.ptn_step_pre)
         self.cycxlabel_14 = QtWidgets.QLabel(parent=self.groupBox_4)
-        self.cycxlabel_14.setMinimumSize(QtCore.QSize(125, 20))
-        self.cycxlabel_14.setMaximumSize(QtCore.QSize(125, 20))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.cycxlabel_14.setFont(font)
+        self.cycxlabel_14.setFixedSize(_LBL_SZ)
         self.cycxlabel_14.setObjectName("cycxlabel_14")
+        self.cycxlabel_14.setAlignment(_align_c)
         self.verticalLayout_30.addWidget(self.cycxlabel_14)
         self.ptn_step_after = QtWidgets.QLineEdit(parent=self.groupBox_4)
-        self.ptn_step_after.setMinimumSize(QtCore.QSize(125, 30))
-        self.ptn_step_after.setMaximumSize(QtCore.QSize(125, 30))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(False)
-        font.setWeight(50)
-        self.ptn_step_after.setFont(font)
-        self.ptn_step_after.setInputMethodHints(QtCore.Qt.InputMethodHint.ImhFormattedNumbersOnly)
-        self.ptn_step_after.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
+        self.ptn_step_after.setFixedSize(_INP_SZ)
+        self.ptn_step_after.setInputMethodHints(_input_hints)
+        self.ptn_step_after.setAlignment(_align_c)
         self.ptn_step_after.setObjectName("ptn_step_after")
         self.verticalLayout_30.addWidget(self.ptn_step_after)
-        spacerItem11 = QtWidgets.QSpacerItem(118, 80, QtWidgets.QSizePolicy.Policy.Minimum, QtWidgets.QSizePolicy.Policy.Fixed)
-        self.verticalLayout_30.addItem(spacerItem11)
+        self.verticalLayout_30.addStretch()
         self.chg_ptn_step = QtWidgets.QPushButton(parent=self.groupBox_4)
-        self.chg_ptn_step.setMinimumSize(QtCore.QSize(125, 50))
-        self.chg_ptn_step.setMaximumSize(QtCore.QSize(125, 50))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        font.setBold(True)
-        font.setWeight(75)
-        self.chg_ptn_step.setFont(font)
+        self.chg_ptn_step.setFixedSize(_BTN_SZ)
+        self.chg_ptn_step.setFont(_ptn_btn_font)
         self.chg_ptn_step.setObjectName("chg_ptn_step")
         self.verticalLayout_30.addWidget(self.chg_ptn_step)
-        self.gridLayout_14.addLayout(self.verticalLayout_30, 0, 0, 1, 1)
-        self.horizontalLayout_133.addWidget(self.groupBox_4)
-        self.verticalLayout_9.addLayout(self.horizontalLayout_133)
+        self.gridLayout_14.addLayout(self.verticalLayout_30, 0, 0, 1, 1, _align_c)
+        _gb_grid.addWidget(self.groupBox_4, 0, 3)
+        self.verticalLayout_9.addLayout(_gb_grid)
         self.horizontalLayout_134.addLayout(self.verticalLayout_9)
+        # --- ptn_list ?곸뿭: Toyo 踰꾪듉(?곗긽?? + ?뚯씠釉?---
+        _ptn_list_vbox = QtWidgets.QVBoxLayout()
+        _ptn_list_vbox.setSpacing(4)
+        _toyo_row = QtWidgets.QHBoxLayout()
+        _toyo_row.addStretch()
+        self.ptn_toyo_convert = QtWidgets.QPushButton(parent=self.tab_2)
+        self.ptn_toyo_convert.setFixedSize(QtCore.QSize(140, 36))
+        self.ptn_toyo_convert.setFont(_ptn_btn_font)
+        self.ptn_toyo_convert.setObjectName("ptn_toyo_convert")
+        self.ptn_toyo_convert.setText("Toyo ?⑦꽩 蹂??)
+        _toyo_row.addWidget(self.ptn_toyo_convert)
+        _ptn_list_vbox.addLayout(_toyo_row)
         self.ptn_list = QtWidgets.QTableWidget(parent=self.tab_2)
         self.ptn_list.setMinimumSize(QtCore.QSize(1200, 830))
         self.ptn_list.setMaximumSize(QtCore.QSize(1200, 830))
-        font = QtGui.QFont()
-        font.setFamily("留묒? 怨좊뵓")
-        font.setPointSize(9)
-        self.ptn_list.setFont(font)
         self.ptn_list.setSizeAdjustPolicy(QtWidgets.QAbstractScrollArea.SizeAdjustPolicy.AdjustToContents)
         self.ptn_list.setAlternatingRowColors(True)
         self.ptn_list.setSelectionMode(QtWidgets.QAbstractItemView.SelectionMode.ExtendedSelection)
@@ -3810,35 +4050,17 @@ class Ui_sitool(object):
         self.ptn_list.setObjectName("ptn_list")
         self.ptn_list.setColumnCount(4)
         self.ptn_list.setRowCount(0)
-        item = QtWidgets.QTableWidgetItem()
-        font = QtGui.QFont()
-        font.setFamily("Pretendard")
-        font.setPointSize(8)
-        item.setFont(font)
-        self.ptn_list.setHorizontalHeaderItem(0, item)
-        item = QtWidgets.QTableWidgetItem()
-        font = QtGui.QFont()
-        font.setFamily("Pretendard")
-        font.setPointSize(8)
-        item.setFont(font)
-        self.ptn_list.setHorizontalHeaderItem(1, item)
-        item = QtWidgets.QTableWidgetItem()
-        font = QtGui.QFont()
-        font.setFamily("Pretendard")
-        font.setPointSize(8)
-        item.setFont(font)
-        self.ptn_list.setHorizontalHeaderItem(2, item)
-        item = QtWidgets.QTableWidgetItem()
-        font = QtGui.QFont()
-        font.setFamily("Pretendard")
-        font.setPointSize(8)
-        item.setFont(font)
-        self.ptn_list.setHorizontalHeaderItem(3, item)
+        _hdr_font = QtGui.QFont("留묒? 怨좊뵓", 8)
+        for _hi in range(4):
+            item = QtWidgets.QTableWidgetItem()
+            item.setFont(_hdr_font)
+            self.ptn_list.setHorizontalHeaderItem(_hi, item)
         self.ptn_list.horizontalHeader().setVisible(False)
         self.ptn_list.horizontalHeader().setDefaultSectionSize(198)
         self.ptn_list.horizontalHeader().setMinimumSectionSize(50)
         self.ptn_list.verticalHeader().setVisible(False)
-        self.horizontalLayout_134.addWidget(self.ptn_list)
+        _ptn_list_vbox.addWidget(self.ptn_list)
+        self.horizontalLayout_134.addLayout(_ptn_list_vbox)
         self.horizontalLayout_135.addLayout(self.horizontalLayout_134)
         self.tabWidget.addTab(self.tab_2, "")
         self.SetTab = QtWidgets.QWidget()
@@ -7822,7 +8044,7 @@ class Ui_sitool(object):
 
     def retranslateUi(self, sitool):
         _translate = QtCore.QCoreApplication.translate
-        sitool.setWindowTitle(_translate("sitool", "BatteryDataTool v260203"))
+        sitool.setWindowTitle(_translate("sitool", "BatteryDataTool v260212"))
         self.tb_room.setItemText(0, _translate("sitool", "R5 15F"))
         self.tb_room.setItemText(1, _translate("sitool", "R5 3F B-1"))
         self.tb_room.setItemText(2, _translate("sitool", "R5 3F B-2"))
@@ -7890,6 +8112,7 @@ class Ui_sitool(object):
         self.tabWidget.setTabText(self.tabWidget.indexOf(self.tab), _translate("sitool", "?꾪솴"))
         self.chk_cyclepath.setText(_translate("sitool", "吏?뷥ath?ъ슜"))
         self.chk_ectpath.setText(_translate("sitool", "ECT path ?ъ슜"))
+        self.chk_coincell_cyc.setText(_translate("sitool", "肄붿씤?"))
         self.cycle_tab_reset.setText(_translate("sitool", "Tab Reset"))
         self.capacitygroup.setTitle(_translate("sitool", "?⑸웾 ?좏깮"))
         self.inicaprate.setText(_translate("sitool", "1) Cyclepath ?대쫫 ?⑸웾 湲곗?\n"
@@ -7922,10 +8145,11 @@ class Ui_sitool(object):
         self.tabWidget_2.setTabText(self.tabWidget_2.indexOf(self.tab_5), _translate("sitool", "Cycle"))
         self.CycProfile.setText(_translate("sitool", "?ъ씠???듯빀"))
         self.CellProfile.setText(_translate("sitool", "?蹂??듯빀"))
+        self.AllProfile.setText(_translate("sitool", "?꾩껜 ?듯빀"))
         self.chk_dqdv.setText(_translate("sitool", "dQdV X/Y異?蹂??))
         self.stepnumlb.setText(_translate("sitool", "Cycle\n"
 "(?먰븯???ㅽ뀦?ㅼ쓣 ?꾩뼱?곌린??-濡??쒓린)\n"
-"?? 3 4 5 8-9"))
+"?? 2 3-5 8-9"))
         self.stepnum.setPlainText(_translate("sitool", "2"))
         self.smoothlb_3.setText(_translate("sitool", "?꾩븬 Y異??섑븳"))
         self.volrngyhl.setText(_translate("sitool", "2.5"))
@@ -8373,6 +8597,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         self.chg_ptn_endv.clicked.connect(self.ptn_change_endv_button)
         self.chg_ptn_step.clicked.connect(self.ptn_change_step_button)
         self.ptn_load.clicked.connect(self.ptn_load_button)
+        self.ptn_toyo_convert.clicked.connect(self.ptn_toyo_convert_button)
         # dVdQ fitting
         self.min_rms = np.inf
         self.mat_dvdq_btn.clicked.connect(self.dvdq_material_button)
@@ -8433,6 +8658,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         - 寃쎈줈 ?ㅼ젙
         """
         button_widget.setDisabled(True)
+        set_coincell_mode(self.chk_coincell_cyc.isChecked())
         
         config = self.Profile_ini_set()
         pne_path = self.pne_path_setting()
@@ -8486,26 +8712,574 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         toolbar = NavigationToolbar(canvas, None)
         
         return tab, tab_layout, canvas, toolbar
-    
-    def _finalize_plot_tab(self, tab, tab_layout, canvas, toolbar, tab_no):
-        """
-        ??理쒖쥌
-        """
-        tab_layout.addWidget(toolbar)
-        tab_layout.addWidget(canvas)
-        self.cycle_tab.addTab(tab, str(tab_no))
-        self.cycle_tab.setCurrentWidget(tab)
-        plt.tight_layout(pad=1, w_pad=1, h_pad=1)
-    
-    def _setup_legend(self, axes_list, data_name, positions):
+
+    def _create_cycle_channel_control(self, channel_map, canvas, fig, axes_list, args_parent_tab=None, sub_channel_map=None):
         """
-        踰붾? ?ㅼ젙
+        Cycle 洹몃옒??梨꾨꼸 ?쒖뼱 ?꾩젽 ?앹꽦 (?ㅻ쾭?덉씠 ?좉?)
+        channel_map: dict of {label: {'artists': [PathCollection...], 'color': original_color}}
+        ?쇱퀜??figure ?꾩뿉 ?ㅻ쾭?덉씠 ??figure ?ш린 遺덈?
+        
+        Returns: toggle_btn (QPushButton) - ?덉씠?꾩썐??異붽????좉? 踰꾪듉
+        ?ㅻ쾭?덉씠 ?⑤꼸? parent_tab???먯떇?쇰줈 ?앹꽦 (?덉씠?꾩썐 諛?
         """
-        if len(data_name) != 0:
-            for ax, pos in zip(axes_list, positions):
-                ax.legend(loc=pos)
-        else:
-            plt.legend(loc="center left", bbox_to_anchor=(1, 0.5))
+        from PyQt6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, 
+                                      QListWidget, QListWidgetItem, QLabel,
+                                      QCheckBox, QPushButton, QFrame)
+        from PyQt6.QtCore import Qt, QObject, QEvent, QPoint
+        from PyQt6.QtGui import QColor
+        from math import ceil
+        
+        parent_tab = args_parent_tab  # _finalize_cycle_tab?먯꽌 ?꾨떖
+        
+        # ?? ?좉? 踰꾪듉 (而댄뙥?? toolbar ?놁뿉 諛곗튂) ??
+        toggle_btn = QPushButton("??CH")
+        toggle_btn.setFixedSize(50, 22)
+        toggle_btn.setCursor(Qt.CursorShape.PointingHandCursor)
+        toggle_btn.setStyleSheet(
+            "QPushButton { font-size: 10px; font-weight: bold; text-align: left; "
+            "padding-left: 8px; border: 1px solid #ccc; background: #f5f5f5; }"
+            "QPushButton:hover { background: #e0e0e0; }"
+        )
+        
+        # ?? ?ㅽ겕/?쇱씠???뚮쭏 ?먮룞 媛먯? ??
+        from PyQt6.QtWidgets import QApplication
+        _palette = QApplication.instance().palette()
+        _bg = _palette.color(_palette.ColorRole.Window)
+        _is_dark = _bg.lightness() < 128
+        if _is_dark:
+            _overlay_bg = "rgba(45, 45, 48, 0.95)"
+            _overlay_border = "#555"
+            _btn_bg = "#3c3c3c"
+            _btn_hover = "#505050"
+            _btn_border = "#666"
+            _list_style = "QListWidget { font-size: 12px; color: #ddd; background: #2d2d30; }"
+        else:
+            _overlay_bg = "rgba(255, 255, 255, 0.95)"
+            _overlay_border = "#999"
+            _btn_bg = "#f5f5f5"
+            _btn_hover = "#e0e0e0"
+            _btn_border = "#ccc"
+            _list_style = "QListWidget { font-size: 12px; }"
+        
+        toggle_btn.setStyleSheet(
+            f"QPushButton {{ font-size: 10px; font-weight: bold; "
+            f"border: 1px solid {_btn_border}; border-radius: 3px; "
+            f"background: {_btn_bg}; padding: 2px 4px; }}"
+            f"QPushButton:hover {{ background: {_btn_hover}; }}"
+        )
+        
+        # ?? ?ㅻ쾭?덉씠 ?⑤꼸 (parent_tab???먯떇, ?덉씠?꾩썐 諛???figure ?ш린 遺덈?) ??
+        overlay = QFrame(parent_tab)
+        overlay_layout = QHBoxLayout(overlay)
+        overlay_layout.setContentsMargins(4, 2, 4, 2)
+        overlay_layout.setSpacing(4)
+        overlay.setStyleSheet(
+            f"QFrame {{ background: {_overlay_bg}; "
+            f"border: 1px solid {_overlay_border}; border-radius: 4px; }}"
+        )
+        overlay.setVisible(False)
+        
+        # ?? ?リ린(?묎린) 踰꾪듉 (?ㅻ쾭?덉씠 ?대?) ??
+        close_btn = QPushButton("??)
+        close_btn.setFixedSize(18, 18)
+        close_btn.setStyleSheet(
+            f"QPushButton {{ font-size: 12px; font-weight: bold; border: none; "
+            f"background: transparent; color: {'#ccc' if _is_dark else '#666'}; padding: 0; }}"
+            f"QPushButton:hover {{ color: {'#fff' if _is_dark else '#000'}; }}"
+        )
+        overlay_layout.addWidget(close_btn, 0, Qt.AlignmentFlag.AlignTop)
+        
+        # --- 1) 梨꾨꼸 由ъ뒪?? 紐⑤뱺 梨꾨꼸 媛쒕퀎 ?쒖떆 ---
+        import re as _re
+        ch_list = QListWidget()
+        ch_list.setMinimumWidth(120)
+        ch_list.setMaximumWidth(200)
+        ch_list.setStyleSheet(_list_style)
+        
+        # 紐⑤뱺 梨꾨꼸 媛쒕퀎 由ъ뒪??(?섎쾭留?異붽?, 0-padded)
+        _ch_total = len(channel_map)
+        _nw = len(str(_ch_total))  # ?먮┸??+        for idx, label in enumerate(channel_map, 1):
+            item = QListWidgetItem(f"{idx:0{_nw}d}. {label}")
+            item.setFlags(item.flags() | Qt.ItemFlag.ItemIsUserCheckable)
+            item.setCheckState(Qt.CheckState.Checked)
+            item.setForeground(QColor(channel_map[label]['color']))
+            item.setToolTip(label)
+            ch_list.addItem(item)
+        
+        # ?섏씠?쇱씠???곹깭 異붿쟻 (?ㅼ쨷 ?좏깮)
+        highlight_state = {'active': set(), 'enabled': False}
+        
+        DIM_COLOR = '#CCCCCC'
+        DIM_ALPHA = 0.15
+        NORMAL_ALPHA = THEME['SCATTER_ALPHA']
+        
+        # ?? artist蹂??먮옒 ?됱긽 ?ㅻ깄?????(蹂듭썝?? ??
+        _orig_colors = {}  # id(art) ??{'fc': array, 'ec': array}
+        for lbl, info in channel_map.items():
+            for art in info['artists']:
+                _orig_colors[id(art)] = {
+                    'fc': art.get_facecolors().copy(),
+                    'ec': art.get_edgecolors().copy(),
+                }
+        
+        def _restore_all():
+            """紐⑤뱺 梨꾨꼸???먮옒 ?됱긽/?뚰뙆濡?蹂듭썝 (artist蹂?"""
+            for lbl, info in channel_map.items():
+                for art in info['artists']:
+                    orig = _orig_colors.get(id(art))
+                    # alpha瑜?癒쇱? ?ㅼ젙 ??set_facecolors媛 ?щ컮瑜?alpha濡?泥섎━
+                    art.set_alpha(NORMAL_ALPHA)
+                    if orig is not None:
+                        art.set_facecolors(orig['fc'].copy())
+                        art.set_edgecolors(orig['ec'].copy())
+                    art.set_zorder(3)
+            highlight_state['active'] = set()
+        
+        def _apply_highlight():
+            """?꾩옱 active set 湲곗??쇰줈 ?섏씠?쇱씠?????곸슜"""
+            selected = highlight_state['active']
+            if not selected:
+                # ?좏깮 ?놁쓬 ??紐⑤몢 dim ?좎?
+                for lbl, info in channel_map.items():
+                    for art in info['artists']:
+                        orig = _orig_colors.get(id(art))
+                        is_filled = True
+                        if orig is not None:
+                            is_filled = len(orig['fc']) > 0 and orig['fc'][0][3] > 0.01
+                        if is_filled:
+                            art.set_facecolors(DIM_COLOR)
+                        art.set_edgecolors(DIM_COLOR)
+                        art.set_alpha(DIM_ALPHA)
+                        art.set_zorder(1)
+                canvas.draw()
+                return
+            for lbl, info in channel_map.items():
+                if lbl in selected:
+                    for art in info['artists']:
+                        orig = _orig_colors.get(id(art))
+                        art.set_alpha(1.0)
+                        if orig is not None:
+                            art.set_facecolors(orig['fc'].copy())
+                            art.set_edgecolors(orig['ec'].copy())
+                        art.set_zorder(10)
+                else:
+                    for art in info['artists']:
+                        orig = _orig_colors.get(id(art))
+                        is_filled = True
+                        if orig is not None:
+                            is_filled = len(orig['fc']) > 0 and orig['fc'][0][3] > 0.01
+                        if is_filled:
+                            art.set_facecolors(DIM_COLOR)
+                        art.set_edgecolors(DIM_COLOR)
+                        art.set_alpha(DIM_ALPHA)
+                        art.set_zorder(1)
+            canvas.draw()
+        
+        def _highlight_channel(selected_label):
+            """梨꾨꼸 ?좉?: ?꾩껜 ?섏씠?쇱씠??ON?대㈃ ?댁젣 ???대┃ 梨꾨꼸留?dim"""
+            if not highlight_state['enabled']:
+                # ?꾩껜 ?섏씠?쇱씠??ON ??泥댄겕諛뺤뒪 ?댁젣, ?대┃??梨꾨꼸留?dim
+                chk_hl_all.setChecked(False)  # _on_hl_all ???꾩껜 dim + enabled=True
+                highlight_state['active'] = set(channel_map.keys()) - {selected_label}
+                _apply_highlight()
+                return
+            active = highlight_state['active']
+            if selected_label in active:
+                active.discard(selected_label)
+            else:
+                active.add(selected_label)
+            _apply_highlight()
+        
+        def _strip_numbering(text):
+            """'1. label' ??'label' (?섎쾭留??묐몢???쒓굅)"""
+            return _re.sub(r'^\d+\.\s*', '', text)
+        
+        def on_item_clicked(item):
+            """媛쒕퀎 梨꾨꼸 ?섏씠?쇱씠???좉?"""
+            label = _strip_numbering(item.text())
+            _highlight_channel(label)
+        
+        def on_item_changed(item):
+            """媛쒕퀎 梨꾨꼸 ?쒖떆/?④?"""
+            label = _strip_numbering(item.text())
+            visible = item.checkState() == Qt.CheckState.Checked
+            if label in channel_map:
+                for art in channel_map[label]['artists']:
+                    art.set_visible(visible)
+            canvas.draw()
+        
+        ch_list.itemClicked.connect(on_item_clicked)
+        ch_list.itemChanged.connect(on_item_changed)
+        
+        # --- ?꾩껜 ?쒖떆 / ?꾩껜 ?섏씠?쇱씠??泥댄겕諛뺤뒪 ---
+        _chk_guard = {'updating': False}
+        
+        _compact_chk = "font-size: 12px; padding: 0; margin: 0;"
+        chk_show_all = QCheckBox("?꾩껜 ?쒖떆")
+        chk_show_all.setChecked(True)
+        chk_show_all.setStyleSheet(_compact_chk + " font-weight: bold;")
+        chk_hl_all = QCheckBox("?꾩껜 ?섏씠?쇱씠??)
+        chk_hl_all.setChecked(True)
+        chk_hl_all.setStyleSheet(_compact_chk)
+        
+        def _on_show_all(state):
+            if _chk_guard['updating']: return
+            _chk_guard['updating'] = True
+            checked = state == Qt.CheckState.Checked.value
+            for i in range(ch_list.count()):
+                ch_list.item(i).setCheckState(Qt.CheckState.Checked if checked else Qt.CheckState.Unchecked)
+            _chk_guard['updating'] = False
+        
+        def _on_hl_all(state):
+            checked = state == Qt.CheckState.Checked.value
+            highlight_state['enabled'] = not checked  # OFF????媛쒕퀎 ?좏깮 ?쒖꽦??+            if checked:
+                # 泥댄겕 ON: 紐⑤뱺 梨꾨꼸 ?먮옒 ?됱긽 蹂듭썝
+                _restore_all()
+                canvas.draw()
+            else:
+                # 泥댄겕 OFF: 紐⑤뱺 梨꾨꼸 ?뚯깋(dim), ?대┃?쇰줈 媛쒕퀎 ?좏깮
+                highlight_state['active'] = set()
+                # 紐⑤몢 dim 泥섎━
+                for lbl, info in channel_map.items():
+                    for art in info['artists']:
+                        orig = _orig_colors.get(id(art))
+                        is_filled = True
+                        if orig is not None:
+                            is_filled = len(orig['fc']) > 0 and orig['fc'][0][3] > 0.01
+                        if is_filled:
+                            art.set_facecolors(DIM_COLOR)
+                        art.set_edgecolors(DIM_COLOR)
+                        art.set_alpha(DIM_ALPHA)
+                        art.set_zorder(1)
+                canvas.draw()
+        
+        chk_show_all.stateChanged.connect(_on_show_all)
+        chk_hl_all.stateChanged.connect(_on_hl_all)
+        
+        # --- ?덉쟾??ON/OFF ---
+        legend_checkbox = QCheckBox("Legend")
+        legend_checkbox.setChecked(True)
+        legend_checkbox.setStyleSheet(_compact_chk)
+        
+        def toggle_legend(state):
+            for ax in axes_list:
+                legend = ax.get_legend()
+                if legend:
+                    legend.set_visible(state == Qt.CheckState.Checked.value)
+            canvas.draw_idle()
+        
+        legend_checkbox.stateChanged.connect(toggle_legend)
+        
+        # --- ?꾩껜 ?덉씠?꾩썐: legend + 梨꾨꼸 洹몃９ ---
+        list_col = QVBoxLayout()
+        list_col.setSpacing(1)
+        list_lbl = QLabel(f"梨꾨꼸 洹몃９ ({_ch_total})")
+        list_lbl.setStyleSheet("font-size: 12px; font-weight: bold; padding: 0; margin: 0;")
+        list_col.addWidget(list_lbl)
+        list_col.addWidget(chk_show_all)
+        list_col.addWidget(chk_hl_all)
+        list_col.addWidget(ch_list)
+        
+        # legend 泥댄겕諛뺤뒪
+        ctrl_col = QVBoxLayout()
+        ctrl_col.setSpacing(1)
+        ctrl_col.addWidget(legend_checkbox)
+        ctrl_col.addStretch()
+        
+        overlay_layout.addLayout(ctrl_col)
+        overlay_layout.addLayout(list_col)
+        
+        # --- 2) ?쒕툕 梨꾨꼸 由ъ뒪??(sub_channel_map ?덉쓣 ?뚮쭔) ---
+        if sub_channel_map and len(sub_channel_map) > 1:
+            sub_list = QListWidget()
+            sub_list.setMinimumWidth(120)
+            sub_list.setMaximumWidth(200)
+            sub_list.setStyleSheet(_list_style)
+            
+            _sub_total = len(sub_channel_map)
+            _snw = len(str(_sub_total))
+            for idx, label in enumerate(sub_channel_map, 1):
+                item = QListWidgetItem(f"{idx:0{_snw}d}. {label}")
+                item.setFlags(item.flags() | Qt.ItemFlag.ItemIsUserCheckable)
+                item.setCheckState(Qt.CheckState.Checked)
+                item.setForeground(QColor(sub_channel_map[label]['color']))
+                item.setToolTip(label)
+                sub_list.addItem(item)
+            
+            # ?? 梨꾨꼸 洹몃９ ???쒕툕 梨꾨꼸 ?곕룞 (?쒖떆/?④?) ??
+            _sub_chk_guard = {'updating': False}
+            
+            def _get_sub_items_for_group(group_label):
+                """梨꾨꼸 洹몃９???랁븳 ?쒕툕 梨꾨꼸 ??ぉ 由ъ뒪??諛섑솚"""
+                result = []
+                for i in range(sub_list.count()):
+                    sub_item = sub_list.item(i)
+                    sub_label = _strip_numbering(sub_item.text())
+                    if sub_label in sub_channel_map:
+                        if sub_channel_map[sub_label].get('parent') == group_label:
+                            result.append((sub_item, sub_label))
+                return result
+            
+            # on_item_changed ?ъ젙?? 梨꾨꼸 洹몃９ ?쒖떆/?④? ???섏쐞 ?쒕툕 梨꾨꼸???곕룞
+            ch_list.itemChanged.disconnect(on_item_changed)
+            
+            def on_item_changed_linked(item):
+                """梨꾨꼸 洹몃９ ?쒖떆/?④? ???섏쐞 ?쒕툕 梨꾨꼸???④퍡 蹂寃?""
+                label = _strip_numbering(item.text())
+                visible = item.checkState() == Qt.CheckState.Checked
+                if label in channel_map:
+                    for art in channel_map[label]['artists']:
+                        art.set_visible(visible)
+                # ?섏쐞 ?쒕툕 梨꾨꼸 ??ぉ 泥댄겕 ?곹깭???숆린??+                if not _sub_chk_guard['updating']:
+                    _sub_chk_guard['updating'] = True
+                    for sub_item, sub_label in _get_sub_items_for_group(label):
+                        sub_item.setCheckState(
+                            Qt.CheckState.Checked if visible else Qt.CheckState.Unchecked)
+                    _sub_chk_guard['updating'] = False
+                canvas.draw()
+            
+            ch_list.itemChanged.connect(on_item_changed_linked)
+            
+            # on_item_clicked ?ъ젙?? 梨꾨꼸 洹몃９ ?섏씠?쇱씠?????섏쐞 ?쒕툕 梨꾨꼸???곕룞
+            ch_list.itemClicked.disconnect(on_item_clicked)
+            
+            def on_item_clicked_linked(item):
+                """梨꾨꼸 洹몃９ ?섏씠?쇱씠???좉? ???섏쐞 ?쒕툕 梨꾨꼸???④퍡 蹂寃?""
+                label = _strip_numbering(item.text())
+                _highlight_channel(label)
+            
+            ch_list.itemClicked.connect(on_item_clicked_linked)
+            
+            # ?쒕툕 梨꾨꼸 ?대┃/泥댄겕 ?몃뱾??(?섏쐞 媛쒕퀎 ?쒖뼱)
+            def on_sub_item_clicked(item):
+                """?쒕툕 梨꾨꼸 媛쒕퀎 ?섏씠?쇱씠???좉?"""
+                if not highlight_state['enabled']:
+                    # ?꾩껜 ?섏씠?쇱씠??ON ??泥댄겕諛뺤뒪 ?댁젣, ?대┃???쒕툕梨꾨꼸留?dim
+                    chk_hl_all.setChecked(False)  # _on_hl_all ???꾩껜 dim + enabled=True
+                    # 紐⑤뱺 梨꾨꼸 ?섏씠?쇱씠???곸슜
+                    highlight_state['active'] = set(channel_map.keys())
+                    _apply_highlight()
+                    # ?대┃???쒕툕 梨꾨꼸留?dim 泥섎━
+                label = _strip_numbering(item.text())
+                if label not in sub_channel_map:
+                    return
+                info = sub_channel_map[label]
+                active = highlight_state['active']
+                parent = info.get('parent', '')
+                # 遺紐?洹몃９???섏씠?쇱씠?몄뿉 ?ы븿?섏뼱 ?덉쑝硫???遺紐⑤? 鍮쇨퀬 媛숈? 洹몃９???ㅻⅨ ?쒕툕留?異붽?
+                # 遺紐?洹몃９???놁쑝硫????쒕툕 梨꾨꼸 ?⑤룆 ?좉?
+                # ?쒕툕 梨꾨꼸 媛쒕퀎 artist瑜?吏곸젒 ?쒖뼱
+                artists = info['artists']
+                # ?좉?: ?꾩옱 ?섏씠?쇱씠???곹깭 ?뺤씤 (alpha 湲곗?)
+                is_highlighted = any(art.get_alpha() == 1.0 for art in artists)
+                if is_highlighted:
+                    # dim 泥섎━
+                    for art in artists:
+                        orig = _orig_colors.get(id(art))
+                        is_filled = True
+                        if orig is not None:
+                            is_filled = len(orig['fc']) > 0 and orig['fc'][0][3] > 0.01
+                        if is_filled:
+                            art.set_facecolors(DIM_COLOR)
+                        art.set_edgecolors(DIM_COLOR)
+                        art.set_alpha(DIM_ALPHA)
+                        art.set_zorder(1)
+                else:
+                    # ?섏씠?쇱씠??泥섎━
+                    for art in artists:
+                        orig = _orig_colors.get(id(art))
+                        art.set_alpha(1.0)
+                        if orig is not None:
+                            art.set_facecolors(orig['fc'].copy())
+                            art.set_edgecolors(orig['ec'].copy())
+                        art.set_zorder(10)
+                canvas.draw()
+            
+            def on_sub_item_changed(item):
+                """?쒕툕 梨꾨꼸 媛쒕퀎 ?쒖떆/?④?"""
+                if _sub_chk_guard['updating']:
+                    return
+                label = _strip_numbering(item.text())
+                visible = item.checkState() == Qt.CheckState.Checked
+                if label in sub_channel_map:
+                    for art in sub_channel_map[label]['artists']:
+                        art.set_visible(visible)
+                canvas.draw()
+            
+            sub_list.itemClicked.connect(on_sub_item_clicked)
+            sub_list.itemChanged.connect(on_sub_item_changed)
+            
+            # ?쒕툕 梨꾨꼸 ???덉씠?꾩썐 (?꾩껜 ?쒖떆/?섏씠?쇱씠??泥댄겕諛뺤뒪 ?놁쓬)
+            sub_list_col = QVBoxLayout()
+            sub_list_col.setSpacing(1)
+            sub_list_lbl = QLabel(f"?쒕툕 梨꾨꼸 ({_sub_total})")
+            sub_list_lbl.setStyleSheet("font-size: 12px; font-weight: bold; padding: 0; margin: 0;")
+            sub_list_col.addWidget(sub_list_lbl)
+            sub_list_col.addWidget(sub_list)
+            
+            overlay_layout.addLayout(sub_list_col)
+        
+        # ?? ?ㅻ쾭?덉씠 ?꾩튂 議곗젙 (?꾩そ?쇰줈 ?쇱묠) ??
+        def _reposition_overlay():
+            """?곗륫 ?곷떒?먯꽌 ?꾨옒濡??쇱퀜吏???ㅻ쾭?덉씠"""
+            if overlay.isVisible():
+                overlay.adjustSize()
+                ow = min(overlay.sizeHint().width() + 8, parent_tab.width() - 8)
+                oh = overlay.sizeHint().height()
+                btn_top = toggle_btn.mapTo(parent_tab, QPoint(0, 0))
+                max_h = btn_top.y() - 4  # ?좉? 踰꾪듉 ?꾧퉴吏 理쒕? ?믪씠
+                if oh > max_h and max_h > 60:
+                    oh = max_h
+                overlay.setFixedSize(ow, oh)
+                overlay_y = btn_top.y() - oh - 2
+                if overlay_y < 0:
+                    overlay_y = 0
+                overlay_x = parent_tab.width() - ow - 4
+                overlay.move(overlay_x, overlay_y)
+                overlay.raise_()
+        
+        def _toggle_panel():
+            vis = not overlay.isVisible()
+            overlay.setVisible(vis)
+            toggle_btn.setText("??CH" if vis else "??CH")
+            if vis:
+                _reposition_overlay()
+        
+        toggle_btn.clicked.connect(_toggle_panel)
+        close_btn.clicked.connect(_toggle_panel)
+        
+        # ?? 由ъ궗?댁쫰 異붿쟻 + ?ㅻ쾭?덉씠 ?몃? ?대┃ ???묎린 ??
+        class _OverlayEventFilter(QObject):
+            def eventFilter(self, obj, event):
+                if event.type() == QEvent.Type.Resize:
+                    _reposition_overlay()
+                elif event.type() == QEvent.Type.MouseButtonPress:
+                    if overlay.isVisible():
+                        # ?대┃ ?꾩튂媛 ?ㅻ쾭?덉씠/?좉?踰꾪듉 ?곸뿭 諛뽰씠硫??묎린
+                        click_pos = event.position().toPoint() if hasattr(event, 'position') else event.pos()
+                        overlay_rect = overlay.geometry()
+                        btn_rect = toggle_btn.geometry()
+                        if not overlay_rect.contains(click_pos) and not btn_rect.contains(click_pos):
+                            _toggle_panel()
+                return False
+        
+        _rf = _OverlayEventFilter(parent_tab)
+        parent_tab.installEventFilter(_rf)
+        # GC 諛⑹?: ?좉? 踰꾪듉??李몄“ 蹂닿?
+        toggle_btn._overlay_ref = overlay
+        toggle_btn._resize_filter_ref = _rf
+        
+        return toggle_btn
+    
+    def _finalize_cycle_tab(self, tab, tab_layout, canvas, toolbar, tab_no, 
+                            channel_map, fig, axes_list, sub_channel_map=None):
+        """
+        Cycle ??理쒖쥌??- 梨꾨꼸 ?쒖뼱 ?꾩젽 ?ы븿 (?ㅻ쾭?덉씠 諛⑹떇)
+        """
+        from PyQt6.QtWidgets import QHBoxLayout
+        # 梨꾨꼸???덉쓣 ?뚮쭔 ?쒖뼱 ?꾩젽 異붽? (?좉? 踰꾪듉留??덉씠?꾩썐???ㅼ뼱媛?
+        if channel_map:
+            toggle_btn = self._create_cycle_channel_control(
+                channel_map, canvas, fig, axes_list, args_parent_tab=tab,
+                sub_channel_map=sub_channel_map)
+            # toolbar + toggle_btn ????以꾩뿉 諛곗튂
+            toolbar_row = QHBoxLayout()
+            toolbar_row.setContentsMargins(0, 0, 0, 0)
+            toolbar_row.setSpacing(4)
+            toolbar_row.addWidget(toolbar)
+            toolbar_row.addWidget(toggle_btn)
+            tab_layout.addLayout(toolbar_row)
+        else:
+            tab_layout.addWidget(toolbar)
+        tab_layout.addWidget(canvas)
+        self.cycle_tab.addTab(tab, str(tab_no))
+        self.cycle_tab.setCurrentWidget(tab)
+        plt.tight_layout(pad=1, w_pad=1, h_pad=1)
+
+    def _finalize_plot_tab(self, tab, tab_layout, canvas, toolbar, tab_no):
+        """
+        ??理쒖쥌
+        """
+        tab_layout.addWidget(toolbar)
+        tab_layout.addWidget(canvas)
+        self.cycle_tab.addTab(tab, str(tab_no))
+        self.cycle_tab.setCurrentWidget(tab)
+        if getattr(self, '_has_colorbar', False):
+            plt.tight_layout(pad=1, w_pad=1, h_pad=1, rect=[0, 0, 0.88, 1])
+            self._has_colorbar = False
+        else:
+            plt.tight_layout(pad=1, w_pad=1, h_pad=1)
+    
+    def _setup_legend(self, axes_list, data_name, positions, fig=None):
+        """
+        踰붾? ?ㅼ젙 - ??ぉ ?섏뿉 ?곕씪 ?먮룞 ?꾪솚
+        fig媛 ?꾨떖?섍퀬 踰붾? ??ぉ??LEGEND_THRESHOLD ?댁긽?대㈃ 洹몃씪?곗씠??而щ윭諛붾줈 ?꾪솚
+        """
+        # 踰붾? ??ぉ ???먮룞 媛먯? (ax.get_lines()濡??뚮’???쇱씤留?諛섑솚??
+        n_items = 0
+        if fig is not None:
+            counts = []
+            for ax in axes_list:
+                n_lines = len(ax.get_lines())
+                if n_lines > 0:
+                    counts.append(n_lines)
+            n_items = min(counts) if counts else 0
+        
+        if n_items >= LEGEND_THRESHOLD and fig is not None:
+            # 紐⑤뱶蹂?而щ윭留??먮룞 ?좏깮
+            if self.AllProfile.isChecked():
+                cmap_name = 'turbo'
+                legend_title = 'Cell 횞 Cycle'
+            elif self.CycProfile.isChecked():
+                cmap_name = 'viridis'
+                legend_title = 'Cycle'
+            else:
+                cmap_name = 'tab20' if n_items <= 20 else 'hsv'
+                legend_title = 'Channel'
+            
+            cmap = plt.colormaps[cmap_name]
+            norm_val = max(n_items - 1, 1)
+            # 紐⑤뱺 異뺤쓽 紐⑤뱺 ?뚮’ ?쇱씤??洹몃씪?곗씠???됱긽 ?곸슜
+            for ax in axes_list:
+                lines = ax.get_lines()
+                if len(lines) == 0:
+                    continue
+                for idx, line in enumerate(lines):
+                    item_idx = min(idx, n_items - 1)
+                    color = cmap(item_idx / norm_val)
+                    line.set_color(color)
+                    line.set_label('')
+            
+            # 湲곗〈 踰붾? ?쒓굅 (?붿뿬 踰붾?媛 ?⑥? ?딅룄濡?
+            for ax in axes_list:
+                legend = ax.get_legend()
+                if legend:
+                    legend.remove()
+            
+            # 而щ윭諛?異붽?
+            cbar_ax = fig.add_axes([0.90, 0.10, 0.02, 0.78])
+            norm = mcolors.Normalize(vmin=0, vmax=n_items - 1)
+            sm = cm.ScalarMappable(cmap=cmap, norm=norm)
+            sm.set_array([])
+            cb = fig.colorbar(sm, cax=cbar_ax)
+            cb.set_label(legend_title + f' ({n_items})', fontsize=THEME['TICK_SIZE'])
+            self._has_colorbar = True
+            # ?됱긽 蹂寃쎌쓣 罹붾쾭?ㅼ뿉 利됱떆 諛섏쁺
+            fig.canvas.draw()
+        else:
+            # 湲곗〈 踰붾?
+            _leg_kw = dict(fontsize=THEME['LEGEND_SIZE'],
+                           framealpha=THEME['LEGEND_FRAMEALPHA'],
+                           edgecolor=THEME['LEGEND_EDGECOLOR'],
+                           fancybox=True)
+            if len(data_name) != 0:
+                for ax, pos in zip(axes_list, positions):
+                    ax.legend(loc=pos, **_leg_kw)
+            else:
+                plt.legend(loc="center left", bbox_to_anchor=(1, 0.5), **_leg_kw)
     
     def _load_step_batch_task(self, task_info):
         """
@@ -8558,11 +9332,88 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         
         return results
     
+    # ??? 踰붿슜 ?꾨줈?뚯씪 諛곗튂 蹂묐젹 濡쒕뜑 ???
+    def _load_profile_batch_task(self, task_info):
+        """
+        梨꾨꼸 ?⑥쐞 ?꾨줈?뚯씪 諛곗튂 濡쒕뵫 (ThreadPoolExecutor??.
+        profile_type: 'rate' | 'chg' | 'dchg' | 'continue'
+        """
+        folder_path, profile_type, params, is_pne, folder_idx, subfolder_idx = task_info
+        try:
+            if profile_type == 'rate':
+                cycle_list, mincapacity, cutoff, inirate = params
+                if is_pne:
+                    batch_results = pne_rate_Profile_batch(folder_path, cycle_list, mincapacity, cutoff, inirate)
+                else:
+                    batch_results = toyo_rate_Profile_batch(folder_path, cycle_list, mincapacity, cutoff, inirate)
+            elif profile_type == 'chg':
+                cycle_list, mincapacity, cutoff, inirate, smoothdegree = params
+                if is_pne:
+                    batch_results = pne_chg_Profile_batch(folder_path, cycle_list, mincapacity, cutoff, inirate, smoothdegree)
+                else:
+                    batch_results = toyo_chg_Profile_batch(folder_path, cycle_list, mincapacity, cutoff, inirate, smoothdegree)
+            elif profile_type == 'dchg':
+                cycle_list, mincapacity, cutoff, inirate, smoothdegree = params
+                if is_pne:
+                    batch_results = pne_dchg_Profile_batch(folder_path, cycle_list, mincapacity, cutoff, inirate, smoothdegree)
+                else:
+                    batch_results = toyo_dchg_Profile_batch(folder_path, cycle_list, mincapacity, cutoff, inirate, smoothdegree)
+            elif profile_type == 'continue':
+                step_ranges, mincapacity, inirate, CDstate = params
+                if is_pne:
+                    batch_results = pne_continue_Profile_batch(folder_path, step_ranges, mincapacity, inirate, CDstate)
+                else:
+                    batch_results = toyo_continue_Profile_batch(folder_path, step_ranges, mincapacity, inirate)
+            else:
+                return (folder_idx, subfolder_idx, None)
+            return (folder_idx, subfolder_idx, batch_results)
+        except Exception as e:
+            print(f"[諛곗튂 濡쒕뵫 ?ㅻ쪟] {profile_type} {folder_path}: {e}")
+            return (folder_idx, subfolder_idx, None)
+
+    def _load_all_profile_data_parallel(self, all_data_folder, profile_type, params, max_workers=4):
+        """
+        紐⑤뱺 ?대뜑???꾨줈?뚯씪 ?곗씠?곕? 蹂묐젹濡?濡쒕뵫 (踰붿슜).
+        profile_type: 'rate' | 'chg' | 'dchg' | 'continue'
+        params: ?꾨줈?뚯씪 ??낅퀎 ?뚮씪誘명꽣 ?쒗뵆
+        Returns: {(folder_idx, subfolder_idx, key): data, ...}
+          - rate/chg/dchg: key = cycle_no
+          - continue: key = (start, end) ?쒗뵆
+        """
+        tasks = []
+        for i, cyclefolder in enumerate(all_data_folder):
+            if os.path.isdir(cyclefolder):
+                subfolder = [f.path for f in os.scandir(cyclefolder) if f.is_dir()]
+                is_pne = check_cycler(cyclefolder)
+                for j, folder_path in enumerate(subfolder):
+                    if "Pattern" not in folder_path:
+                        task = (folder_path, profile_type, params, is_pne, i, j)
+                        tasks.append(task)
+
+        results = {}
+        total_tasks = len(tasks)
+        completed = 0
+        if total_tasks == 0:
+            return results
+
+        with ThreadPoolExecutor(max_workers=max_workers) as executor:
+            futures = {executor.submit(self._load_profile_batch_task, task): task for task in tasks}
+            for future in as_completed(futures):
+                result = future.result()
+                if result:
+                    folder_idx, subfolder_idx, batch_results = result
+                    if batch_results:
+                        for key, data in batch_results.items():
+                            results[(folder_idx, subfolder_idx, key)] = data
+                completed += 1
+                self.progressBar.setValue(int(completed / total_tasks * 50))
+
+        return results
+
     def _plot_and_save_step_data(self, axes, stepchg, capacity, headername, lgnd, temp_lgnd,
                                   writer, write_column_num, save_file_name, Step_CycNo, save_csv=False):
         """
-        ?ㅽ뀦 ?꾨줈?뚯씪 6媛?洹몃옒???뚮’ + ?곗씠?????怨듯넻 濡쒖쭅
-        axes: (step_ax1, step_ax2, step_ax3, step_ax4, step_ax5, step_ax6)
+        ?ㅽ뀦 ?꾨줈?뚯씪 6媛?洹몃옒???뚮’ + ?곗씠?????
         """
         step_ax1, step_ax2, step_ax3, step_ax4, step_ax5, step_ax6 = axes
         
@@ -8650,6 +9501,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         return results
     
     def cyc_ini_set(self):
+        set_coincell_mode(self.chk_coincell_cyc.isChecked())
         # UI 湲곗? 珥덇린 ?ㅼ젙 ?곗씠??         firstCrate = float(self.ratetext.text())
         if self.inicaprate.isChecked():
@@ -8736,8 +9588,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         self.AppCycState = True
         self.AppCycConfirm.setDisabled(True)
         firstCrate, mincapacity, xscale, ylimithigh, ylimitlow, irscale = self.cyc_ini_set()
-        graphcolor = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22',
-                      '#17becf', ]
+        graphcolor = THEME['PALETTE']
         filecount,colorno , columncount = 0, 0, 0
         dfoutput = pd.DataFrame()
         col_name_output = []
@@ -8815,7 +9666,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
             dfoutput.to_excel(writer, sheet_name="Approval_cycle", header = col_name_output)
             writer.close()
         if filename != "":
-            plt.suptitle(filename, fontsize= 15, fontweight='bold')
+            plt.suptitle(filename, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
             plt.legend(loc="upper right")
             plt.tight_layout(pad=1, w_pad=1, h_pad=1)
             self.progressBar.setValue(100)
@@ -8848,8 +9699,8 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
             if save_file_name:
                 writer = pd.ExcelWriter(save_file_name, engine="xlsxwriter")
         self.indiv_cycle.setEnabled(True)
-        
-        graphcolor = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf']
+            
+        graphcolor = THEME['PALETTE']
         
         # ?곗씠??濡쒕뵫 (蹂묐젹 泥섎━)
         self.progressBar.setValue(0)
@@ -8858,12 +9709,11 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
             self.dcirchk.isChecked(), self.dcirchk_2.isChecked(), self.mkdcir.isChecked(),
             max_workers=4
         )
-        
 
         tab_no = 0
         j = 0
         total_folders = len(all_data_folder)
-        
+            
         for i, cyclefolder in enumerate(all_data_folder):
             fig, ((ax1, ax2, ax3), (ax4, ax5, ax6)) = plt.subplots(nrows=2, ncols=3, figsize=(14, 8))
             
@@ -8874,6 +9724,8 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
             toolbar = None
             cycnamelist = None
             has_valid_data = False
+            channel_map = {}  # 梨꾨꼸 ?쒖뼱??artist ?섏쭛
+            sub_channel_map = {}  # ?쒕툕 梨꾨꼸蹂?artist ?섏쭛
             
             if os.path.exists(cyclefolder):
                 subfolder = [f.path for f in os.scandir(cyclefolder) if f.is_dir()]
@@ -8922,8 +9774,27 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                         if irscale == 0 and cyctemp[0] != 0:
                             irscale = int(1/(cyctemp[0]/5000) + 1)//2 * 2
                         
-                        graph_output_cycle(cyctemp[1], xscale, ylimitlow, ylimithigh, irscale, lgnd, lgnd, colorno,
+                        _artists, _color = graph_output_cycle(cyctemp[1], xscale, ylimitlow, ylimithigh, irscale, lgnd, lgnd, colorno,
                                            graphcolor, self.mkdcir, ax1, ax2, ax3, ax4, ax5, ax6)
+                        ch_label = lgnd if lgnd else cycnamelist[-1]
+                        # ?숈씪 ?쇰꺼-?ㅻⅨ ?됱긽 異⑸룎 ??怨좎쑀 ?쇰꺼 ?앹꽦
+                        _base = ch_label
+                        _sfx = 2
+                        while ch_label in channel_map and channel_map[ch_label]['color'] != _color:
+                            ch_label = f"{_base} ({_sfx})"
+                            _sfx += 1
+                        if ch_label in channel_map:
+                            channel_map[ch_label]['artists'].extend(_artists)
+                        else:
+                            channel_map[ch_label] = {'artists': _artists, 'color': _color}
+                        # ?쒕툕 梨꾨꼸 媛쒕퀎 異붿쟻
+                        sub_label = cycnamelist[-1]
+                        _sub_base = sub_label
+                        _sub_sfx = 2
+                        while sub_label in sub_channel_map:
+                            sub_label = f"{_sub_base} ({_sub_sfx})"
+                            _sub_sfx += 1
+                        sub_channel_map[sub_label] = {'artists': list(_artists), 'color': _color, 'parent': ch_label}
                         colorno = colorno + 1
                         
                         # Data output option
@@ -8954,7 +9825,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                             output_data(cyctemp[1].NewData, "異⑸갑?꾧린CY", writecolno, 0, "OriCyc", headername)
                             writecolno = writecolno + 1
                     
-                    plt.suptitle(cycnamelist[-2], fontsize=15, fontweight='bold')
+                    plt.suptitle(cycnamelist[-2], fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
                     ax1.legend(loc="lower left")
                     ax2.legend(loc="lower right")
                     ax3.legend(loc="upper right")
@@ -8964,12 +9835,10 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                 
                 # [?섏젙] ?좏슚???곗씠?곌? ?덈뒗 寃쎌슦?먮쭔 ??異붽?
                 if has_valid_data and tab_layout is not None:
-                    tab_layout.addWidget(toolbar)
-                    tab_layout.addWidget(canvas)
-                    self.cycle_tab.addTab(tab, str(tab_no))
-                    self.cycle_tab.setCurrentWidget(tab)
+                    axes_list = [ax1, ax2, ax3, ax4, ax5, ax6]
+                    self._finalize_cycle_tab(tab, tab_layout, canvas, toolbar, tab_no,
+                                             channel_map, fig, axes_list)
                     tab_no = tab_no + 1
-                    plt.tight_layout(pad=1, w_pad=1, h_pad=1)
                     if cycnamelist:
                         output_fig(self.figsaveok, cycnamelist[-2])
                     colorno = 0
@@ -9006,7 +9875,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                 writer = pd.ExcelWriter(save_file_name, engine="xlsxwriter")
         self.overall_cycle.setEnabled(True)
         
-        graphcolor = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf']
+        graphcolor = THEME['PALETTE']
         
         # ?곗씠??濡쒕뵫 (蹂묐젹 泥섎━)
         self.progressBar.setValue(0)
@@ -9027,6 +9896,8 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         canvas = None
         toolbar = None
         has_valid_data = False
+        channel_map = {}  # 梨꾨꼸 ?쒖뼱??artist ?섏쭛
+        sub_channel_map = {}  # ?쒕툕 梨꾨꼸蹂?artist ?섏쭛
         total_folders = len(all_data_folder)
         
         for i, cyclefolder in enumerate(all_data_folder):
@@ -9081,8 +9952,33 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                             overall_xlimit = len(cyctemp[1].NewData.index)
                         
                         # dcir2, mkdcir 以묐났 ?쒓굅
-                        graph_output_cycle(cyctemp[1], xscale, ylimitlow, ylimithigh, irscale, temp_lgnd, temp_lgnd,
+                        _artists, _color = graph_output_cycle(cyctemp[1], xscale, ylimitlow, ylimithigh, irscale, temp_lgnd, temp_lgnd,
                                            colorno, graphcolor, self.mkdcir, ax1, ax2, ax3, ax4, ax5, ax6)
+                        # ch_label: ?대뜑(LOT) ?⑥쐞 ?대쫫?쇰줈 ?듭씪 (?숈씪 ?대뜑 梨꾨꼸??1媛???ぉ?쇰줈 臾띠쓬)
+                        if len(all_data_name) != 0:
+                            ch_label = all_data_name[i]
+                        else:
+                            ch_label = cycnamelist[-2].split('_')[-1]
+                        if len(ch_label) > 20:
+                            ch_label = ch_label[:20] + "..."
+                        # ?숈씪 ?쇰꺼-?ㅻⅨ ?됱긽 異⑸룎 ??怨좎쑀 ?쇰꺼 ?앹꽦
+                        _base = ch_label
+                        _sfx = 2
+                        while ch_label in channel_map and channel_map[ch_label]['color'] != _color:
+                            ch_label = f"{_base} ({_sfx})"
+                            _sfx += 1
+                        if ch_label in channel_map:
+                            channel_map[ch_label]['artists'].extend(_artists)
+                        else:
+                            channel_map[ch_label] = {'artists': _artists, 'color': _color}
+                        # ?쒕툕 梨꾨꼸 媛쒕퀎 異붿쟻
+                        sub_label = cycnamelist[-1]
+                        _sub_base = sub_label
+                        _sub_sfx = 2
+                        while sub_label in sub_channel_map:
+                            sub_label = f"{_sub_base} ({_sub_sfx})"
+                            _sub_sfx += 1
+                        sub_channel_map[sub_label] = {'artists': list(_artists), 'color': _color, 'parent': ch_label}
                         
                         # Data output option
                         if self.saveok.isChecked() and save_file_name:
@@ -9110,18 +10006,20 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                             else:
                                 output_data(cyctempdcir, "DCIR", writecolno, 0, "dcir", headername)
                             writecolno = writecolno + 1
-                colorno = colorno % 9 + 1
+                colorno = colorno % len(THEME['PALETTE']) + 1
         
         # 踰붾? ?ㅼ젙
+        _lkw = dict(fontsize=THEME['LEGEND_SIZE'], framealpha=THEME['LEGEND_FRAMEALPHA'],
+                    edgecolor=THEME['LEGEND_EDGECOLOR'], fancybox=True)
         if len(all_data_name) != 0:
-            ax1.legend(loc="lower left", fontsize='small', bbox_to_anchor=(0, 0), borderaxespad=0.5)
-            ax2.legend(loc="lower right", fontsize='small', bbox_to_anchor=(1, 0), borderaxespad=0.5)
-            ax3.legend(loc="upper right", fontsize='small', bbox_to_anchor=(1, 1), borderaxespad=0.5)
-            ax4.legend(loc="upper right", fontsize='small', bbox_to_anchor=(1, 1), borderaxespad=0.5)
-            ax5.legend(loc="upper right", fontsize='small', bbox_to_anchor=(1, 1), borderaxespad=0.5)
-            ax6.legend(loc="lower right", fontsize='small', bbox_to_anchor=(1, 0), borderaxespad=0.5)
+            ax1.legend(loc="lower left", bbox_to_anchor=(0, 0), borderaxespad=0.5, **_lkw)
+            ax2.legend(loc="lower right", bbox_to_anchor=(1, 0), borderaxespad=0.5, **_lkw)
+            ax3.legend(loc="upper right", bbox_to_anchor=(1, 1), borderaxespad=0.5, **_lkw)
+            ax4.legend(loc="upper right", bbox_to_anchor=(1, 1), borderaxespad=0.5, **_lkw)
+            ax5.legend(loc="upper right", bbox_to_anchor=(1, 1), borderaxespad=0.5, **_lkw)
+            ax6.legend(loc="lower right", bbox_to_anchor=(1, 0), borderaxespad=0.5, **_lkw)
         else:
-            ax6.legend(loc="lower right", fontsize='small')
+            ax6.legend(loc="lower right", **_lkw)
         
         # ?뚯씪 ???         if overall_filename:
@@ -9132,25 +10030,9 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         
         # ??異붽? (?좏슚 ?곗씠?곌? ?덈뒗 寃쎌슦?먮쭔)
         if has_valid_data and tab_layout is not None:
-            # ?덉쟾?????ㅽ봽 泥댄겕諛뺤뒪 異붽?
-            legend_checkbox = QtWidgets.QCheckBox("Legend ON/OFF")
-            legend_checkbox.setChecked(True)
             axes_list = [ax1, ax2, ax3, ax4, ax5, ax6]
-            
-            def toggle_legend(state):
-                for ax in axes_list:
-                    legend = ax.get_legend()
-                    if legend:
-                        legend.set_visible(state == QtCore.Qt.CheckState.Checked.value)
-                canvas.draw()
-            
-            legend_checkbox.stateChanged.connect(toggle_legend)
-            
-            tab_layout.addWidget(legend_checkbox)
-            tab_layout.addWidget(toolbar)
-            tab_layout.addWidget(canvas)
-            self.cycle_tab.addTab(tab, str(tab_no))
-            self.cycle_tab.setCurrentWidget(tab)
+            self._finalize_cycle_tab(tab, tab_layout, canvas, toolbar, tab_no,
+                                     channel_map, fig, axes_list, sub_channel_map)
             tab_no = tab_no + 1
         else:
             plt.close(fig)
@@ -9183,7 +10065,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                 writer = pd.ExcelWriter(save_file_name, engine="xlsxwriter")
         self.link_cycle.setEnabled(True)
         
-        graphcolor = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf']
+        graphcolor = THEME['PALETTE']
         
         # ?곗씠??濡쒕뵫 (蹂묐젹 泥섎━)
         self.progressBar.setValue(0)
@@ -9205,6 +10087,8 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         toolbar = None
         cycnamelist = None
         has_valid_data = False
+        channel_map = {}  # 梨꾨꼸 ?쒖뼱??artist ?섏쭛
+        sub_channel_map = {}  # ?쒕툕 梨꾨꼸蹂?artist ?섏쭛
         total_folders = len(all_data_folder)
         
         for i, cyclefolder in enumerate(all_data_folder):
@@ -9258,16 +10142,35 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                         else:
                             temp_lgnd = lgnd
                         
-                        graph_output_cycle(cyctemp[1], xscale, ylimitlow, ylimithigh, irscale, lgnd, temp_lgnd, colorno,
+                        _artists, _color = graph_output_cycle(cyctemp[1], xscale, ylimitlow, ylimithigh, irscale, lgnd, temp_lgnd, colorno,
                                            graphcolor, self.mkdcir, ax1, ax2, ax3, ax4, ax5, ax6)
+                        ch_label = temp_lgnd if temp_lgnd else lgnd if lgnd else cycnamelist[-1]
+                        # ?숈씪 ?쇰꺼-?ㅻⅨ ?됱긽 異⑸룎 ??怨좎쑀 ?쇰꺼 ?앹꽦
+                        _base = ch_label
+                        _sfx = 2
+                        while ch_label in channel_map and channel_map[ch_label]['color'] != _color:
+                            ch_label = f"{_base} ({_sfx})"
+                            _sfx += 1
+                        if ch_label in channel_map:
+                            channel_map[ch_label]['artists'].extend(_artists)
+                        else:
+                            channel_map[ch_label] = {'artists': _artists, 'color': _color}
+                        # ?쒕툕 梨꾨꼸 媛쒕퀎 異붿쟻
+                        sub_label = cycnamelist[-1]
+                        _sub_base = sub_label
+                        _sub_sfx = 2
+                        while sub_label in sub_channel_map:
+                            sub_label = f"{_sub_base} ({_sub_sfx})"
+                            _sub_sfx += 1
+                        sub_channel_map[sub_label] = {'artists': list(_artists), 'color': _color, 'parent': ch_label}
                         
                         # Data output option
                         if self.saveok.isChecked() and save_file_name:
-                            output_data(cyctemp[1].NewData, "諛⑹쟾?⑸웾", writecolno, writerowno, "Dchg", headername)
+                            output_data(cyctemp[1].NewData, "諛⑹쟾?⑸웷", writecolno, writerowno, "Dchg", headername)
                             output_data(cyctemp[1].NewData, "Rest End", writecolno, writerowno, "RndV", headername)
                             output_data(cyctemp[1].NewData, "?됯퇏 ?꾩븬", writecolno, writerowno, "AvgV", headername)
                             output_data(cyctemp[1].NewData, "異⑸갑?⑥쑉", writecolno, writerowno, "Eff", headername)
-                            output_data(cyctemp[1].NewData, "異⑹쟾?⑸웾", writecolno, writerowno, "Chg", headername)
+                            output_data(cyctemp[1].NewData, "異⑹쟾?⑸웷", writecolno, writerowno, "Chg", headername)
                             output_data(cyctemp[1].NewData, "諛⑹땐?⑥쑉", writecolno, writerowno, "Eff2", headername)
                             output_data(cyctemp[1].NewData, "諛⑹쟾Energy", writecolno, writerowno, "DchgEng", headername)
                             cyctempdcir = cyctemp[1].NewData.dcir.dropna(axis=0)
@@ -9290,7 +10193,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         # 踰붾? ?ㅼ젙
         if cycnamelist:
             if len(all_data_name) != 0:
-                plt.suptitle(cycnamelist[-2], fontsize=15, fontweight='bold')
+                plt.suptitle(cycnamelist[-2], fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
                 ax1.legend(loc="lower left")
                 ax2.legend(loc="lower right")
                 ax3.legend(loc="upper right")
@@ -9298,15 +10201,14 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                 ax5.legend(loc="upper right")
                 ax6.legend(loc="lower right")
             else:
-                plt.suptitle(cycnamelist[-2], fontsize=15, fontweight='bold')
+                plt.suptitle(cycnamelist[-2], fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
                 plt.legend(loc="center left", bbox_to_anchor=(1, 0.5))
         
         # ??異붽? (?좏슚 ?곗씠?곌? ?덈뒗 寃쎌슦?먮쭔)
         if has_valid_data and tab_layout is not None:
-            tab_layout.addWidget(toolbar)
-            tab_layout.addWidget(canvas)
-            self.cycle_tab.addTab(tab, str(tab_no))
-            self.cycle_tab.setCurrentWidget(tab)
+            axes_list = [ax1, ax2, ax3, ax4, ax5, ax6]
+            self._finalize_cycle_tab(tab, tab_layout, canvas, toolbar, tab_no,
+                                     channel_map, fig, axes_list)
             tab_no = tab_no + 1
             if cycnamelist:
                 output_fig(self.figsaveok, cycnamelist[-2])
@@ -9338,7 +10240,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                 writer = pd.ExcelWriter(save_file_name, engine="xlsxwriter")
         self.link_cycle.setEnabled(True)
         
-        graphcolor = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf']
+        graphcolor = THEME['PALETTE']
         writecolno, colorno, j, writecolnomax = 0, 0, 0, 0
         tab_no = 0
         total_files = len(alldatafilepath)
@@ -9376,6 +10278,8 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
             toolbar = None
             cycnamelist = None
             has_valid_data = False
+            channel_map = {}  # 梨꾨꼸 ?쒖뼱??artist ?섏쭛
+            sub_channel_map = {}  # ?쒕툕 梨꾨꼸蹂?artist ?섏쭛
             total_folders = len(all_data_folder)
             
             for i, cyclefolder in enumerate(all_data_folder):
@@ -9429,8 +10333,26 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                             else:
                                 temp_lgnd = lgnd
                             
-                            graph_output_cycle(cyctemp[1], xscale, ylimitlow, ylimithigh, irscale, lgnd, temp_lgnd, colorno,
+                            _artists, _color = graph_output_cycle(cyctemp[1], xscale, ylimitlow, ylimithigh, irscale, lgnd, temp_lgnd, colorno,
                                                graphcolor, self.mkdcir, ax1, ax2, ax3, ax4, ax5, ax6)
+                            ch_label = temp_lgnd if temp_lgnd else lgnd if lgnd else cycnamelist[-1]
+                            _base = ch_label
+                            _sfx = 2
+                            while ch_label in channel_map and channel_map[ch_label]['color'] != _color:
+                                ch_label = f"{_base} ({_sfx})"
+                                _sfx += 1
+                            if ch_label in channel_map:
+                                channel_map[ch_label]['artists'].extend(_artists)
+                            else:
+                                channel_map[ch_label] = {'artists': _artists, 'color': _color}
+                            # ?쒕툕 梨꾨꼸 媛쒕퀎 異붿쟻
+                            sub_label = cycnamelist[-1]
+                            _sub_base = sub_label
+                            _sub_sfx = 2
+                            while sub_label in sub_channel_map:
+                                sub_label = f"{_sub_base} ({_sub_sfx})"
+                                _sub_sfx += 1
+                            sub_channel_map[sub_label] = {'artists': list(_artists), 'color': _color, 'parent': ch_label}
                             
                             # Data output option
                             if self.saveok.isChecked() and save_file_name:
@@ -9463,7 +10385,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
             # 踰붾? ?ㅼ젙
             if cycnamelist:
                 if len(all_data_name) != 0:
-                    plt.suptitle(cycnamelist[-2], fontsize=15, fontweight='bold')
+                    plt.suptitle(cycnamelist[-2], fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
                     ax1.legend(loc="lower left")
                     ax2.legend(loc="lower right")
                     ax3.legend(loc="upper right")
@@ -9471,17 +10393,15 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                     ax5.legend(loc="upper right")
                     ax6.legend(loc="lower right")
                 else:
-                    plt.suptitle(cycnamelist[-2], fontsize=15, fontweight='bold')
+                    plt.suptitle(cycnamelist[-2], fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
                     plt.legend(loc="center left", bbox_to_anchor=(1, 0.5))
             
             # ??異붽? (?좏슚 ?곗씠?곌? ?덈뒗 寃쎌슦?먮쭔)
             if has_valid_data and tab_layout is not None:
-                tab_layout.addWidget(toolbar)
-                tab_layout.addWidget(canvas)
-                self.cycle_tab.addTab(tab, str(tab_no))
-                self.cycle_tab.setCurrentWidget(tab)
+                axes_list = [ax1, ax2, ax3, ax4, ax5, ax6]
+                self._finalize_cycle_tab(tab, tab_layout, canvas, toolbar, tab_no,
+                                         channel_map, fig, axes_list)
                 tab_no = tab_no + 1
-                plt.tight_layout(pad=1, w_pad=1, h_pad=1)
                 if cycnamelist:
                     output_fig(self.figsaveok, cycnamelist[-2])
             else:
@@ -9512,7 +10432,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                 writer = pd.ExcelWriter(save_file_name, engine="xlsxwriter")
         self.link_cycle.setEnabled(True)
         
-        graphcolor = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf']
+        graphcolor = THEME['PALETTE']
         
         # 紐⑤뱺 ?뚯씪???섎굹???듯빀 洹몃옒?꾩뿉 ?쒖떆
         fig, ((ax1, ax2, ax3), (ax4, ax5, ax6)) = plt.subplots(nrows=2, ncols=3, figsize=(14, 8))
@@ -9527,9 +10447,12 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         toolbar = None
         cycnamelist = None
         has_valid_data = False
+        channel_map = {}  # 梨꾨꼸 ?쒖뼱??artist ?섏쭛
+        sub_channel_map = {}  # ?쒕툕 梨꾨꼸蹂?artist ?섏쭛
         
         for k, datafilepath in enumerate(alldatafilepath):
             folder_cnt, chnl_cnt, writerowno, Chnl_num = 0, 0, 0, 0
+            j = 0  # 媛숈? LOT?쇰━ legend 以묐났 諛⑹???移댁슫??             writecolno = writecolnomax
             CycleMax = [0, 0, 0, 0, 0]
             link_writerownum = [0, 0, 0, 0, 0]
@@ -9585,12 +10508,19 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                         cycnamelist = FolderBase.split("\\")
                         headername = [cycnamelist[-2] + ", " + cycnamelist[-1]]
                         
-                        if len(all_data_name) != 0 and i == 0 and sub_idx == 0:
-                            lgnd = all_data_name[i]
-                        elif len(all_data_name) != 0:
-                            lgnd = ""
+                        # 以묐났?놁씠 媛숈? LOT?쇰━?먯꽌留?legend 異붽?
+                        if len(all_data_name) != 0 and j == i:
+                            temp_lgnd = all_data_name[i]
+                            j = j + 1
+                        elif len(all_data_name) == 0 and j == i:
+                            temp_lgnd = cycnamelist[-2].split('_')[-1]
+                            j = j + 1
                         else:
-                            lgnd = cycnamelist[-1]
+                            temp_lgnd = ""
+                        
+                        # ?덉쟾??湲?먯닔 ?쒗븳 (理쒕? 20??
+                        if len(temp_lgnd) > 20:
+                            temp_lgnd = temp_lgnd[:20] + "..."
                         
                         if hasattr(cyctemp[1], "NewData") and (len(link_writerownum) > Chnl_num):
                             writerowno = link_writerownum[Chnl_num] + CycleMax[Chnl_num]
@@ -9600,13 +10530,33 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                             self.capacitytext.setText(str(cyctemp[0]))
                             if irscale == 0:
                                 irscale = int(1/(cyctemp[0]/5000) + 1)//2 * 2
-                            if len(all_data_name) == 0:
-                                temp_lgnd = ""
-                            else:
-                                temp_lgnd = lgnd
                             
-                            graph_output_cycle(cyctemp[1], xscale, ylimitlow, ylimithigh, irscale, lgnd, temp_lgnd, colorno,
+                            _artists, _color = graph_output_cycle(cyctemp[1], xscale, ylimitlow, ylimithigh, irscale, temp_lgnd, temp_lgnd, colorno,
                                                graphcolor, self.mkdcir, ax1, ax2, ax3, ax4, ax5, ax6)
+                            # ch_label: ?대뜑(LOT) ?⑥쐞 ?대쫫?쇰줈 ?듭씪 (?숈씪 ?대뜑 梨꾨꼸??1媛???ぉ?쇰줈 臾띠쓬)
+                            if len(all_data_name) != 0:
+                                ch_label = all_data_name[i]
+                            else:
+                                ch_label = cycnamelist[-2].split('_')[-1]
+                            if len(ch_label) > 20:
+                                ch_label = ch_label[:20] + "..."
+                            _base = ch_label
+                            _sfx = 2
+                            while ch_label in channel_map and channel_map[ch_label]['color'] != _color:
+                                ch_label = f"{_base} ({_sfx})"
+                                _sfx += 1
+                            if ch_label in channel_map:
+                                channel_map[ch_label]['artists'].extend(_artists)
+                            else:
+                                channel_map[ch_label] = {'artists': _artists, 'color': _color}
+                            # ?쒕툕 梨꾨꼸 媛쒕퀎 異붿쟻
+                            sub_label = cycnamelist[-1]
+                            _sub_base = sub_label
+                            _sub_sfx = 2
+                            while sub_label in sub_channel_map:
+                                sub_label = f"{_sub_base} ({_sub_sfx})"
+                                _sub_sfx += 1
+                            sub_channel_map[sub_label] = {'artists': list(_artists), 'color': _color, 'parent': ch_label}
                             
                             # Data output option
                             if self.saveok.isChecked() and save_file_name:
@@ -9640,7 +10590,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
             # 踰붾? ?ㅼ젙 (留덉?留??뚯씪 泥섎━ ??
             if cycnamelist:
                 if len(all_data_name) != 0:
-                    plt.suptitle(cycnamelist[-2], fontsize=15, fontweight='bold')
+                    plt.suptitle(cycnamelist[-2], fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
                     ax1.legend(loc="lower left")
                     ax2.legend(loc="lower right")
                     ax3.legend(loc="upper right")
@@ -9648,17 +10598,15 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                     ax5.legend(loc="upper right")
                     ax6.legend(loc="lower right")
                 else:
-                    plt.suptitle(cycnamelist[-2], fontsize=15, fontweight='bold')
+                    plt.suptitle(cycnamelist[-2], fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
                     plt.legend(loc="center left", bbox_to_anchor=(1, 0.5))
         
         # ??異붽? (?좏슚 ?곗씠?곌? ?덈뒗 寃쎌슦?먮쭔)
         if has_valid_data and tab_layout is not None:
-            tab_layout.addWidget(toolbar)
-            tab_layout.addWidget(canvas)
-            self.cycle_tab.addTab(tab, str(tab_no))
-            self.cycle_tab.setCurrentWidget(tab)
+            axes_list = [ax1, ax2, ax3, ax4, ax5, ax6]
+            self._finalize_cycle_tab(tab, tab_layout, canvas, toolbar, tab_no,
+                                     channel_map, fig, axes_list, sub_channel_map)
             tab_no = tab_no + 1
-            plt.tight_layout(pad=1, w_pad=1, h_pad=1)
             if cycnamelist:
                 output_fig(self.figsaveok, cycnamelist[-2])
         else:
@@ -9677,25 +10625,32 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         smoothdegree, mincrate, dqscale, dvscale = init_data['smoothdegree'], init_data['mincrate'], init_data['dqscale'], init_data['dvscale']
         all_data_folder, all_data_name = init_data['folders'], init_data['names']
         
-        # [理쒖쟻??#1] global writer ?쒓굅 ??濡쒖뺄 蹂?섎줈留??ъ슜
+        #global writer ?쒓굅 ??濡쒖뺄 蹂?섎줈留??ъ슜
         write_column_num, folder_count, chnlcount, cyccount = 0, 0, 0, 0
         
         # ?⑥닔 ?ъ슜?쇰줈 蹂寃?         writer, save_file_name = self._setup_file_writer()
         
-        # [理쒖쟻??#3] ?곗씠??蹂묐젹 濡쒕뵫 (ThreadPoolExecutor)
+        # ?곗씠??蹂묐젹 濡쒕뵫 (ThreadPoolExecutor)
         self.progressBar.setValue(0)
         loaded_data = self._load_all_step_data_parallel(
             all_data_folder, CycleNo, mincapacity, mincrate, firstCrate, max_workers=4
         )
         
         tab_no = 0
+        all_profile = self.AllProfile.isChecked()
+        # AllProfile: 猷⑦봽 ?꾩뿉 fig/tab 1媛쒕쭔 ?앹꽦
+        if all_profile:
+            fig, ((step_ax1, step_ax2, step_ax3), (step_ax4, step_ax5, step_ax6)) = plt.subplots(
+                nrows=2, ncols=3, figsize=(14, 10))
+            tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
+            last_step_namelist = None
         for i, cyclefolder in enumerate(all_data_folder):
             if os.path.isdir(cyclefolder):
                 subfolder = [f.path for f in os.scandir(cyclefolder) if f.is_dir()]
                 foldercountmax = len(all_data_folder)
                 folder_count += 1
-                # [理쒖쟻??#2] check_cycler 罹먯떛: 媛숈? cyclefolder?????1?뚮쭔 ?몄텧
+                # 媛숈? cyclefolder?????1?뚮쭔 ?몄텧
                 is_pne = check_cycler(cyclefolder)
                 if self.CycProfile.isChecked():
                     for j, FolderBase in enumerate(subfolder):
@@ -9706,7 +10661,6 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                         chnlcount += 1
                         chnlcountmax = len(subfolder)
                         if "Pattern" not in FolderBase:
-                            # [理쒖쟻??#6] step_namelist 誘몄큹湲고솕 諛⑹뼱
                             step_namelist = None
                             for Step_CycNo in CycleNo:
                                 cyccountmax = len(CycleNo)
@@ -9716,7 +10670,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                                 step_namelist = FolderBase.split("\\")
                                 headername = step_namelist[-2] + ", " + step_namelist[-1] + ", " + str(Step_CycNo) + "cy, "
                                 lgnd = "%04d" % Step_CycNo
-                                # [理쒖쟻??#3] 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜 (fallback: 吏곸젒 濡쒕뵫)
+                                # 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜
                                 temp = loaded_data.get((i, j, Step_CycNo))
                                 if temp is None:
                                     if not is_pne:
@@ -9726,21 +10680,47 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                                 temp_lgnd = "" if len(all_data_name) == 0 else all_data_name[i] + " " + lgnd
                                 if hasattr(temp[1], "stepchg"):
                                     if len(temp[1].stepchg) > 2:
-                                        # [理쒖쟻??#4] 怨듯넻 ?⑥닔濡??뚮’+???泥섎━
+                                        #?뚮’+???                                         axes = (step_ax1, step_ax2, step_ax3, step_ax4, step_ax5, step_ax6)
                                         write_column_num = self._plot_and_save_step_data(
                                             axes, temp[1].stepchg, temp[0], headername, lgnd, temp_lgnd,
                                             writer, write_column_num, save_file_name, Step_CycNo, save_csv=True)
-                            # [理쒖쟻??#6] step_namelist 誘몄큹湲고솕 諛⑹뼱
                             if step_namelist:
                                 title = step_namelist[-2] + "=" + step_namelist[-1]
-                                plt.suptitle(title, fontsize=15, fontweight='bold')
+                                plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
                                 axes_list = [step_ax1, step_ax2, step_ax4, step_ax3, step_ax5, step_ax6]
                                 positions = ["lower right", "lower right", "lower right", "lower right", "upper right", "upper right"]
-                                self._setup_legend(axes_list, all_data_name, positions)
+                                self._setup_legend(axes_list, all_data_name, positions, fig=fig)
                             # ?⑥닔 ?ъ슜?쇰줈 蹂寃?                             self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
                             tab_no += 1
+                elif all_profile:
+                    # ?꾩껜 ?듯빀: 紐⑤뱺 cyclefolder???횞?ъ씠?댁쓣 ?ъ쟾 ?앹꽦??1媛?fig???ㅻ쾭?덉씠
+                    for j, FolderBase in enumerate(subfolder):
+                        chnlcount += 1
+                        chnlcountmax = len(subfolder)
+                        if "Pattern" not in FolderBase:
+                            for Step_CycNo in CycleNo:
+                                cyccountmax = len(CycleNo)
+                                cyccount += 1
+                                progressdata = 50 + progress(folder_count, foldercountmax, chnlcount, chnlcountmax, cyccount, cyccountmax) * 0.5
+                                self.progressBar.setValue(int(progressdata))
+                                last_step_namelist = FolderBase.split("\\")
+                                headername = last_step_namelist[-2] + ", " + last_step_namelist[-1] + ", " + str(Step_CycNo) + "cy, "
+                                lgnd = last_step_namelist[-1] + " %04d" % Step_CycNo
+                                temp = loaded_data.get((i, j, Step_CycNo))
+                                if temp is None:
+                                    if not is_pne:
+                                        temp = toyo_step_Profile_data(FolderBase, Step_CycNo, mincapacity, mincrate, firstCrate)
+                                    else:
+                                        temp = pne_step_Profile_data(FolderBase, Step_CycNo, mincapacity, mincrate, firstCrate)
+                                temp_lgnd = lgnd if len(all_data_name) == 0 else all_data_name[i] + " " + lgnd
+                                if hasattr(temp[1], "stepchg"):
+                                    if len(temp[1].stepchg) > 2:
+                                        axes = (step_ax1, step_ax2, step_ax3, step_ax4, step_ax5, step_ax6)
+                                        write_column_num = self._plot_and_save_step_data(
+                                            axes, temp[1].stepchg, temp[0], headername, lgnd, temp_lgnd,
+                                            writer, write_column_num, save_file_name, Step_CycNo, save_csv=True)
                 else:
                     for Step_CycNo in CycleNo:
                         fig, ((step_ax1, step_ax2, step_ax3), (step_ax4, step_ax5, step_ax6)) = plt.subplots(
@@ -9749,7 +10729,6 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                         tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
                         chnlcount += 1
                         chnlcountmax = len(subfolder)
-                        # [理쒖쟻??#6] step_namelist 誘몄큹湲고솕 諛⑹뼱
                         step_namelist = None
                         for j, FolderBase in enumerate(subfolder):
                             if "Pattern" not in FolderBase:
@@ -9760,7 +10739,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                                 step_namelist = FolderBase.split("\\")
                                 headername = step_namelist[-2] + ", " + step_namelist[-1] + ", " + str(Step_CycNo) + "cy, "
                                 lgnd = step_namelist[-1]
-                                # [理쒖쟻??#3] 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜 (fallback: 吏곸젒 濡쒕뵫)
+                                # 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜
                                 temp = loaded_data.get((i, j, Step_CycNo))
                                 if temp is None:
                                     if not is_pne:
@@ -9770,24 +10749,32 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                                 temp_lgnd = "" if len(all_data_name) == 0 else all_data_name[i] + " " + lgnd
                                 if hasattr(temp[1], "stepchg"):
                                     if len(temp[1].stepchg) > 2:
-                                        # [理쒖쟻??#4] 怨듯넻 ?⑥닔濡??뚮’+???泥섎━
+                                        #?뚮’+???                                         axes = (step_ax1, step_ax2, step_ax3, step_ax4, step_ax5, step_ax6)
                                         write_column_num = self._plot_and_save_step_data(
                                             axes, temp[1].stepchg, temp[0], headername, lgnd, temp_lgnd,
                                             writer, write_column_num, save_file_name, Step_CycNo)
-                        # [理쒖쟻??#5] title/legend: 紐⑤뱺 梨꾨꼸 ?뚮’ ?꾨즺 ??1???ㅽ뻾 (踰꾧렇 ?섏젙: for FolderBase 猷⑦봽 諛뽰쑝濡??대룞)
+                        #title/legend 紐⑤뱺 梨꾨꼸 ?뚮’ ?꾨즺 ??1???ㅽ뻾
                         if step_namelist:
                             title = step_namelist[-2] + "=" + "%04d" % Step_CycNo
-                            plt.suptitle(title, fontsize=15, fontweight='bold')
+                            plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
                             axes_list = [step_ax1, step_ax2, step_ax4, step_ax3, step_ax5, step_ax6]
                             positions = ["lower right", "lower right", "lower right", "lower right", "upper right", "upper right"]
-                            self._setup_legend(axes_list, all_data_name, positions)
+                            self._setup_legend(axes_list, all_data_name, positions, fig=fig)
                         # ?⑥닔 ?ъ슜?쇰줈 蹂寃?                         self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
                         tab_no += 1
+        # AllProfile: 猷⑦봽 醫낅즺 ???쒕쾲??finalize
+        if all_profile and last_step_namelist:
+            title = last_step_namelist[-2] + " All"
+            plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
+            axes_list = [step_ax1, step_ax2, step_ax4, step_ax3, step_ax5, step_ax6]
+            positions = ["lower right", "lower right", "lower right", "lower right", "upper right", "upper right"]
+            self._setup_legend(axes_list, all_data_name, positions, fig=fig)
+            self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
+            tab_no += 1
         if self.saveok.isChecked() and save_file_name:
             writer.close()
-        # [理쒖쟻??#8] 以묐났 tight_layout ?쒓굅 (_finalize_plot_tab ?대??먯꽌 ?대? ?몄텧)
         self.progressBar.setValue(100)
         plt.close()
 
@@ -9798,42 +10785,58 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         smoothdegree, mincrate, dqscale, dvscale = init_data['smoothdegree'], init_data['mincrate'], init_data['dqscale'], init_data['dvscale']
         all_data_folder, all_data_name = init_data['folders'], init_data['names']
         
-        # ?⑸웾 ?좎젙 愿??-        global writer
+        #global writer ?쒓굅 ??濡쒖뺄 蹂?섎줈留??ъ슜
         writecolno, foldercount, chnlcount, cyccount = 0, 0, 0, 0
         
-        # ?⑥닔 ?ъ슜?쇰줈 蹂寃?+        #?⑥닔 ?ъ슜?쇰줈 蹂寃?         writer, save_file_name = self._setup_file_writer()
+        
+        # ?곗씠??蹂묐젹 濡쒕뵫 (ThreadPoolExecutor)
+        self.progressBar.setValue(0)
+        loaded_data = self._load_all_profile_data_parallel(
+            all_data_folder, 'rate', (CycleNo, mincapacity, mincrate, firstCrate), max_workers=4)
+        
         tab_no = 0
+        all_profile = self.AllProfile.isChecked()
+        # AllProfile: 猷⑦봽 ?꾩뿉 fig/tab 1媛쒕쭔 ?앹꽦
+        if all_profile:
+            fig, ((rate_ax1, rate_ax2, rate_ax3), (rate_ax4, rate_ax5, rate_ax6)) = plt.subplots(
+                nrows=2, ncols=3, figsize=(14, 10))
+            tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
+            last_Ratenamelist = None
         for i, cyclefolder in enumerate(all_data_folder):
+            if not os.path.isdir(cyclefolder):
+                continue
             subfolder = [f.path for f in os.scandir(cyclefolder) if f.is_dir()]
             foldercountmax = len(all_data_folder)
-            foldercount = foldercount + 1
+            foldercount += 1
+            #cyclefolder ??1?뚮쭔 ?몄텧
+            is_pne = check_cycler(cyclefolder)
             if self.CycProfile.isChecked():
-                for FolderBase in subfolder:
-                    fig, ((rate_ax1, rate_ax2, rate_ax3) ,(rate_ax4, rate_ax5, rate_ax6)) = plt.subplots(
+                for j, FolderBase in enumerate(subfolder):
+                    fig, ((rate_ax1, rate_ax2, rate_ax3), (rate_ax4, rate_ax5, rate_ax6)) = plt.subplots(
                         nrows=2, ncols=3, figsize=(14, 10))
-                    # ?⑥닔 ?ъ슜?쇰줈 蹂寃?                     tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
-                    chnlcount = chnlcount + 1
+                    chnlcount += 1
                     chnlcountmax = len(subfolder)
                     if "Pattern" not in FolderBase:
+                        Ratenamelist = None
                         for CycNo in CycleNo:
                             cyccountmax = len(CycleNo)
-                            cyccount = cyccount + 1
+                            cyccount += 1
                             progressdata = progress(foldercount, foldercountmax, chnlcount, chnlcountmax, cyccount, cyccountmax)
-                            self.progressBar.setValue(int(progressdata))
+                            self.progressBar.setValue(int(50 + progressdata * 0.5))
                             Ratenamelist = FolderBase.split("\\")
                             headername = Ratenamelist[-2] + ", " + Ratenamelist[-1] + ", " + str(CycNo) + "cy, "
                             lgnd = "%04d" % CycNo
-                            if not check_cycler(cyclefolder):
-                                Ratetemp = toyo_rate_Profile_data( FolderBase, CycNo, mincapacity, mincrate, firstCrate)
-                            else:
-                                Ratetemp = pne_rate_Profile_data( FolderBase, CycNo, mincapacity, mincrate, firstCrate)
-                            if len(all_data_name) == 0:
-                                temp_lgnd = ""
-                            else:	
-                                temp_lgnd = all_data_name[i] + " " + lgnd
+                            # 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜
+                            Ratetemp = loaded_data.get((i, j, CycNo))
+                            if Ratetemp is None:
+                                if not is_pne:
+                                    Ratetemp = toyo_rate_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate)
+                                else:
+                                    Ratetemp = pne_rate_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate)
+                            temp_lgnd = "" if len(all_data_name) == 0 else all_data_name[i] + " " + lgnd
                             if hasattr(Ratetemp[1], "rateProfile"):
                                 if len(Ratetemp[1].rateProfile) > 2:
                                     self.capacitytext.setText(str(Ratetemp[0]))
@@ -9849,69 +10852,99 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                                                "Time(min)", "SOC", temp_lgnd)
                                     graph_step(Ratetemp[1].rateProfile.TimeMin, Ratetemp[1].rateProfile.Temp, rate_ax6, -15, 60, 5,
                                                "Time(min)", "Temp.", lgnd)
-                                    # Data output option
                                     if self.saveok.isChecked() and save_file_name:
                                         Ratetemp[1].rateProfile.to_excel(
-                                            writer,
-                                            startcol=writecolno,
-                                            index=False,
-                                            header=[
-                                                headername + "time(min)",
-                                                headername + "SOC",
-                                                headername + "Voltage",
-                                                headername + "Crate",
-                                                headername + "Temp."
-                                            ])
-                                        writecolno = writecolno + 5
+                                            writer, startcol=writecolno, index=False,
+                                            header=[headername + "time(min)", headername + "SOC",
+                                                    headername + "Voltage", headername + "Crate", headername + "Temp."])
+                                        writecolno += 5
                                     if self.ect_saveok.isChecked() and save_file_name:
-                                        Ratetemp[1].Profile["TimeSec"] = Ratetemp[1].Profile.TimeMin * 60
-                                        Ratetemp[1].Profile["Curr"] = Ratetemp[1].Profile.Crate * Ratetemp[0] /1000
-                                        continue_df = Ratetemp[1].Profile.loc[:,["TimeSec", "Vol", "Curr", "Temp"]]
-                                        # 媛??댁쓣 ?뚯닔???먮━?섏뿉 留욊쾶 諛섏삱由?-                                        continue_df['TimeSec'] = continue_df['TimeSec'].round(1)  # ?뚯닔??1?먮━
-                                        continue_df['Vol'] = continue_df['Vol'].round(4)           # ?뚯닔??4?먮━
-                                        continue_df['Curr'] = continue_df['Curr'].round(4)         # ?뚯닔??4?먮━
-                                        continue_df['Temp'] = continue_df['Temp'].round(1)         # ?뚯닔??1?먮━
+                                        continue_df = Ratetemp[1].rateProfile[["TimeMin", "Vol", "Crate", "Temp"]].copy()
+                                        continue_df["TimeSec"] = (continue_df["TimeMin"] * 60).round(1)
+                                        continue_df["Curr"] = (continue_df["Crate"] * Ratetemp[0] / 1000).round(4)
+                                        continue_df["Vol"] = continue_df["Vol"].round(4)
+                                        continue_df["Temp"] = continue_df["Temp"].round(1)
+                                        continue_df = continue_df[["TimeSec", "Vol", "Curr", "Temp"]]
                                         continue_df.to_csv(save_file_name + "_" + "%04d" % CycNo + ".csv", index=False, sep=',',
-                                                            header=["time(s)",
-                                                                    "Voltage(V)",
-                                                                    "Current(A)",
-                                                                    "Temp."])
+                                                            header=["time(s)", "Voltage(V)", "Current(A)", "Temp."])
+                        if Ratenamelist:
                             title = Ratenamelist[-2] + "=" + Ratenamelist[-1]
-                            plt.suptitle(title, fontsize= 15, fontweight='bold')
-                            # ?⑥닔 ?ъ슜?쇰줈 蹂寃?+                            plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
                             axes_list = [rate_ax1, rate_ax2, rate_ax3, rate_ax4, rate_ax5, rate_ax6]
                             positions = ["lower right", "upper right", "lower right", "lower right", "upper right", "upper right"]
-                            self._setup_legend(axes_list, all_data_name, positions)
-                        # ?⑥닔 ?ъ슜?쇰줈 蹂寃?+                            self._setup_legend(axes_list, all_data_name, positions, fig=fig)
                         self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
-                        tab_no = tab_no + 1
+                        tab_no += 1
                         output_fig(self.figsaveok, title)
+            elif all_profile:
+                # ?꾩껜 ?듯빀: 紐⑤뱺 cyclefolder???횞?ъ씠?댁쓣 ?ъ쟾 ?앹꽦??1媛?fig???ㅻ쾭?덉씠
+                for j, FolderBase in enumerate(subfolder):
+                    chnlcount += 1
+                    chnlcountmax = len(subfolder)
+                    if "Pattern" not in FolderBase:
+                        for CycNo in CycleNo:
+                            cyccountmax = len(CycleNo)
+                            cyccount += 1
+                            progressdata = progress(foldercount, foldercountmax, chnlcount, chnlcountmax, cyccount, cyccountmax)
+                            self.progressBar.setValue(int(50 + progressdata * 0.5))
+                            last_Ratenamelist = FolderBase.split("\\")
+                            headername = last_Ratenamelist[-2] + ", " + last_Ratenamelist[-1] + ", " + str(CycNo) + "cy, "
+                            lgnd = last_Ratenamelist[-1] + " %04d" % CycNo
+                            # 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜
+                            Ratetemp = loaded_data.get((i, j, CycNo))
+                            if Ratetemp is None:
+                                if not is_pne:
+                                    Ratetemp = toyo_rate_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate)
+                                else:
+                                    Ratetemp = pne_rate_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate)
+                            temp_lgnd = lgnd if len(all_data_name) == 0 else all_data_name[i] + " " + lgnd
+                            if hasattr(Ratetemp[1], "rateProfile"):
+                                if len(Ratetemp[1].rateProfile) > 2:
+                                    self.capacitytext.setText(str(Ratetemp[0]))
+                                    graph_step(Ratetemp[1].rateProfile.TimeMin, Ratetemp[1].rateProfile.Vol, rate_ax1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
+                                               "Time(min)", "Voltage(V)", temp_lgnd)
+                                    graph_step(Ratetemp[1].rateProfile.TimeMin, Ratetemp[1].rateProfile.Vol, rate_ax4, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
+                                               "Time(min)", "Voltage(V)", temp_lgnd)
+                                    graph_step(Ratetemp[1].rateProfile.TimeMin, Ratetemp[1].rateProfile.Crate, rate_ax2, 0, 3.4, 0.2,
+                                               "Time(min)", "C-rate", temp_lgnd)
+                                    graph_step(Ratetemp[1].rateProfile.TimeMin, Ratetemp[1].rateProfile.Crate, rate_ax5, 0, 3.4, 0.2,
+                                               "Time(min)", "C-rate", temp_lgnd)
+                                    graph_step(Ratetemp[1].rateProfile.TimeMin, Ratetemp[1].rateProfile.SOC, rate_ax3, 0, 1.2, 0.1,
+                                               "Time(min)", "SOC", temp_lgnd)
+                                    graph_step(Ratetemp[1].rateProfile.TimeMin, Ratetemp[1].rateProfile.Temp, rate_ax6, -15, 60, 5,
+                                               "Time(min)", "Temp.", lgnd)
+                                    if self.saveok.isChecked() and save_file_name:
+                                        Ratetemp[1].rateProfile.to_excel(
+                                            writer, startcol=writecolno, index=False,
+                                            header=[headername + "time(min)", headername + "SOC",
+                                                    headername + "Voltage", headername + "Crate", headername + "Temp."])
+                                        writecolno += 5
             else:
                 for CycNo in CycleNo:
-                    fig, ((rate_ax1, rate_ax2, rate_ax3) ,(rate_ax4, rate_ax5, rate_ax6)) = plt.subplots(
+                    fig, ((rate_ax1, rate_ax2, rate_ax3), (rate_ax4, rate_ax5, rate_ax6)) = plt.subplots(
                         nrows=2, ncols=3, figsize=(14, 10))
-                    # ?⑥닔 ?ъ슜?쇰줈 蹂寃?                     tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
-                    chnlcount = chnlcount + 1
+                    chnlcount += 1
                     chnlcountmax = len(subfolder)
-                    for FolderBase in subfolder:
+                    # [理쒖쟻?? namelist 誘몄큹湲고솕 諛⑹뼱
+                    Ratenamelist = None
+                    for j, FolderBase in enumerate(subfolder):
                         if "Pattern" not in FolderBase:
                             cyccountmax = len(CycleNo)
-                            cyccount = cyccount + 1
+                            cyccount += 1
                             progressdata = progress(foldercount, foldercountmax, cyccount, cyccountmax, chnlcount, chnlcountmax)
-                            self.progressBar.setValue(int(progressdata))
+                            self.progressBar.setValue(int(50 + progressdata * 0.5))
                             Ratenamelist = FolderBase.split("\\")
                             headername = Ratenamelist[-2] + ", " + Ratenamelist[-1] + ", " + str(CycNo) + "cy, "
                             lgnd = Ratenamelist[-1]
-                            if not check_cycler(cyclefolder):
-                                Ratetemp = toyo_rate_Profile_data( FolderBase, CycNo, mincapacity, mincrate, firstCrate)
-                            else:
-                                Ratetemp = pne_rate_Profile_data( FolderBase, CycNo, mincapacity, mincrate, firstCrate)
-                            if len(all_data_name) == 0:
-                                temp_lgnd = ""
-                            else:	
-                                temp_lgnd = all_data_name[i] + " " + lgnd
+                            # 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜
+                            Ratetemp = loaded_data.get((i, j, CycNo))
+                            if Ratetemp is None:
+                                if not is_pne:
+                                    Ratetemp = toyo_rate_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate)
+                                else:
+                                    Ratetemp = pne_rate_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate)
+                            temp_lgnd = "" if len(all_data_name) == 0 else all_data_name[i] + " " + lgnd
                             if hasattr(Ratetemp[1], "rateProfile"):
                                 if len(Ratetemp[1].rateProfile) > 2:
                                     self.capacitytext.setText(str(Ratetemp[0]))
@@ -9927,41 +10960,34 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                                                "Time(min)", "SOC", temp_lgnd)
                                     graph_step(Ratetemp[1].rateProfile.TimeMin, Ratetemp[1].rateProfile.Temp, rate_ax6, -15, 60, 5,
                                                "Time(min)", "Temp.", lgnd)
-                                    # Data output option
                                     if self.saveok.isChecked() and save_file_name:
                                         Ratetemp[1].rateProfile.to_excel(
-                                            writer,
-                                            startcol=writecolno,
-                                            index=False,
-                                            header=[
-                                                headername + "time(min)",
-                                                headername + "SOC",
-                                                headername + "Voltage",
-                                                headername + "Crate",
-                                                headername + "Temp."
-                                            ])
-                                        writecolno = writecolno + 5
-                            title = Ratenamelist[-2] + "=" + "%04d" % CycNo
-                            plt.suptitle(title, fontsize= 15, fontweight='bold')
-                            if len(all_data_name) != 0:
-                                rate_ax1.legend(loc="lower right")
-                                rate_ax2.legend(loc="upper right")
-                                rate_ax3.legend(loc="lower right")
-                                rate_ax4.legend(loc="lower right")
-                                rate_ax5.legend(loc="upper right")
-                                rate_ax6.legend(loc="upper right")
-                            else:
-                                plt.legend(loc="center left", bbox_to_anchor=(1, 0.5))
-                    tab_layout.addWidget(toolbar)
-                    tab_layout.addWidget(canvas)
-                    self.cycle_tab.addTab(tab, str(tab_no))
-                    self.cycle_tab.setCurrentWidget(tab)
-                    tab_no = tab_no + 1
-                    plt.tight_layout(pad=1, w_pad=1, h_pad=1)
+                                            writer, startcol=writecolno, index=False,
+                                            header=[headername + "time(min)", headername + "SOC",
+                                                    headername + "Voltage", headername + "Crate", headername + "Temp."])
+                                        writecolno += 5
+
+                    if Ratenamelist:
+                        title = Ratenamelist[-2] + "=" + "%04d" % CycNo
+                        plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
+                        axes_list = [rate_ax1, rate_ax2, rate_ax3, rate_ax4, rate_ax5, rate_ax6]
+                        positions = ["lower right", "upper right", "lower right", "lower right", "upper right", "upper right"]
+                        self._setup_legend(axes_list, all_data_name, positions, fig=fig)
+                    self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
+                    tab_no += 1
                     output_fig(self.figsaveok, title)
+        # AllProfile: 猷⑦봽 醫낅즺 ???쒕쾲??finalize
+        if all_profile and last_Ratenamelist:
+            title = last_Ratenamelist[-2] + " All"
+            plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
+            axes_list = [rate_ax1, rate_ax2, rate_ax3, rate_ax4, rate_ax5, rate_ax6]
+            positions = ["lower right", "upper right", "lower right", "lower right", "upper right", "upper right"]
+            self._setup_legend(axes_list, all_data_name, positions, fig=fig)
+            self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
+            tab_no += 1
+            output_fig(self.figsaveok, title)
         if self.saveok.isChecked() and save_file_name:
             writer.close()
-        plt.tight_layout(pad=1, w_pad=1, h_pad=1)
         self.progressBar.setValue(100)
         plt.close()
 
@@ -9972,205 +10998,231 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         smoothdegree, mincrate, dqscale, dvscale = init_data['smoothdegree'], init_data['mincrate'], init_data['dqscale'], init_data['dvscale']
         all_data_folder, all_data_name = init_data['folders'], init_data['names']
         
-        # ?⑸웾 ?좎젙 愿??-        global writer
+        # [理쒖쟻?? global writer ?쒓굅 ??濡쒖뺄 蹂?섎줈留??ъ슜
         foldercount, chnlcount, cyccount, writecolno = 0, 0, 0, 0
         
         # ?⑥닔 ?ъ슜?쇰줈 蹂寃?         writer, save_file_name = self._setup_file_writer()
+        
+        # ?곗씠??蹂묐젹 濡쒕뵫 (ThreadPoolExecutor)
+        self.progressBar.setValue(0)
+        loaded_data = self._load_all_profile_data_parallel(
+            all_data_folder, 'chg', (CycleNo, mincapacity, mincrate, firstCrate, smoothdegree), max_workers=4)
+        
         tab_no = 0
+        all_profile = self.AllProfile.isChecked()
+        # AllProfile: 猷⑦봽 ?꾩뿉 fig/tab 1媛쒕쭔 ?앹꽦
+        if all_profile:
+            fig, ((Chg_ax1, Chg_ax2, Chg_ax3), (Chg_ax4, Chg_ax5, Chg_ax6)) = plt.subplots(
+                nrows=2, ncols=3, figsize=(14, 10))
+            tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
+            last_Chgnamelist = None
         for i, cyclefolder in enumerate(all_data_folder):
-            if os.path.isdir(cyclefolder):
-                subfolder = [f.path for f in os.scandir(cyclefolder) if f.is_dir()]
-                foldercountmax = len(all_data_folder)
-                foldercount = foldercount + 1
-                if self.CycProfile.isChecked():
-                    for FolderBase in subfolder:
-                        chnlcount = chnlcount + 1
-                        chnlcountmax = len(subfolder)
-                        if "Pattern" not in FolderBase:
-                            fig, ((Chg_ax1, Chg_ax2, Chg_ax3) ,(Chg_ax4, Chg_ax5, Chg_ax6)) = plt.subplots(
-                                nrows=2, ncols=3, figsize=(14, 10))
-                            # ?⑥닔 ?ъ슜?쇰줈 蹂寃?-                            tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
-                            for CycNo in CycleNo:
-                                cyccountmax = len(CycleNo)
-                                cyccount = cyccount + 1
-                                progressdata = progress(foldercount, foldercountmax, chnlcount, chnlcountmax, cyccount, cyccountmax)
-                                self.progressBar.setValue(int(progressdata))
-                                Chgnamelist = FolderBase.split("\\")
-                                headername = Chgnamelist[-2] + ", " + Chgnamelist[-1] + ", " + str(CycNo) + "cy, "
-                                lgnd = "%04d" % CycNo
-                                if not check_cycler(cyclefolder):
-                                    Chgtemp = toyo_chg_Profile_data( FolderBase, CycNo, mincapacity, mincrate, firstCrate,
-                                                                    smoothdegree)
-                                else:
-                                    Chgtemp = pne_chg_Profile_data( FolderBase, CycNo, mincapacity, mincrate, firstCrate,
-                                                                   smoothdegree)
-                                if len(all_data_name) == 0:
-                                    temp_lgnd = ""
-                                else:	
-                                    temp_lgnd = all_data_name[i] + " " + lgnd
-                                if hasattr(Chgtemp[1], "Profile"):
-                                    if len(Chgtemp[1].Profile) > 2:
-                                        self.capacitytext.setText(str(Chgtemp[0]))
-                                        graph_profile( Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Vol, Chg_ax1,
-                                                      0, 1.3, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "SOC", "Voltage(V)", temp_lgnd)
-                                        graph_profile( Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Vol, Chg_ax3,
-                                                      0, 1.3, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "SOC", "Voltage(V)", temp_lgnd)
-                                        if self.chk_dqdv.isChecked():
-                                            graph_profile( Chgtemp[1].Profile.Vol, Chgtemp[1].Profile.dQdV, Chg_ax2,
-                                                        self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, 0, 5.5 * dqscale, 0.5 * dqscale, 
-                                                        "Voltage(V)","dQdV", temp_lgnd)
-                                        else:
-                                            graph_profile( Chgtemp[1].Profile.dQdV, Chgtemp[1].Profile.Vol, Chg_ax2,
-                                                        0, 5.5 * dqscale, 0.5 * dqscale, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
-                                                        "dQdV", "Voltage(V)", temp_lgnd)
-                                        graph_profile( Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Crate, Chg_ax5,
-                                                      0, 1.3, 0.1, 0, 3.4, 0.2, "SOC", "C-rate", temp_lgnd) 
-                                        graph_profile( Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.dVdQ, Chg_ax4,
-                                                      0, 1.3, 0.1, 0, 5.5 * dvscale, 0.5 * dvscale, "SOC", "dVdQ", temp_lgnd)
-                                        graph_profile( Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Temp, Chg_ax6,
-                                                      0, 1.3, 0.1, -15, 60, 5, "SOC", "Temp.", lgnd)
-                                        # Data output option
-                                        if self.saveok.isChecked() and save_file_name:
-                                            Chgtemp[1].Profile.to_excel(
-                                                writer,
-                                                startcol=writecolno,
-                                                index=False,
-                                                header=[
-                                                    headername + "Time(min)",
-                                                    headername + "SOC",
-                                                    headername + "Energy",
-                                                    headername + "Voltage",
-                                                    headername + "Crate",
-                                                    headername + "dQdV",
-                                                    headername + "dVdQ",
-                                                    headername + "Temp."
-                                                ])
-                                            writecolno = writecolno + 8
-                                        if self.ect_saveok.isChecked() and save_file_name:
-                                            Chgtemp[1].Profile["TimeSec"] = Chgtemp[1].Profile["TimeMin"] * 60
-                                            Chgtemp[1].Profile["Curr"] = Chgtemp[1].Profile["Crate"] * Chgtemp[0] / 1000
-                                            continue_df = Chgtemp[1].Profile.loc[:,["TimeSec", "Vol", "Curr", "Temp"]]
-                                            # 媛??댁쓣 ?뚯닔???먮━?섏뿉 留욊쾶 諛섏삱由?-                                            continue_df['TimeSec'] = continue_df['TimeSec'].round(1)  # ?뚯닔??1?먮━
-                                            continue_df['Vol'] = continue_df['Vol'].round(4)           # ?뚯닔??4?먮━
-                                            continue_df['Curr'] = continue_df['Curr'].round(4)         # ?뚯닔??4?먮━
-                                            continue_df['Temp'] = continue_df['Temp'].round(1)         # ?뚯닔??1?먮━
-                                            continue_df.to_csv(save_file_name + "_"+ "%04d" % CycNo + ".csv", index=False, sep=',',
-                                                                header=["time(s)",
-                                                                        "Voltage(V)",
-                                                                        "Current(A)",
-                                                                        "Temp."])
-                                title = Chgnamelist[-2] + "=" + Chgnamelist[-1]
-                                plt.suptitle(title, fontsize= 15, fontweight='bold')
-                                if len(all_data_name) != 0:
-                                    Chg_ax1.legend(loc="lower right")
-                                    Chg_ax2.legend(loc="lower right")
-                                    Chg_ax3.legend(loc="lower right")
-                                    Chg_ax4.legend(loc="upper right")
-                                    Chg_ax5.legend(loc="upper right")
-                                    Chg_ax6.legend(loc="upper right")
-                                else:
-                                    plt.legend(loc="center left", bbox_to_anchor=(1, 0.5))
-                            tab_layout.addWidget(toolbar)
-                            tab_layout.addWidget(canvas)
-                            self.cycle_tab.addTab(tab, str(tab_no))
-                            self.cycle_tab.setCurrentWidget(tab)
-                            tab_no = tab_no + 1
-                            plt.tight_layout(pad=1, w_pad=1, h_pad=1)
-                            output_fig(self.figsaveok, title)
-                else:
-                    for CycNo in CycleNo:
-                        chnlcount = chnlcount + 1
-                        chnlcountmax = len(subfolder)
-                        fig, ((Chg_ax1, Chg_ax2, Chg_ax3) ,(Chg_ax4, Chg_ax5, Chg_ax6)) = plt.subplots(
+            if not os.path.isdir(cyclefolder):
+                continue
+            subfolder = [f.path for f in os.scandir(cyclefolder) if f.is_dir()]
+            foldercountmax = len(all_data_folder)
+            foldercount += 1
+            # [理쒖쟻?? check_cycler 罹먯떛
+            is_pne = check_cycler(cyclefolder)
+            if self.CycProfile.isChecked():
+                for j, FolderBase in enumerate(subfolder):
+                    chnlcount += 1
+                    chnlcountmax = len(subfolder)
+                    if "Pattern" not in FolderBase:
+                        fig, ((Chg_ax1, Chg_ax2, Chg_ax3), (Chg_ax4, Chg_ax5, Chg_ax6)) = plt.subplots(
                             nrows=2, ncols=3, figsize=(14, 10))
-                        tab = QtWidgets.QWidget()
-                        tab_layout = QtWidgets.QVBoxLayout(tab)
-                        canvas = FigureCanvas(fig)
-                        toolbar = NavigationToolbar(canvas, None)
-                        for FolderBase in subfolder:
-                            if "Pattern" not in FolderBase:
-                                cyccountmax = len(CycleNo)
-                                cyccount = cyccount + 1
-                                progressdata = progress(foldercount, foldercountmax, cyccount, cyccountmax, chnlcount, chnlcountmax)
-                                self.progressBar.setValue(int(progressdata))
-                                Chgnamelist = FolderBase.split("\\")
-                                headername = Chgnamelist[-2] + ", " + Chgnamelist[-1] + ", " + str(CycNo) + "cy, "
-                                lgnd = Chgnamelist[-1]
-                                if not check_cycler(cyclefolder):
-                                    Chgtemp = toyo_chg_Profile_data( FolderBase, CycNo, mincapacity, mincrate, firstCrate,
-                                                                    smoothdegree)
-                                else:
-                                    Chgtemp = pne_chg_Profile_data( FolderBase, CycNo, mincapacity, mincrate, firstCrate,
-                                                                   smoothdegree)
-                                if len(all_data_name) == 0:
-                                    temp_lgnd = ""
-                                else:	
-                                    temp_lgnd = all_data_name[i] + " " + lgnd
-                                if hasattr(Chgtemp[1], "Profile"):
-                                    if len(Chgtemp[1].Profile) > 2:
-                                        self.capacitytext.setText(str(Chgtemp[0]))
-                                        graph_profile( Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Vol, Chg_ax1,
-                                                      0, 1.3, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "SOC", "Voltage(V)", temp_lgnd)
-                                        graph_profile( Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Vol, Chg_ax3,
-                                                      0, 1.3, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "SOC", "Voltage(V)", temp_lgnd)
-                                        if self.chk_dqdv.isChecked():
-                                            graph_profile( Chgtemp[1].Profile.Vol, Chgtemp[1].Profile.dQdV, Chg_ax2,
-                                                        self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, 0, 5.5 * dqscale, 0.5 * dqscale, 
-                                                        "Voltage(V)","dQdV", temp_lgnd)
-                                        else:
-                                            graph_profile( Chgtemp[1].Profile.dQdV, Chgtemp[1].Profile.Vol, Chg_ax2,
-                                                        0, 5.5 * dqscale, 0.5 * dqscale, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
-                                                        "dQdV", "Voltage(V)", temp_lgnd)
-                                        graph_profile( Chgtemp[1].Profile.dQdV, Chgtemp[1].Profile.Vol, Chg_ax2, 0, 5.5 * dqscale, 0.5 * dqscale,
-                                                      self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "dQdV", "Voltage(V)", temp_lgnd)
-                                        graph_profile( Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Crate, Chg_ax5,
-                                                      0, 1.3, 0.1, 0, 3.4, 0.2, "SOC", "C-rate", temp_lgnd) 
-                                        graph_profile( Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.dVdQ, Chg_ax4,
-                                                      0, 1.3, 0.1, 0, 5.5 * dvscale, 0.5 * dvscale, "SOC", "dVdQ", temp_lgnd)
-                                        graph_profile( Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Temp, Chg_ax6,
-                                                      0, 1.3, 0.1, -15, 60, 5, "SOC", "Temp.", lgnd) 
-                                        # Data output option
-                                        if self.saveok.isChecked() and save_file_name:
-                                            Chgtemp[1].Profile.to_excel(
-                                                writer,
-                                                startcol=writecolno,
-                                                index=False,
-                                                header=[
-                                                    headername + "Time(min)",
-                                                    headername + "SOC",
-                                                    headername + "Energy",
-                                                    headername + "Voltage",
-                                                    headername + "Crate",
-                                                    headername + "dQdV",
-                                                    headername + "dVdQ",
-                                                    headername + "Temp."
-                                                ])
-                                            writecolno = writecolno + 8
-                                title = Chgnamelist[-2] + "=" + "%04d" % CycNo
-                                plt.suptitle(title, fontsize= 15, fontweight='bold')
-                                if len(all_data_name) != 0:
-                                    Chg_ax1.legend(loc="lower right")
-                                    Chg_ax2.legend(loc="lower right")
-                                    Chg_ax3.legend(loc="lower right")
-                                    Chg_ax4.legend(loc="upper right")
-                                    Chg_ax5.legend(loc="upper right")
-                                    Chg_ax6.legend(loc="upper right")
+                        tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
+                        Chgnamelist = None
+                        for CycNo in CycleNo:
+                            cyccountmax = len(CycleNo)
+                            cyccount += 1
+                            progressdata = progress(foldercount, foldercountmax, chnlcount, chnlcountmax, cyccount, cyccountmax)
+                            self.progressBar.setValue(int(50 + progressdata * 0.5))
+                            Chgnamelist = FolderBase.split("\\")
+                            headername = Chgnamelist[-2] + ", " + Chgnamelist[-1] + ", " + str(CycNo) + "cy, "
+                            lgnd = "%04d" % CycNo
+                            # 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜
+                            Chgtemp = loaded_data.get((i, j, CycNo))
+                            if Chgtemp is None:
+                                if not is_pne:
+                                    Chgtemp = toyo_chg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate, smoothdegree)
                                 else:
-                                    plt.legend(loc="center left", bbox_to_anchor=(1, 0.5))
-                        tab_layout.addWidget(toolbar)
-                        tab_layout.addWidget(canvas)
-                        self.cycle_tab.addTab(tab, str(tab_no))
-                        self.cycle_tab.setCurrentWidget(tab)
-                        tab_no = tab_no + 1
-                        plt.tight_layout(pad=1, w_pad=1, h_pad=1)
+                                    Chgtemp = pne_chg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate, smoothdegree)
+                            temp_lgnd = "" if len(all_data_name) == 0 else all_data_name[i] + " " + lgnd
+                            if hasattr(Chgtemp[1], "Profile"):
+                                if len(Chgtemp[1].Profile) > 2:
+                                    self.capacitytext.setText(str(Chgtemp[0]))
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Vol, Chg_ax1,
+                                                  -0.1, 1.2, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "SOC", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Vol, Chg_ax3,
+                                                  -0.1, 1.2, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "SOC", "Voltage(V)", temp_lgnd)
+                                    if self.chk_dqdv.isChecked():
+                                        graph_profile(Chgtemp[1].Profile.Vol, Chgtemp[1].Profile.dQdV, Chg_ax2,
+                                                    self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, 0, 5.5 * dqscale, 0.5 * dqscale,
+                                                    "Voltage(V)", "dQdV", temp_lgnd)
+                                    else:
+                                        graph_profile(Chgtemp[1].Profile.dQdV, Chgtemp[1].Profile.Vol, Chg_ax2,
+                                                    0, 5.5 * dqscale, 0.5 * dqscale, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
+                                                    "dQdV", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Crate, Chg_ax5,
+                                                  -0.1, 1.2, 0.1, 0, 3.4, 0.2, "SOC", "C-rate", temp_lgnd)
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.dVdQ, Chg_ax4,
+                                                  -0.1, 1.2, 0.1, 0, 5.5 * dvscale, 0.5 * dvscale, "SOC", "dVdQ", temp_lgnd)
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Temp, Chg_ax6,
+                                                  -0.1, 1.2, 0.1, -15, 60, 5, "SOC", "Temp.", lgnd)
+                                    if self.saveok.isChecked() and save_file_name:
+                                        Chgtemp[1].Profile.to_excel(
+                                            writer, startcol=writecolno, index=False,
+                                            header=[headername + "Time(min)", headername + "SOC", headername + "Energy",
+                                                    headername + "Voltage", headername + "Crate", headername + "dQdV",
+                                                    headername + "dVdQ", headername + "Temp."])
+                                        writecolno += 8
+                                    if self.ect_saveok.isChecked() and save_file_name:
+                                        continue_df = Chgtemp[1].Profile[["TimeMin", "Vol", "Crate", "Temp"]].copy()
+                                        continue_df["TimeSec"] = (continue_df["TimeMin"] * 60).round(1)
+                                        continue_df["Curr"] = (continue_df["Crate"] * Chgtemp[0] / 1000).round(4)
+                                        continue_df["Vol"] = continue_df["Vol"].round(4)
+                                        continue_df["Temp"] = continue_df["Temp"].round(1)
+                                        continue_df = continue_df[["TimeSec", "Vol", "Curr", "Temp"]]
+                                        continue_df.to_csv(save_file_name + "_" + "%04d" % CycNo + ".csv", index=False, sep=',',
+                                                            header=["time(s)", "Voltage(V)", "Current(A)", "Temp."])
+                        
+                        if Chgnamelist:
+                            title = Chgnamelist[-2] + "=" + Chgnamelist[-1]
+                            plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
+                            axes_list = [Chg_ax1, Chg_ax2, Chg_ax3, Chg_ax4, Chg_ax5, Chg_ax6]
+                            positions = ["lower right", "lower right", "lower right", "upper right", "upper right", "upper right"]
+                            self._setup_legend(axes_list, all_data_name, positions, fig=fig)
+                        self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
+                        tab_no += 1
                         output_fig(self.figsaveok, title)
+            elif all_profile:
+                # ?꾩껜 ?듯빀: 紐⑤뱺 cyclefolder???횞?ъ씠?댁쓣 ?ъ쟾 ?앹꽦??1媛?fig???ㅻ쾭?덉씠
+                for j, FolderBase in enumerate(subfolder):
+                    chnlcount += 1
+                    chnlcountmax = len(subfolder)
+                    if "Pattern" not in FolderBase:
+                        for CycNo in CycleNo:
+                            cyccountmax = len(CycleNo)
+                            cyccount += 1
+                            progressdata = progress(foldercount, foldercountmax, chnlcount, chnlcountmax, cyccount, cyccountmax)
+                            self.progressBar.setValue(int(50 + progressdata * 0.5))
+                            last_Chgnamelist = FolderBase.split("\\")
+                            headername = last_Chgnamelist[-2] + ", " + last_Chgnamelist[-1] + ", " + str(CycNo) + "cy, "
+                            lgnd = last_Chgnamelist[-1] + " %04d" % CycNo
+                            # 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜
+                            Chgtemp = loaded_data.get((i, j, CycNo))
+                            if Chgtemp is None:
+                                if not is_pne:
+                                    Chgtemp = toyo_chg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate, smoothdegree)
+                                else:
+                                    Chgtemp = pne_chg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate, smoothdegree)
+                            temp_lgnd = lgnd if len(all_data_name) == 0 else all_data_name[i] + " " + lgnd
+                            if hasattr(Chgtemp[1], "Profile"):
+                                if len(Chgtemp[1].Profile) > 2:
+                                    self.capacitytext.setText(str(Chgtemp[0]))
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Vol, Chg_ax1,
+                                                  -0.1, 1.2, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "SOC", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Vol, Chg_ax3,
+                                                  -0.1, 1.2, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "SOC", "Voltage(V)", temp_lgnd)
+                                    if self.chk_dqdv.isChecked():
+                                        graph_profile(Chgtemp[1].Profile.Vol, Chgtemp[1].Profile.dQdV, Chg_ax2,
+                                                    self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, 0, 5.5 * dqscale, 0.5 * dqscale,
+                                                    "Voltage(V)", "dQdV", temp_lgnd)
+                                    else:
+                                        graph_profile(Chgtemp[1].Profile.dQdV, Chgtemp[1].Profile.Vol, Chg_ax2,
+                                                    0, 5.5 * dqscale, 0.5 * dqscale, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
+                                                    "dQdV", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Crate, Chg_ax5,
+                                                  -0.1, 1.2, 0.1, 0, 3.4, 0.2, "SOC", "C-rate", temp_lgnd)
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.dVdQ, Chg_ax4,
+                                                  -0.1, 1.2, 0.1, 0, 5.5 * dvscale, 0.5 * dvscale, "SOC", "dVdQ", temp_lgnd)
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Temp, Chg_ax6,
+                                                  -0.1, 1.2, 0.1, -15, 60, 5, "SOC", "Temp.", lgnd)
+                                    if self.saveok.isChecked() and save_file_name:
+                                        Chgtemp[1].Profile.to_excel(
+                                            writer, startcol=writecolno, index=False,
+                                            header=[headername + "Time(min)", headername + "SOC", headername + "Energy",
+                                                    headername + "Voltage", headername + "Crate", headername + "dQdV",
+                                                    headername + "dVdQ", headername + "Temp."])
+                                        writecolno += 8
+            else:
+                for CycNo in CycleNo:
+                    chnlcount += 1
+                    chnlcountmax = len(subfolder)
+                    fig, ((Chg_ax1, Chg_ax2, Chg_ax3), (Chg_ax4, Chg_ax5, Chg_ax6)) = plt.subplots(
+                        nrows=2, ncols=3, figsize=(14, 10))
+                    tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
+                    
+                    Chgnamelist = None
+                    for j, FolderBase in enumerate(subfolder):
+                        if "Pattern" not in FolderBase:
+                            cyccountmax = len(CycleNo)
+                            cyccount += 1
+                            progressdata = progress(foldercount, foldercountmax, cyccount, cyccountmax, chnlcount, chnlcountmax)
+                            self.progressBar.setValue(int(50 + progressdata * 0.5))
+                            Chgnamelist = FolderBase.split("\\")
+                            headername = Chgnamelist[-2] + ", " + Chgnamelist[-1] + ", " + str(CycNo) + "cy, "
+                            lgnd = Chgnamelist[-1]
+                            # 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜
+                            Chgtemp = loaded_data.get((i, j, CycNo))
+                            if Chgtemp is None:
+                                if not is_pne:
+                                    Chgtemp = toyo_chg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate, smoothdegree)
+                                else:
+                                    Chgtemp = pne_chg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate, smoothdegree)
+                            temp_lgnd = "" if len(all_data_name) == 0 else all_data_name[i] + " " + lgnd
+                            if hasattr(Chgtemp[1], "Profile"):
+                                if len(Chgtemp[1].Profile) > 2:
+                                    self.capacitytext.setText(str(Chgtemp[0]))
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Vol, Chg_ax1,
+                                                  -0.1, 1.2, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "SOC", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Vol, Chg_ax3,
+                                                  -0.1, 1.2, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "SOC", "Voltage(V)", temp_lgnd)
+                                    if self.chk_dqdv.isChecked():
+                                        graph_profile(Chgtemp[1].Profile.Vol, Chgtemp[1].Profile.dQdV, Chg_ax2,
+                                                    self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, 0, 5.5 * dqscale, 0.5 * dqscale,
+                                                    "Voltage(V)", "dQdV", temp_lgnd)
+                                    else:
+                                        graph_profile(Chgtemp[1].Profile.dQdV, Chgtemp[1].Profile.Vol, Chg_ax2,
+                                                    0, 5.5 * dqscale, 0.5 * dqscale, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
+                                                    "dQdV", "Voltage(V)", temp_lgnd)
+                                    
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Crate, Chg_ax5,
+                                                  -0.1, 1.2, 0.1, 0, 3.4, 0.2, "SOC", "C-rate", temp_lgnd)
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.dVdQ, Chg_ax4,
+                                                  -0.1, 1.2, 0.1, 0, 5.5 * dvscale, 0.5 * dvscale, "SOC", "dVdQ", temp_lgnd)
+                                    graph_profile(Chgtemp[1].Profile.SOC, Chgtemp[1].Profile.Temp, Chg_ax6,
+                                                  -0.1, 1.2, 0.1, -15, 60, 5, "SOC", "Temp.", lgnd)
+                                    if self.saveok.isChecked() and save_file_name:
+                                        Chgtemp[1].Profile.to_excel(
+                                            writer, startcol=writecolno, index=False,
+                                            header=[headername + "Time(min)", headername + "SOC", headername + "Energy",
+                                                    headername + "Voltage", headername + "Crate", headername + "dQdV",
+                                                    headername + "dVdQ", headername + "Temp."])
+                                        writecolno += 8
+                    if Chgnamelist:
+                        title = Chgnamelist[-2] + "=" + "%04d" % CycNo
+                        plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
+                        axes_list = [Chg_ax1, Chg_ax2, Chg_ax3, Chg_ax4, Chg_ax5, Chg_ax6]
+                        positions = ["lower right", "lower right", "lower right", "upper right", "upper right", "upper right"]
+                        self._setup_legend(axes_list, all_data_name, positions, fig=fig)
+                    self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
+                    tab_no += 1
+                    output_fig(self.figsaveok, title)
+        # AllProfile: 猷⑦봽 醫낅즺 ???쒕쾲??finalize
+        if all_profile and last_Chgnamelist:
+            title = last_Chgnamelist[-2] + " All"
+            plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
+            axes_list = [Chg_ax1, Chg_ax2, Chg_ax3, Chg_ax4, Chg_ax5, Chg_ax6]
+            positions = ["lower right", "lower right", "lower right", "upper right", "upper right", "upper right"]
+            self._setup_legend(axes_list, all_data_name, positions, fig=fig)
+            self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
+            tab_no += 1
+            output_fig(self.figsaveok, title)
         if self.saveok.isChecked() and save_file_name:
             writer.close()
-        plt.tight_layout(pad=1, w_pad=1, h_pad=1)
         self.progressBar.setValue(100)
         plt.close()
 
@@ -10181,213 +11233,228 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         smoothdegree, mincrate, dqscale, dvscale = init_data['smoothdegree'], init_data['mincrate'], init_data['dqscale'], init_data['dvscale']
         all_data_folder, all_data_name = init_data['folders'], init_data['names']
         
-        # ?⑸웾 ?좎젙 愿??-        global writer
+        #global writer ?쒓굅 ??濡쒖뺄 蹂?섎줈留??ъ슜
         foldercount, chnlcount, cyccount, writecolno = 0, 0, 0, 0
         
-        # ?⑥닔 ?ъ슜?쇰줈 蹂寃?   
+        #?⑥닔 ?ъ슜?쇰줈 蹂寃?   
         writer, save_file_name = self._setup_file_writer()
+        
+        # ?곗씠??蹂묐젹 濡쒕뵫 (ThreadPoolExecutor)
+        self.progressBar.setValue(0)
+        loaded_data = self._load_all_profile_data_parallel(
+            all_data_folder, 'dchg', (CycleNo, mincapacity, mincrate, firstCrate, smoothdegree), max_workers=4)
+        
         tab_no = 0
+        all_profile = self.AllProfile.isChecked()
+        # AllProfile: 猷⑦봽 ?꾩뿉 fig/tab 1媛쒕쭔 ?앹꽦
+        if all_profile:
+            fig, ((Chg_ax1, Chg_ax2, Chg_ax3), (Chg_ax4, Chg_ax5, Chg_ax6)) = plt.subplots(
+                nrows=2, ncols=3, figsize=(14, 10))
+            tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
+            last_Dchgnamelist = None
         for i, cyclefolder in enumerate(all_data_folder):
-            if os.path.isdir(cyclefolder):
-                subfolder = [f.path for f in os.scandir(cyclefolder) if f.is_dir()]
-                foldercountmax = len(all_data_folder)
-                foldercount = foldercount + 1
-                if self.CycProfile.isChecked():
-                    for FolderBase in subfolder:
-                        chnlcount = chnlcount + 1
-                        chnlcountmax = len(subfolder)
-                        if "Pattern" not in FolderBase:
-                            fig, ((Chg_ax1, Chg_ax2, Chg_ax3) ,(Chg_ax4, Chg_ax5, Chg_ax6)) = plt.subplots(
-                                nrows=2, ncols=3, figsize=(14, 10))
-                            # ?⑥닔 ?ъ슜?쇰줈 蹂寃?-                            tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
-                            for CycNo in CycleNo:
-                                cyccountmax = len(CycleNo)
-                                cyccount = cyccount + 1
-                                progressdata = progress(foldercount, foldercountmax, chnlcount, chnlcountmax, cyccount, cyccountmax)
-                                self.progressBar.setValue(int(progressdata))
-                                Dchgnamelist = FolderBase.split("\\")
-                                headername = Dchgnamelist[-2] + ", " + Dchgnamelist[-1] + ", " + str(CycNo) + "cy, "
-                                lgnd = "%04d" % CycNo
-                                if not check_cycler(cyclefolder):
-                                    Dchgtemp = toyo_dchg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate,
-                                                                      smoothdegree)
-                                else:
-                                    Dchgtemp = pne_dchg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate,
-                                                                     smoothdegree)
-                                if len(all_data_name) == 0:
-                                    temp_lgnd = ""
-                                else:	
-                                    temp_lgnd = all_data_name[i] + " " + lgnd
-                                if hasattr(Dchgtemp[1], "Profile"):
-                                    if len(Dchgtemp[1].Profile) > 2:
-                                        self.capacitytext.setText(str(Dchgtemp[0]))
-                                        graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Vol, Chg_ax1,
-                                                      0, 1.3, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "DOD", "Voltage(V)", temp_lgnd)
-                                        graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Vol, Chg_ax3,
-                                                      0, 1.3, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "DOD", "Voltage(V)", temp_lgnd)
-                                        graph_profile(Dchgtemp[1].Profile.dQdV, Dchgtemp[1].Profile.Vol, Chg_ax2,
-                                                      -5 * dqscale, 0.5 * dqscale, 0.5 * dqscale, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
-                                                      "dQdV", "Voltage(V)", temp_lgnd)
-                                        graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Crate, Chg_ax5,
-                                                      0, 1.3, 0.1, 0, 3.4, 0.2, "SOC", "C-rate", temp_lgnd)
-                                        graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.dVdQ, Chg_ax4,
-                                                      0, 1.3, 0.1, -5 * dvscale, 0.5 * dvscale, 0.5 * dvscale,
-                                                      "DOD", "dVdQ", temp_lgnd)
-                                        graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Temp, Chg_ax6,
-                                                      0, 1.3, 0.1, -15, 60, 5, "DOD", "Temp.", lgnd) # Data output option
-                                        if self.saveok.isChecked() and save_file_name:
-                                            Dchgtemp[1].Profile.to_excel(
-                                                writer,
-                                                startcol=writecolno,
-                                                index=False,
-                                                header=[
-                                                    headername + "Time(min)",
-                                                    headername + "DOD",
-                                                    headername + "Energy",
-                                                    headername + "Voltage",
-                                                    headername + "Crate",
-                                                    headername + "dQdV",
-                                                    headername + "dVdQ",
-                                                    headername + "Temp."
-                                                ])
-                                            writecolno = writecolno + 8
-                                        if self.ect_saveok.isChecked() and save_file_name:
-                                            Dchgtemp[1].Profile["TimeSec"] = Dchgtemp[1].Profile.TimeMin * 60
-                                            Dchgtemp[1].Profile["Curr"] = Dchgtemp[1].Profile.Crate * Dchgtemp[0] / 1000
-                                            continue_df = Dchgtemp[1].Profile.loc[:,["TimeSec", "Vol", "Curr", "Temp"]]
-                                            # 媛??댁쓣 ?뚯닔???먮━?섏뿉 留욊쾶 諛섏삱由?-                                            continue_df['TimeSec'] = continue_df['TimeSec'].round(1)  # ?뚯닔??1?먮━
-                                            continue_df['Vol'] = continue_df['Vol'].round(4)           # ?뚯닔??4?먮━
-                                            continue_df['Curr'] = continue_df['Curr'].round(4)         # ?뚯닔??4?먮━
-                                            continue_df['Temp'] = continue_df['Temp'].round(1)         # ?뚯닔??1?먮━
-                                            continue_df.to_csv(save_file_name +"_"+ "%04d" % CycNo + ".csv", index=False, sep=',',
-                                                                header=["time(s)",
-                                                                        "Voltage(V)",
-                                                                        "Current(A)",
-                                                                        "Temp."])
-                                title = Dchgnamelist[-2] + "=" + Dchgnamelist[-1]
-                                plt.suptitle(title, fontsize= 15, fontweight='bold')
-                                if len(all_data_name) != 0:
-                                    Chg_ax1.legend(loc="lower left")
-                                    Chg_ax2.legend(loc="upper left")
-                                    Chg_ax3.legend(loc="lower left")
-                                    Chg_ax4.legend(loc="lower left")
-                                    Chg_ax5.legend(loc="upper right")
-                                    Chg_ax6.legend(loc="upper right")
-                                else:
-                                    plt.legend(loc="center left", bbox_to_anchor=(1, 0.5))
-                                plt.tight_layout(pad=1, w_pad=1, h_pad=1)
-                            tab_layout.addWidget(toolbar)
-                            tab_layout.addWidget(canvas)
-                            self.cycle_tab.addTab(tab, str(tab_no))
-                            self.cycle_tab.setCurrentWidget(tab)
-                            tab_no = tab_no + 1
-                            plt.tight_layout(pad=1, w_pad=1, h_pad=1)
-                            output_fig(self.figsaveok, title)
-                else:
-                    for CycNo in CycleNo:
-                        chnlcount = chnlcount + 1
-                        chnlcountmax = len(subfolder)
-                        fig, ((Chg_ax1, Chg_ax2, Chg_ax3) ,(Chg_ax4, Chg_ax5, Chg_ax6)) = plt.subplots(
+            if not os.path.isdir(cyclefolder):
+                continue
+            subfolder = [f.path for f in os.scandir(cyclefolder) if f.is_dir()]
+            foldercountmax = len(all_data_folder)
+            foldercount += 1
+            #cyclefolder ??1?뚮쭔 ?몄텧
+            is_pne = check_cycler(cyclefolder)
+            if self.CycProfile.isChecked():
+                for j, FolderBase in enumerate(subfolder):
+                    chnlcount += 1
+                    chnlcountmax = len(subfolder)
+                    if "Pattern" not in FolderBase:
+                        fig, ((Chg_ax1, Chg_ax2, Chg_ax3), (Chg_ax4, Chg_ax5, Chg_ax6)) = plt.subplots(
                             nrows=2, ncols=3, figsize=(14, 10))
-                        tab = QtWidgets.QWidget()
-                        tab_layout = QtWidgets.QVBoxLayout(tab)
-                        canvas = FigureCanvas(fig)
-                        toolbar = NavigationToolbar(canvas, None)
-                        for FolderBase in subfolder:
-                            if "Pattern" not in FolderBase:
-                                cyccountmax = len(CycleNo)
-                                cyccount = cyccount + 1
-                                progressdata = progress(foldercount, foldercountmax, cyccount, cyccountmax, chnlcount, chnlcountmax)
-                                self.progressBar.setValue(int(progressdata))
-                                Dchgnamelist = FolderBase.split("\\")
-                                headername = Dchgnamelist[-2] + ", " + Dchgnamelist[-1] + ", " + str(CycNo) + "cy, "
-                                lgnd = Dchgnamelist[-1]
-                                if not check_cycler(cyclefolder):
+                        tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
+                        Dchgnamelist = None
+                        for CycNo in CycleNo:
+                            cyccountmax = len(CycleNo)
+                            cyccount += 1
+                            progressdata = progress(foldercount, foldercountmax, chnlcount, chnlcountmax, cyccount, cyccountmax)
+                            self.progressBar.setValue(int(50 + progressdata * 0.5))
+                            Dchgnamelist = FolderBase.split("\\")
+                            headername = Dchgnamelist[-2] + ", " + Dchgnamelist[-1] + ", " + str(CycNo) + "cy, "
+                            lgnd = "%04d" % CycNo
+                            # 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜
+                            Dchgtemp = loaded_data.get((i, j, CycNo))
+                            if Dchgtemp is None:
+                                if not is_pne:
                                     Dchgtemp = toyo_dchg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate, smoothdegree)
                                 else:
                                     Dchgtemp = pne_dchg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate, smoothdegree)
-                                if len(all_data_name) == 0:
-                                    temp_lgnd = ""
-                                else:	
-                                    temp_lgnd = all_data_name[i] + " " + lgnd
-                                if hasattr(Dchgtemp[1], "Profile"):
-                                    if len(Dchgtemp[1].Profile) > 2:
-                                        self.capacitytext.setText(str(Dchgtemp[0]))
-                                        graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Vol, Chg_ax1,
-                                                      0, 1.3, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "DOD", "Voltage(V)", temp_lgnd)
-                                        graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Vol, Chg_ax3,
-                                                      0, 1.3, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "DOD", "Voltage(V)", temp_lgnd)
-                                        graph_profile(Dchgtemp[1].Profile.dQdV, Dchgtemp[1].Profile.Vol, Chg_ax2,
-                                                      -5 * dqscale, 0.5 * dqscale, 0.5 * dqscale, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
-                                                      "dQdV", "Voltage(V)", temp_lgnd)
-                                        graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Crate, Chg_ax5,
-                                                      0, 1.3, 0.1, 0, 3.4, 0.2, "SOC", "C-rate", temp_lgnd)
-                                        graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.dVdQ, Chg_ax4,
-                                                      0, 1.3, 0.1, -5 * dvscale, 0.5 * self.dvscale, 0.5 * self.dvscale,
-                                                      "DOD", "dVdQ", temp_lgnd)
-                                        graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Temp, Chg_ax6,
-                                                      0, 1.3, 0.1, -15, 60, 5, "DOD", "Temp.", lgnd) 
-                                        # Data output option
-                                        if self.saveok.isChecked() and save_file_name:
-                                            Dchgtemp[1].Profile.to_excel(
-                                                writer,
-                                                startcol=writecolno,
-                                                index=False,
-                                                header=[
-                                                    headername + "Time(min)",
-                                                    headername + "DOD",
-                                                    headername + "Energy",
-                                                    headername + "Voltage",
-                                                    headername + "Crate",
-                                                    headername + "dQdV",
-                                                    headername + "dVdQ",
-                                                    headername + "Temp."
-                                                ])
-                                            writecolno = writecolno + 8
-                                        if self.ect_saveok.isChecked() and save_file_name:
-                                            Dchgtemp[1].Profile["TimeSec"] = Dchgtemp[1].Profile.TimeMin * 60
-                                            Dchgtemp[1].Profile["Curr"] = Dchgtemp[1].Profile.Crate * Dchgtemp[0] / 1000
-                                            continue_df = Dchgtemp[1].Profile.loc[:,["TimeSec", "Vol", "Curr", "Temp"]]
-                                            # 媛??댁쓣 ?뚯닔???먮━?섏뿉 留욊쾶 諛섏삱由?-                                            continue_df['TimeSec'] = continue_df['TimeSec'].round(1)  # ?뚯닔??1?먮━
-                                            continue_df['Vol'] = continue_df['Vol'].round(4)           # ?뚯닔??4?먮━
-                                            continue_df['Curr'] = continue_df['Curr'].round(4)         # ?뚯닔??4?먮━
-                                            continue_df['Temp'] = continue_df['Temp'].round(1)         # ?뚯닔??1?먮━
-                                            continue_df.to_csv(save_file_name + "_" + Dchgnamelist[-1] + ".csv", index=False, sep=',',
-                                                                header=["time(s)",
-                                                                        "Voltage(V)",
-                                                                        "Current(A)",
-                                                                        "Temp."])
-                                title = Dchgnamelist[-2] + "=" + "%04d" % CycNo
-                                plt.suptitle(title, fontsize= 15, fontweight='bold')
-                                if len(all_data_name) != 0:
-                                    Chg_ax1.legend(loc="lower left")
-                                    Chg_ax2.legend(loc="upper left")
-                                    Chg_ax3.legend(loc="lower left")
-                                    Chg_ax4.legend(loc="lower left")
-                                    Chg_ax5.legend(loc="upper right")
-                                    Chg_ax6.legend(loc="upper right")
-                                else:
-                                    plt.legend(loc="center left", bbox_to_anchor=(1, 0.5))
-                                plt.tight_layout(pad=1, w_pad=1, h_pad=1)
-                        tab_layout.addWidget(toolbar)
-                        tab_layout.addWidget(canvas)
-                        self.cycle_tab.addTab(tab, str(tab_no))
-                        self.cycle_tab.setCurrentWidget(tab)
-                        tab_no = tab_no + 1
-                        plt.tight_layout(pad=1, w_pad=1, h_pad=1)
+                            temp_lgnd = "" if len(all_data_name) == 0 else all_data_name[i] + " " + lgnd
+                            if hasattr(Dchgtemp[1], "Profile"):
+                                if len(Dchgtemp[1].Profile) > 2:
+                                    self.capacitytext.setText(str(Dchgtemp[0]))
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Vol, Chg_ax1,
+                                                  -0.1, 1.2, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "DOD", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Vol, Chg_ax3,
+                                                  -0.1, 1.2, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "DOD", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.dQdV, Dchgtemp[1].Profile.Vol, Chg_ax2,
+                                                  -5 * dqscale, 0.5 * dqscale, 0.5 * dqscale, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
+                                                  "dQdV", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Crate, Chg_ax5,
+                                                  -0.1, 1.2, 0.1, 0, 3.4, 0.2, "SOC", "C-rate", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.dVdQ, Chg_ax4,
+                                                  -0.1, 1.2, 0.1, -5 * dvscale, 0.5 * dvscale, 0.5 * dvscale,
+                                                  "DOD", "dVdQ", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Temp, Chg_ax6,
+                                                  -0.1, 1.2, 0.1, -15, 60, 5, "DOD", "Temp.", lgnd)
+                                    if self.saveok.isChecked() and save_file_name:
+                                        Dchgtemp[1].Profile.to_excel(
+                                            writer, startcol=writecolno, index=False,
+                                            header=[headername + "Time(min)", headername + "DOD", headername + "Energy",
+                                                    headername + "Voltage", headername + "Crate", headername + "dQdV",
+                                                    headername + "dVdQ", headername + "Temp."])
+                                        writecolno += 8
+                                    if self.ect_saveok.isChecked() and save_file_name:
+                                        continue_df = Dchgtemp[1].Profile[["TimeMin", "Vol", "Crate", "Temp"]].copy()
+                                        continue_df["TimeSec"] = (continue_df["TimeMin"] * 60).round(1)
+                                        continue_df["Curr"] = (continue_df["Crate"] * Dchgtemp[0] / 1000).round(4)
+                                        continue_df["Vol"] = continue_df["Vol"].round(4)
+                                        continue_df["Temp"] = continue_df["Temp"].round(1)
+                                        continue_df = continue_df[["TimeSec", "Vol", "Curr", "Temp"]]
+                                        continue_df.to_csv(save_file_name + "_" + "%04d" % CycNo + ".csv", index=False, sep=',',
+                                                            header=["time(s)", "Voltage(V)", "Current(A)", "Temp."])
+                        if Dchgnamelist:
+                            title = Dchgnamelist[-2] + "=" + Dchgnamelist[-1]
+                            plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
+                            axes_list = [Chg_ax1, Chg_ax2, Chg_ax3, Chg_ax4, Chg_ax5, Chg_ax6]
+                            positions = ["lower left", "upper left", "lower left", "lower left", "upper right", "upper right"]
+                            self._setup_legend(axes_list, all_data_name, positions, fig=fig)
+                        self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
+                        tab_no += 1
                         output_fig(self.figsaveok, title)
-                plt.tight_layout(pad=1, w_pad=1, h_pad=1)
-                plt.close()
+            elif all_profile:
+                # ?꾩껜 ?듯빀: 紐⑤뱺 cyclefolder???횞?ъ씠?댁쓣 ?ъ쟾 ?앹꽦??1媛?fig???ㅻ쾭?덉씠
+                for j, FolderBase in enumerate(subfolder):
+                    chnlcount += 1
+                    chnlcountmax = len(subfolder)
+                    if "Pattern" not in FolderBase:
+                        for CycNo in CycleNo:
+                            cyccountmax = len(CycleNo)
+                            cyccount += 1
+                            progressdata = progress(foldercount, foldercountmax, chnlcount, chnlcountmax, cyccount, cyccountmax)
+                            self.progressBar.setValue(int(50 + progressdata * 0.5))
+                            last_Dchgnamelist = FolderBase.split("\\")
+                            headername = last_Dchgnamelist[-2] + ", " + last_Dchgnamelist[-1] + ", " + str(CycNo) + "cy, "
+                            lgnd = last_Dchgnamelist[-1] + " %04d" % CycNo
+                            # 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜
+                            Dchgtemp = loaded_data.get((i, j, CycNo))
+                            if Dchgtemp is None:
+                                if not is_pne:
+                                    Dchgtemp = toyo_dchg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate, smoothdegree)
+                                else:
+                                    Dchgtemp = pne_dchg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate, smoothdegree)
+                            temp_lgnd = lgnd if len(all_data_name) == 0 else all_data_name[i] + " " + lgnd
+                            if hasattr(Dchgtemp[1], "Profile"):
+                                if len(Dchgtemp[1].Profile) > 2:
+                                    self.capacitytext.setText(str(Dchgtemp[0]))
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Vol, Chg_ax1,
+                                                  -0.1, 1.2, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "DOD", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Vol, Chg_ax3,
+                                                  -0.1, 1.2, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "DOD", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.dQdV, Dchgtemp[1].Profile.Vol, Chg_ax2,
+                                                  -5 * dqscale, 0.5 * dqscale, 0.5 * dqscale, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
+                                                  "dQdV", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Crate, Chg_ax5,
+                                                  -0.1, 1.2, 0.1, 0, 3.4, 0.2, "SOC", "C-rate", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.dVdQ, Chg_ax4,
+                                                  -0.1, 1.2, 0.1, -5 * dvscale, 0.5 * dvscale, 0.5 * dvscale,
+                                                  "DOD", "dVdQ", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Temp, Chg_ax6,
+                                                  -0.1, 1.2, 0.1, -15, 60, 5, "DOD", "Temp.", lgnd)
+                                    if self.saveok.isChecked() and save_file_name:
+                                        Dchgtemp[1].Profile.to_excel(
+                                            writer, startcol=writecolno, index=False,
+                                            header=[headername + "Time(min)", headername + "DOD", headername + "Energy",
+                                                    headername + "Voltage", headername + "Crate", headername + "dQdV",
+                                                    headername + "dVdQ", headername + "Temp."])
+                                        writecolno += 8
             else:
-                err_msg('?뚯씪 or ?대뜑 ?놁쓬!!','?뚯씪 or ?대뜑 ?놁쓬!!')
-                return
-        self.progressBar.setValue(100)
+                for CycNo in CycleNo:
+                    chnlcount += 1
+                    chnlcountmax = len(subfolder)
+                    fig, ((Chg_ax1, Chg_ax2, Chg_ax3), (Chg_ax4, Chg_ax5, Chg_ax6)) = plt.subplots(
+                        nrows=2, ncols=3, figsize=(14, 10))
+                    tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
+                    Dchgnamelist = None
+                    for j, FolderBase in enumerate(subfolder):
+                        if "Pattern" not in FolderBase:
+                            cyccountmax = len(CycleNo)
+                            cyccount += 1
+                            progressdata = progress(foldercount, foldercountmax, cyccount, cyccountmax, chnlcount, chnlcountmax)
+                            self.progressBar.setValue(int(50 + progressdata * 0.5))
+                            Dchgnamelist = FolderBase.split("\\")
+                            headername = Dchgnamelist[-2] + ", " + Dchgnamelist[-1] + ", " + str(CycNo) + "cy, "
+                            lgnd = Dchgnamelist[-1]
+                            # 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜
+                            Dchgtemp = loaded_data.get((i, j, CycNo))
+                            if Dchgtemp is None:
+                                if not is_pne:
+                                    Dchgtemp = toyo_dchg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate, smoothdegree)
+                                else:
+                                    Dchgtemp = pne_dchg_Profile_data(FolderBase, CycNo, mincapacity, mincrate, firstCrate, smoothdegree)
+                            temp_lgnd = "" if len(all_data_name) == 0 else all_data_name[i] + " " + lgnd
+                            if hasattr(Dchgtemp[1], "Profile"):
+                                if len(Dchgtemp[1].Profile) > 2:
+                                    self.capacitytext.setText(str(Dchgtemp[0]))
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Vol, Chg_ax1,
+                                                  -0.1, 1.2, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "DOD", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Vol, Chg_ax3,
+                                                  -0.1, 1.2, 0.1, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "DOD", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.dQdV, Dchgtemp[1].Profile.Vol, Chg_ax2,
+                                                  -5 * dqscale, 0.5 * dqscale, 0.5 * dqscale, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
+                                                  "dQdV", "Voltage(V)", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Crate, Chg_ax5,
+                                                  -0.1, 1.2, 0.1, 0, 3.4, 0.2, "SOC", "C-rate", temp_lgnd)
+                                    # [踰꾧렇?섏젙] self.dvscale ??dvscale (濡쒖뺄 蹂???ъ슜)
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.dVdQ, Chg_ax4,
+                                                  -0.1, 1.2, 0.1, -5 * dvscale, 0.5 * dvscale, 0.5 * dvscale,
+                                                  "DOD", "dVdQ", temp_lgnd)
+                                    graph_profile(Dchgtemp[1].Profile.SOC, Dchgtemp[1].Profile.Temp, Chg_ax6,
+                                                  -0.1, 1.2, 0.1, -15, 60, 5, "DOD", "Temp.", lgnd)
+                                    if self.saveok.isChecked() and save_file_name:
+                                        Dchgtemp[1].Profile.to_excel(
+                                            writer, startcol=writecolno, index=False,
+                                            header=[headername + "Time(min)", headername + "DOD", headername + "Energy",
+                                                    headername + "Voltage", headername + "Crate", headername + "dQdV",
+                                                    headername + "dVdQ", headername + "Temp."])
+                                        writecolno += 8
+                                    if self.ect_saveok.isChecked() and save_file_name:
+                                        continue_df = Dchgtemp[1].Profile[["TimeMin", "Vol", "Crate", "Temp"]].copy()
+                                        continue_df["TimeSec"] = (continue_df["TimeMin"] * 60).round(1)
+                                        continue_df["Curr"] = (continue_df["Crate"] * Dchgtemp[0] / 1000).round(4)
+                                        continue_df["Vol"] = continue_df["Vol"].round(4)
+                                        continue_df["Temp"] = continue_df["Temp"].round(1)
+                                        continue_df = continue_df[["TimeSec", "Vol", "Curr", "Temp"]]
+                                        continue_df.to_csv(save_file_name + "_" + Dchgnamelist[-1] + ".csv", index=False, sep=',',
+                                                            header=["time(s)", "Voltage(V)", "Current(A)", "Temp."])
+                    if Dchgnamelist:
+                        title = Dchgnamelist[-2] + "=" + "%04d" % CycNo
+                        plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
+                        axes_list = [Chg_ax1, Chg_ax2, Chg_ax3, Chg_ax4, Chg_ax5, Chg_ax6]
+                        positions = ["lower left", "upper left", "lower left", "lower left", "upper right", "upper right"]
+                        self._setup_legend(axes_list, all_data_name, positions, fig=fig)
+                    self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
+                    tab_no += 1
+                    output_fig(self.figsaveok, title)
+        # AllProfile: 猷⑦봽 醫낅즺 ???쒕쾲??finalize
+        if all_profile and last_Dchgnamelist:
+            title = last_Dchgnamelist[-2] + " All"
+            plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
+            axes_list = [Chg_ax1, Chg_ax2, Chg_ax3, Chg_ax4, Chg_ax5, Chg_ax6]
+            positions = ["lower left", "upper left", "lower left", "lower left", "upper right", "upper right"]
+            self._setup_legend(axes_list, all_data_name, positions, fig=fig)
+            self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
+            tab_no += 1
+            output_fig(self.figsaveok, title)
         if self.saveok.isChecked() and save_file_name:
             writer.close()
+        self.progressBar.setValue(100)
+        plt.close()
 
     def continue_confirm_button(self):
         if self.chk_ectpath.isChecked():
@@ -10471,16 +11538,10 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                                                                 "Current(A)",
                                                                 "Temp."])
                             title = step_namelist[-2] + "=" + "%04d" % Step_CycNo
-                            plt.suptitle(title, fontsize= 15, fontweight='bold')
-                            if len(all_data_name) != 0:
-                                step_ax1.legend(loc="lower left")
-                                step_ax2.legend(loc="lower right")
-                                step_ax3.legend(loc="upper right")
-                                step_ax4.legend(loc="lower right")
-                                step_ax5.legend(loc="lower left")
-                                step_ax6.legend(loc="upper right")
-                            else:
-                                plt.legend(loc="center left", bbox_to_anchor=(1, 0.5))
+                            plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
+                            axes_list = [step_ax1, step_ax2, step_ax3, step_ax4, step_ax5, step_ax6]
+                            positions = ["lower left", "lower right", "upper right", "lower right", "lower left", "upper right"]
+                            self._setup_legend(axes_list, all_data_name, positions, fig=fig)
                             tab_layout.addWidget(toolbar)
                             tab_layout.addWidget(canvas)
                             self.cycle_tab.addTab(tab, str(tab_no))
@@ -10499,9 +11560,8 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         firstCrate, mincapacity, CycleNo = config[0], config[1], config[2]
         smoothdegree, mincrate, dqscale, dvscale = config[3], config[4], config[5], config[6]
         all_data_name = []
-        # ?⑸웾 ?좎젙 愿??-        global writer
-        if "-" in self.stepnum.toPlainText():
+        #global writer ?쒓굅 ??濡쒖뺄 蹂?섎줈留??ъ슜
+        if self.stepnum.toPlainText().strip():
             write_column_num, write_column_num2, folder_count, chnlcount, cyccount = 0, 0, 0, 0, 0
             pne_path = self.pne_path_setting()
             all_data_folder = pne_path[0]
@@ -10511,135 +11571,174 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
             writer, save_file_name = self._setup_file_writer()
             self.ContinueConfirm.setEnabled(True)
             chg_dchg_dcir_no = list((self.stepnum.toPlainText().split(" ")))
+            
+            # step_ranges ?ъ쟾 ?뚯떛 諛?蹂묐젹 濡쒕뵫
+            step_ranges = []
+            for dcir_step in chg_dchg_dcir_no:
+                if "-" in dcir_step:
+                    s, e = map(int, dcir_step.split("-"))
+                else:
+                    s = int(dcir_step)
+                    e = s
+                step_ranges.append((s, e))
+            self.progressBar.setValue(0)
+            loaded_data = self._load_all_profile_data_parallel(
+                all_data_folder, 'continue', (step_ranges, mincapacity, firstCrate, ""), max_workers=4)
+            
             tab_no = 0
+            all_profile = self.AllProfile.isChecked()
+            # AllProfile: ?ъ쟾??fig/tab 1媛??앹꽦
+            if all_profile:
+                fig, ((step_ax1, step_ax2, step_ax3), (step_ax4, step_ax5, step_ax6)) = plt.subplots(
+                    nrows=2, ncols=3, figsize=(14, 10))
+                tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
+                last_namelist = None
             for i, cyclefolder in enumerate(all_data_folder):
-                if os.path.isdir(cyclefolder):
-                    subfolder = [f.path for f in os.scandir(cyclefolder) if f.is_dir()]
-                    foldercountmax = len(all_data_folder)
-                    folder_count = folder_count + 1
-                    for FolderBase in subfolder:
-                        chnlcount = chnlcount + 1
-                        chnlcountmax = len(subfolder)
-                        for dcir_continue_step in chg_dchg_dcir_no:
-                            if "-" in dcir_continue_step:
-                                Step_CycNo, Step_CycEnd = map(int, dcir_continue_step.split("-"))
-                                CycleNo = range(Step_CycNo, Step_CycEnd + 1)
-                                if "Pattern" not in FolderBase:
-                                    fig, ((step_ax1, step_ax2, step_ax3) ,(step_ax4, step_ax5, step_ax6)) = plt.subplots( nrows=2, ncols=3, figsize=(14, 10))
-                                    # ?⑥닔 ?ъ슜?쇰줈 蹂寃?-                                    tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
-                                    cyccountmax = len(CycleNo)
-                                    cyccount = cyccount + 1
-                                    progressdata = progress(folder_count, foldercountmax, cyccount, cyccountmax, chnlcount, chnlcountmax)
-                                    self.progressBar.setValue(int(progressdata))
-                                    step_namelist = FolderBase.split("\\")
-                                    headername = step_namelist[-2] + ", " + step_namelist[-1] + ", " + str( Step_CycNo)
-                                    headername = headername + "-" + str(Step_CycEnd) + "cy, "
-                                    if self.CycProfile.isChecked():
-                                        lgnd = "%04d" % Step_CycNo
-                                    else:
-                                        lgnd = step_namelist[-1]
-                                    if not check_cycler(cyclefolder):
-                                        err_msg("Toyo??以鍮?以?, "?좎슂???쒓컙?섎㈃ 異붽??좉퍡??^^;")
+                if not os.path.isdir(cyclefolder):
+                    continue
+                subfolder = [f.path for f in os.scandir(cyclefolder) if f.is_dir()]
+                foldercountmax = len(all_data_folder)
+                folder_count += 1
+                #cyclefolder ??1?뚮쭔 ?몄텧
+                is_pne = check_cycler(cyclefolder)
+                for j, FolderBase in enumerate(subfolder):
+                    chnlcount += 1
+                    chnlcountmax = len(subfolder)
+                    for dcir_continue_step in chg_dchg_dcir_no:
+                        if "-" in dcir_continue_step:
+                            Step_CycNo, Step_CycEnd = map(int, dcir_continue_step.split("-"))
+                        else:
+                            Step_CycNo, Step_CycEnd = int(dcir_continue_step), int(dcir_continue_step)
+                        CycleNo = range(Step_CycNo, Step_CycEnd + 1)
+                        if "Pattern" in FolderBase:
+                            continue
+                        if not all_profile:
+                            fig, ((step_ax1, step_ax2, step_ax3), (step_ax4, step_ax5, step_ax6)) = plt.subplots(
+                                nrows=2, ncols=3, figsize=(14, 10))
+                            tab, tab_layout, canvas, toolbar = self._create_plot_tab(fig, tab_no)
+                        cyccountmax = len(CycleNo)
+                        cyccount += 1
+                        progressdata = progress(folder_count, foldercountmax, cyccount, cyccountmax, chnlcount, chnlcountmax)
+                        self.progressBar.setValue(int(50 + progressdata * 0.5))
+                        step_namelist = FolderBase.split("\\")
+                        headername = step_namelist[-2] + ", " + step_namelist[-1] + ", " + str(Step_CycNo)
+                        if Step_CycNo == Step_CycEnd:
+                            headername = headername + "cy, "
+                        else:
+                            headername = headername + "-" + str(Step_CycEnd) + "cy, "
+                        if all_profile:
+                            lgnd = step_namelist[-1] + " %04d" % Step_CycNo
+                        elif self.CycProfile.isChecked():
+                            lgnd = "%04d" % Step_CycNo
+                        else:
+                            lgnd = step_namelist[-1]
+                        # 蹂묐젹 濡쒕뵫 寃곌낵 ?ъ슜
+                        temp = loaded_data.get((i, j, (Step_CycNo, Step_CycEnd)))
+                        if temp is None:
+                            if not is_pne:
+                                # fallback: ?쇰━ ?ъ씠?????뚯씪 踰덊샇 蹂????濡쒕뵫
+                                cm, _ = toyo_build_cycle_map(FolderBase, mincapacity, firstCrate)
+                                if cm:
+                                    fb_start = cm.get(Step_CycNo, (Step_CycNo, Step_CycNo))[0]
+                                    fb_end = cm.get(Step_CycEnd, (Step_CycEnd, Step_CycEnd))[1]
+                                else:
+                                    fb_start, fb_end = Step_CycNo, Step_CycEnd
+                                temp = toyo_Profile_continue_data(FolderBase, fb_start, fb_end, mincapacity, firstCrate)
+                            else:
+                                temp = pne_Profile_continue_data(FolderBase, Step_CycNo, Step_CycEnd, mincapacity, firstCrate, "")
+                        if all_profile:
+                            temp_lgnd = lgnd if len(all_data_name) == 0 else all_data_name[i] + " " + lgnd
+                        else:
+                            temp_lgnd = "" if len(all_data_name) == 0 else all_data_name[i]
+                        if hasattr(temp[1], "stepchg"):
+                            if len(temp[1].stepchg) > 2:
+                                self.capacitytext.setText(str(temp[0]))
+                                has_ocv = "OCV" in temp[1].stepchg.columns
+                                graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.Vol, step_ax1,
+                                               self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "Time(min)", "Voltage(V)", temp_lgnd)
+                                graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.Vol, step_ax4,
+                                               self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "Time(min)", "Voltage(V)", temp_lgnd)
+                                if has_ocv:
+                                    graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.OCV, step_ax4,
+                                                   self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "Time(min)", "OCV/CCV", "OCV_" + temp_lgnd, "o")
+                                    graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.CCV, step_ax4,
+                                                   self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap, "Time(min)", "OCV/CCV", "CCV_" + temp_lgnd, "o")
+                                graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.Crate, step_ax2,
+                                               -1.8, 1.7, 0.2, "Time(min)", "C-rate", temp_lgnd)
+                                if len(temp) > 2 and hasattr(temp[2], 'AccCap') and not temp[2].empty:
+                                    graph_continue(temp[2].AccCap, temp[2].OCV, step_ax5, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
+                                                   "SOC", "OCV/CCV", "OCV_" + temp_lgnd, "o")
+                                    graph_continue(temp[2].AccCap, temp[2].CCV, step_ax5, self.vol_y_hlimit, self.vol_y_llimit, self.vol_y_gap,
+                                                   "SOC", "OCV/CCV", "CCV_" + temp_lgnd, "o")
+                                graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.SOC, step_ax3,
+                                               0, 1.2, 0.1, "Time(min)", "SOC", temp_lgnd)
+                                graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.Temp, step_ax6,
+                                               -15, 60, 5, "Time(min)", "Temp.", lgnd)
+                                                                    
+                                if self.saveok.isChecked() and save_file_name:
+                                    if has_ocv:
+                                        excel_df = temp[1].stepchg[["TimeSec", "Vol", "Curr", "OCV", "CCV",
+                                                                     "Crate", "SOC", "Temp"]].copy()
+                                        excel_df.to_excel(writer, sheet_name="Profile", startcol=write_column_num,
+                                                         index=False,
+                                                         header=[headername + "time(s)", headername + "Voltage(V)",
+                                                                 headername + "Current(A)", headername + "OCV",
+                                                                 headername + "CCV", headername + "Crate",
+                                                                 headername + "SOC", headername + "Temp."])
+                                        write_column_num += 8
+                                        temp[2].to_excel(writer, sheet_name="OCV_CCV", startcol=write_column_num2,
+                                                         index=False,
+                                                         header=[headername + "SOC", headername + "OCV",
+                                                                 headername + "CCV"])
+                                        write_column_num2 += 3
                                     else:
-                                        temp = pne_Profile_continue_data(FolderBase, Step_CycNo, Step_CycEnd, mincapacity, firstCrate, "")
-                                        if len(all_data_name) == 0:
-                                            temp_lgnd = ""
-                                        else:	
-                                            temp_lgnd = all_data_name[i]
-                                        if hasattr(temp[1], "stepchg"):
-                                            if len(temp[1].stepchg) > 2:
-                                                self.capacitytext.setText(str(temp[0]))
-                                                graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.Vol, step_ax1,
-                                                               2.0, 4.8, 0.2, "Time(min)", "Voltage(V)",temp_lgnd)
-                                                graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.Vol, step_ax4,
-                                                               2.0, 4.8, 0.2, "Time(min)", "Voltage(V)",temp_lgnd)
-                                                graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.OCV, step_ax4,
-                                                               2.0, 4.8, 0.2, "Time(min)", "OCV/CCV", "OCV_" + temp_lgnd, "o")
-                                                graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.CCV, step_ax4,
-                                                               2.0, 4.8, 0.2, "Time(min)", "OCV/CCV", "CCV_" + temp_lgnd, "o")
-                                                graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.Crate, step_ax2,
-                                                               -1.8, 1.7, 0.2, "Time(min)", "C-rate",temp_lgnd)
-                                                graph_continue(temp[2].AccCap, temp[2].OCV, step_ax5, 2.0, 4.8, 0.2,
-                                                               "SOC", "OCV/CCV", "OCV_" + temp_lgnd, "o") 
-                                                graph_continue(temp[2].AccCap, temp[2].CCV, step_ax5, 2.0, 4.8, 0.2,
-                                                               "SOC", "OCV/CCV", "CCV_" + temp_lgnd, "o")
-                                                graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.SOC, step_ax3,
-                                                               0, 1.2, 0.1, "Time(min)", "SOC", temp_lgnd)
-                                                graph_continue(temp[1].stepchg.TimeMin, temp[1].stepchg.Temp, step_ax6,
-                                                               -15, 60, 5, "Time(min)", "Temp.", lgnd)
-                                                # Data output option
-                                                if self.saveok.isChecked() and save_file_name:
-                                                    temp[1].stepchg = temp[1].stepchg.loc[:,["TimeSec", "Vol", "Curr","OCV", "CCV",
-                                                                                             "Crate", "SOC", "Temp"]]
-                                                    temp[1].stepchg.to_excel(writer, sheet_name="Profile", startcol=write_column_num,
-                                                                             index=False,
-                                                                             header=[headername + "time(s)",
-                                                                                     headername + "Voltage(V)",
-                                                                                     headername + "Current(A)",
-                                                                                     headername + "OCV",
-                                                                                     headername + "CCV",
-                                                                                     headername + "Crate",
-                                                                                     headername + "SOC",
-                                                                                     headername + "Temp."])
-                                                    write_column_num = write_column_num + 8
-                                                    temp[2].to_excel(writer, sheet_name="OCV_CCV", startcol=write_column_num2,
-                                                                     index=False,
-                                                                     header=[headername + "SOC",
-                                                                             headername + "OCV",
-                                                                             headername + "CCV"])
-                                                    write_column_num2 = write_column_num2 + 3
-                                                if self.ect_saveok.isChecked() and save_file_name:
-                                                    temp[1].stepchg["TimeSec"] = temp[1].stepchg.TimeMin * 60
-                                                    temp[1].stepchg["Curr"] = temp[1].stepchg.Crate * temp[0] / 1000
-                                                    continue_df = temp[1].stepchg.loc[:,["TimeSec", "Vol", "Curr", "Temp"]]
-                                                    # 媛??댁쓣 ?뚯닔???먮━?섏뿉 留욊쾶 諛섏삱由?-                                                    continue_df['TimeSec'] = continue_df['TimeSec'].round(1)  # ?뚯닔??1?먮━
-                                                    continue_df['Vol'] = continue_df['Vol'].round(4)           # ?뚯닔??4?먮━
-                                                    continue_df['Curr'] = continue_df['Curr'].round(4)         # ?뚯닔??4?먮━
-                                                    continue_df['Temp'] = continue_df['Temp'].round(1)         # ?뚯닔??1?먮━
-                                                    continue_df.to_csv((save_file_name + "_" + "%04d" % tab_no + ".csv"), index=False, sep=',',
-                                                                        header=["time(s)",
-                                                                                "Voltage(V)",
-                                                                                "Current(A)",
-                                                                                "Temp."])
-                                        if self.CycProfile.isChecked():
-                                            title = step_namelist[-2] + "=" + step_namelist[-1]
-                                        else:
-                                            title = step_namelist[-2] + "=" + "%04d" % Step_CycNo
-                                        plt.suptitle(title, fontsize= 15, fontweight='bold')
-                                        if len(all_data_name) != 0:
-                                            step_ax1.legend(loc="lower left")
-                                            step_ax2.legend(loc="lower right")
-                                            step_ax3.legend(loc="upper right")
-                                            step_ax4.legend(loc="lower right")
-                                            step_ax5.legend(loc="lower left")
-                                            step_ax6.legend(loc="upper right")
-                                        else:
-                                            plt.legend(loc="center left", bbox_to_anchor=(1, 0.5))
-                                        if self.CycProfile.isChecked():
-                                            tab_layout.addWidget(toolbar)
-                                            tab_layout.addWidget(canvas)
-                                            self.cycle_tab.addTab(tab, str(tab_no))
-                                            self.cycle_tab.setCurrentWidget(tab)
-                                            tab_no = tab_no + 1
-                                            plt.tight_layout(pad=1, w_pad=1, h_pad=1)
-                                            output_fig(self.figsaveok, title)
-                                        else:
-                                            tab_layout.addWidget(toolbar)
-                                            tab_layout.addWidget(canvas)
-                                            self.cycle_tab.addTab(tab, str(tab_no))
-                                            self.cycle_tab.setCurrentWidget(tab)
-                                            # tab_no = tab_no + 1
-                                            plt.tight_layout(pad=1, w_pad=1, h_pad=1)
-                                            output_fig(self.figsaveok, title)
+                                        excel_df = temp[1].stepchg[["TimeMin", "SOC", "Vol", "Crate", "Temp"]].copy()
+                                        excel_df.to_excel(writer, sheet_name="Profile", startcol=write_column_num,
+                                                         index=False,
+                                                         header=[headername + "Time(min)", headername + "SOC",
+                                                                 headername + "Voltage(V)", headername + "Crate",
+                                                                 headername + "Temp."])
+                                        write_column_num += 5
+                                if self.ect_saveok.isChecked() and save_file_name:
+                                    continue_df = temp[1].stepchg[["TimeMin", "Vol", "Crate", "Temp"]].copy()
+                                    continue_df["TimeSec"] = (continue_df["TimeMin"] * 60).round(1)
+                                    continue_df["Curr"] = (continue_df["Crate"] * temp[0] / 1000).round(4)
+                                    continue_df["Vol"] = continue_df["Vol"].round(4)
+                                    continue_df["Temp"] = continue_df["Temp"].round(1)
+                                    continue_df = continue_df[["TimeSec", "Vol", "Curr", "Temp"]]
+                                    continue_df.to_csv(save_file_name + "_" + "%04d" % tab_no + ".csv",
+                                                       index=False, sep=',',
+                                                       header=["time(s)", "Voltage(V)", "Current(A)", "Temp."])
+                        if all_profile:
+                            last_namelist = step_namelist
+                        else:
+                            title = step_namelist[-2] + "=" + step_namelist[-1] if self.CycProfile.isChecked() else step_namelist[-2] + "=" + "%04d" % Step_CycNo
+                            plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
+                            
+                            axes_list = [step_ax1, step_ax2, step_ax3, step_ax4, step_ax5, step_ax6]
+                            positions = ["lower left", "lower right", "upper right", "lower right", "lower left", "upper right"]
+                            self._setup_legend(axes_list, all_data_name, positions, fig=fig)
+                            
+                            self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
+                            if self.CycProfile.isChecked():
+                                tab_no += 1
+                            output_fig(self.figsaveok, title)
+            # AllProfile: 猷⑦봽 醫낅즺 ???쒕쾲??finalize
+            if all_profile and last_namelist:
+                title = last_namelist[-2] + " All"
+                plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
+                axes_list = [step_ax1, step_ax2, step_ax3, step_ax4, step_ax5, step_ax6]
+                positions = ["lower left", "lower right", "upper right", "lower right", "lower left", "upper right"]
+                self._setup_legend(axes_list, all_data_name, positions, fig=fig)
+                self._finalize_plot_tab(tab, tab_layout, canvas, toolbar, tab_no)
+                tab_no += 1
+                output_fig(self.figsaveok, title)
             if self.saveok.isChecked() and save_file_name:
                 writer.close()
             self.progressBar.setValue(100)
-            plt.tight_layout(pad=1, w_pad=1, h_pad=1)
             plt.close()
         else:
-            err_msg('Step ?먮윭','Step??3-5 媛숈? ?곗냽 ?뺤떇?쇰줈 ?ｌ뼱二쇱꽭??')
+            err_msg('Step ?먮윭','Step???ъ씠??踰덊샇瑜??ｌ뼱二쇱꽭?? ?? 2 3-5 8')
             self.ContinueConfirm.setEnabled(True)
 
     def dcir_confirm_button(self):
@@ -10674,96 +11773,98 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                         for dcir_continue_step in chg_dchg_dcir_no:
                             if "-" in dcir_continue_step:
                                 Step_CycNo, Step_CycEnd = map(int, dcir_continue_step.split("-"))
-                                CycleNo = range(Step_CycNo, Step_CycEnd + 1)
-                                if "Pattern" not in FolderBase:
-                                    fig, ((step_ax1, step_ax3), (step_ax2, step_ax4)) = plt.subplots(
-                                        nrows=2, ncols=2, figsize=(14, 8))
-                                    tab = QtWidgets.QWidget()
-                                    tab_layout = QtWidgets.QVBoxLayout(tab)
-                                    canvas = FigureCanvas(fig)
-                                    toolbar = NavigationToolbar(canvas, None)
-                                    cyccountmax = len(CycleNo)
-                                    cyccount = cyccount + 1
-                                    progressdata = progress(folder_count, foldercountmax, chnlcount, chnlcountmax, cyccount, cyccountmax)
-                                    self.progressBar.setValue(int(progressdata))
-                                    step_namelist = FolderBase.split("\\")
-                                    headername = step_namelist[-2] + ", " + step_namelist[-1]
-                                    if self.CycProfile.isChecked():
-                                        lgnd = "%04d" % Step_CycNo
-                                    else:
-                                        lgnd = step_namelist[-1]
-                                    if not check_cycler(cyclefolder):
-                                        err_msg("PNE 異⑸갑?꾧린 ?ъ슜 ?붿껌", "DCIR? PNE 異⑸갑?꾧린瑜??ъ슜?섏뿬 痢≪젙 遺???쒕┰?덈떎.")
-                                    else:
-                                        temp = pne_dcir_Profile_data(FolderBase, Step_CycNo, Step_CycEnd, mincapacity, firstCrate)
-                                        if (temp is not None) and hasattr(temp[1], "AccCap"):
-                                            if len(temp[1]) > 2:
-                                                self.capacitytext.setText(str(temp[0]))
-                                                graph_soc_continue(temp[1].SOC, temp[1].OCV, step_ax1, 2.0, 4.8, 0.2, "SOC", "OCV/CCV", "OCV", "o")
-                                                graph_soc_continue(temp[1].SOC, temp[1].rOCV, step_ax1, 2.0, 4.8, 0.2, "SOC", "OCV/CCV", "rOCV", "o")
-                                                graph_soc_continue(temp[1].SOC, temp[1].CCV, step_ax1, 2.0, 4.8, 0.2, "SOC", "OCV/CCV","CCV", "o")
-                                                graph_soc_dcir(temp[1].SOC, temp[1].iloc[:, 7], step_ax2, "SOC", "DCIR(m??", " 0.1s DCIR", "o")
-                                                graph_soc_dcir(temp[1].SOC, temp[1].iloc[:, 8], step_ax2, "SOC", "DCIR(m??", " 1.0s DCIR", "o")
-                                                graph_soc_dcir(temp[1].SOC, temp[1].iloc[:, 9], step_ax2, "SOC", "DCIR(m??", "10.0s DCIR", "o")
-                                                graph_soc_dcir(temp[1].SOC, temp[1].iloc[:, 10], step_ax2, "SOC", "DCIR(m??", "20.0s DCIR", "o")
-                                                graph_soc_dcir(temp[1].SOC, temp[1].RSS, step_ax2, "SOC", "DCIR(m??", "RSS DCIR", "o")
-                                                graph_continue(temp[1].OCV, temp[1].SOC, step_ax3, -20, 120, 10, "Voltage (V)", "SOC","OCV", "o")
-                                                graph_continue(temp[1].CCV, temp[1].SOC, step_ax3, -20, 120, 10, "Voltage (V)", "SOC","CCV", "o")
-                                                graph_dcir(temp[1].OCV, temp[1].iloc[:, 7], step_ax4, "OCV", "DCIR(m??", " 0.1s DCIR", "o")
-                                                graph_dcir(temp[1].OCV, temp[1].iloc[:, 8], step_ax4, "OCV", "DCIR(m??", " 1.0s DCIR", "o")
-                                                graph_dcir(temp[1].OCV, temp[1].iloc[:, 9], step_ax4, "OCV", "DCIR(m??", "10.0s DCIR", "o")
-                                                graph_dcir(temp[1].OCV, temp[1].iloc[:, 10], step_ax4, "OCV", "DCIR(m??", "20.0s DCIR", "o")
-                                                graph_dcir(temp[1].OCV, temp[1].RSS, step_ax4, "OCV", "DCIR(m??", "RSS DCIR", "o")
-                                                # Data output option
-                                                if self.saveok.isChecked() and save_file_name:
-                                                    # temp[1] = temp[1].iloc[:,[1, 2, 4, 6, 7, 8, 9, 10, 5, 3]]
-                                                    temp[1] = temp[1].iloc[:,[1, 2, 4, 7, 8, 9, 10, 5, 3]]
-                                                    temp[1].to_excel(writer, sheet_name="DCIR", startcol=write_column_num, index=False,
-                                                                        header=[headername + " Capacity(mAh)",
-                                                                                headername + " SOC",
-                                                                                headername + " OCV",
-                                                                                # headername + " OCV_est",
-                                                                                headername + "  0.1s DCIR",
-                                                                                headername + "  1.0s DCIR",
-                                                                                headername + " 10.0s DCIR",
-                                                                                headername + " 20.0s DCIR",
-                                                                                headername + " RSS",
-                                                                                headername + " CCV"])
-                                                    temp[2] = temp[2].iloc[:,[1, 2, 4, 7, 8, 9, 10, 5, 3]]
-                                                    temp[2].to_excel(writer, sheet_name="RSQ", startcol=write_column_num, index=False,
-                                                                        header=[headername + " Capacity(mAh)",
-                                                                                headername + " SOC",
-                                                                                headername + " OCV",
-                                                                                # headername + " OCV_est",
-                                                                                headername + "  0.1s DCIR RSQ",
-                                                                                headername + "  1.0s DCIR RSQ",
-                                                                                headername + " 10.0s DCIR RSQ",
-                                                                                headername + " 20.0s DCIR RSQ",
-                                                                                headername + " RSS",
-                                                                                headername + " CCV"])
-                                                    write_column_num = write_column_num + 9
-                                                if self.CycProfile.isChecked():
-                                                    title = step_namelist[-2] + "=" + step_namelist[-1]
-                                                else:
-                                                    title = step_namelist[-2] + "=" + "%04d" % Step_CycNo
-                                                plt.suptitle(title, fontsize= 15, fontweight='bold')
-                                                step_ax1.legend(loc="lower right")
-                                                step_ax2.legend(loc="upper right")
-                                                step_ax3.legend(loc="lower right")
-                                                step_ax4.legend(loc="upper right")
-                                                tab_layout.addWidget(toolbar)
-                                                tab_layout.addWidget(canvas)
-                                                if temp[1].iloc[0,2] == 100:
-                                                    self.cycle_tab.addTab(tab, "dchg" + str(dchg_tab_no))
-                                                    dchg_tab_no = dchg_tab_no + 1
-                                                else:
-                                                    self.cycle_tab.addTab(tab, "chg" + str(chg_tab_no))
-                                                    chg_tab_no = chg_tab_no + 1
-                                                self.cycle_tab.setCurrentWidget(tab)
-                                                plt.tight_layout(pad=1, w_pad=1, h_pad=1)
-                                                output_fig(self.figsaveok, title)
-                                plt.tight_layout(pad=1, w_pad=1, h_pad=1)
-                                plt.close()
+                            else:
+                                Step_CycNo, Step_CycEnd = int(dcir_continue_step), int(dcir_continue_step)
+                            CycleNo = range(Step_CycNo, Step_CycEnd + 1)
+                            if "Pattern" not in FolderBase:
+                                fig, ((step_ax1, step_ax3), (step_ax2, step_ax4)) = plt.subplots(
+                                    nrows=2, ncols=2, figsize=(14, 8))
+                                tab = QtWidgets.QWidget()
+                                tab_layout = QtWidgets.QVBoxLayout(tab)
+                                canvas = FigureCanvas(fig)
+                                toolbar = NavigationToolbar(canvas, None)
+                                cyccountmax = len(CycleNo)
+                                cyccount = cyccount + 1
+                                progressdata = progress(folder_count, foldercountmax, chnlcount, chnlcountmax, cyccount, cyccountmax)
+                                self.progressBar.setValue(int(progressdata))
+                                step_namelist = FolderBase.split("\\")
+                                headername = step_namelist[-2] + ", " + step_namelist[-1]
+                                if self.CycProfile.isChecked():
+                                    lgnd = "%04d" % Step_CycNo
+                                else:
+                                    lgnd = step_namelist[-1]
+                                if not check_cycler(cyclefolder):
+                                    err_msg("PNE 異⑸갑?꾧린 ?ъ슜 ?붿껌", "DCIR? PNE 異⑸갑?꾧린瑜??ъ슜?섏뿬 痢≪젙 遺???쒕┰?덈떎.")
+                                else:
+                                    temp = pne_dcir_Profile_data(FolderBase, Step_CycNo, Step_CycEnd, mincapacity, firstCrate)
+                                    if (temp is not None) and hasattr(temp[1], "AccCap"):
+                                        if len(temp[1]) > 2:
+                                            self.capacitytext.setText(str(temp[0]))
+                                            graph_soc_continue(temp[1].SOC, temp[1].OCV, step_ax1, 2.0, 4.8, 0.2, "SOC", "OCV/CCV", "OCV", "o")
+                                            graph_soc_continue(temp[1].SOC, temp[1].rOCV, step_ax1, 2.0, 4.8, 0.2, "SOC", "OCV/CCV", "rOCV", "o")
+                                            graph_soc_continue(temp[1].SOC, temp[1].CCV, step_ax1, 2.0, 4.8, 0.2, "SOC", "OCV/CCV","CCV", "o")
+                                            graph_soc_dcir(temp[1].SOC, temp[1].iloc[:, 7], step_ax2, "SOC", "DCIR(m??", " 0.1s DCIR", "o")
+                                            graph_soc_dcir(temp[1].SOC, temp[1].iloc[:, 8], step_ax2, "SOC", "DCIR(m??", " 1.0s DCIR", "o")
+                                            graph_soc_dcir(temp[1].SOC, temp[1].iloc[:, 9], step_ax2, "SOC", "DCIR(m??", "10.0s DCIR", "o")
+                                            graph_soc_dcir(temp[1].SOC, temp[1].iloc[:, 10], step_ax2, "SOC", "DCIR(m??", "20.0s DCIR", "o")
+                                            graph_soc_dcir(temp[1].SOC, temp[1].RSS, step_ax2, "SOC", "DCIR(m??", "RSS DCIR", "o")
+                                            graph_continue(temp[1].OCV, temp[1].SOC, step_ax3, -20, 120, 10, "Voltage (V)", "SOC","OCV", "o")
+                                            graph_continue(temp[1].CCV, temp[1].SOC, step_ax3, -20, 120, 10, "Voltage (V)", "SOC","CCV", "o")
+                                            graph_dcir(temp[1].OCV, temp[1].iloc[:, 7], step_ax4, "OCV", "DCIR(m??", " 0.1s DCIR", "o")
+                                            graph_dcir(temp[1].OCV, temp[1].iloc[:, 8], step_ax4, "OCV", "DCIR(m??", " 1.0s DCIR", "o")
+                                            graph_dcir(temp[1].OCV, temp[1].iloc[:, 9], step_ax4, "OCV", "DCIR(m??", "10.0s DCIR", "o")
+                                            graph_dcir(temp[1].OCV, temp[1].iloc[:, 10], step_ax4, "OCV", "DCIR(m??", "20.0s DCIR", "o")
+                                            graph_dcir(temp[1].OCV, temp[1].RSS, step_ax4, "OCV", "DCIR(m??", "RSS DCIR", "o")
+                                            # Data output option
+                                            if self.saveok.isChecked() and save_file_name:
+                                                # temp[1] = temp[1].iloc[:,[1, 2, 4, 6, 7, 8, 9, 10, 5, 3]]
+                                                temp[1] = temp[1].iloc[:,[1, 2, 4, 7, 8, 9, 10, 5, 3]]
+                                                temp[1].to_excel(writer, sheet_name="DCIR", startcol=write_column_num, index=False,
+                                                                    header=[headername + " Capacity(mAh)",
+                                                                            headername + " SOC",
+                                                                            headername + " OCV",
+                                                                            # headername + " OCV_est",
+                                                                            headername + "  0.1s DCIR",
+                                                                            headername + "  1.0s DCIR",
+                                                                            headername + " 10.0s DCIR",
+                                                                            headername + " 20.0s DCIR",
+                                                                            headername + " RSS",
+                                                                            headername + " CCV"])
+                                                temp[2] = temp[2].iloc[:,[1, 2, 4, 7, 8, 9, 10, 5, 3]]
+                                                temp[2].to_excel(writer, sheet_name="RSQ", startcol=write_column_num, index=False,
+                                                                    header=[headername + " Capacity(mAh)",
+                                                                            headername + " SOC",
+                                                                            headername + " OCV",
+                                                                            # headername + " OCV_est",
+                                                                            headername + "  0.1s DCIR RSQ",
+                                                                            headername + "  1.0s DCIR RSQ",
+                                                                            headername + " 10.0s DCIR RSQ",
+                                                                            headername + " 20.0s DCIR RSQ",
+                                                                            headername + " RSS",
+                                                                            headername + " CCV"])
+                                                write_column_num = write_column_num + 9
+                                            if self.CycProfile.isChecked():
+                                                title = step_namelist[-2] + "=" + step_namelist[-1]
+                                            else:
+                                                title = step_namelist[-2] + "=" + "%04d" % Step_CycNo
+                                            plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
+                                            step_ax1.legend(loc="lower right")
+                                            step_ax2.legend(loc="upper right")
+                                            step_ax3.legend(loc="lower right")
+                                            step_ax4.legend(loc="upper right")
+                                            tab_layout.addWidget(toolbar)
+                                            tab_layout.addWidget(canvas)
+                                            if temp[1].iloc[0,2] == 100:
+                                                self.cycle_tab.addTab(tab, "dchg" + str(dchg_tab_no))
+                                                dchg_tab_no = dchg_tab_no + 1
+                                            else:
+                                                self.cycle_tab.addTab(tab, "chg" + str(chg_tab_no))
+                                                chg_tab_no = chg_tab_no + 1
+                                            self.cycle_tab.setCurrentWidget(tab)
+                                            plt.tight_layout(pad=1, w_pad=1, h_pad=1)
+                                            output_fig(self.figsaveok, title)
+                            plt.tight_layout(pad=1, w_pad=1, h_pad=1)
+                            plt.close()
         if self.saveok.isChecked() and save_file_name:
             writer.close()
         self.progressBar.setValue(100)
@@ -10940,6 +12041,10 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
             toyo_data.loc[(toyo_data["chno"] == 0) & (toyo_data["use"] == 0), "use"] = "?묒뾽?뺤?"
             toyo_data.loc[toyo_data["use"] == 1, "use"] = "?묒뾽以?
             toyo_data["chno"] = toyo_data.index
+        else:
+            # ?뚯씪???녿뒗 寃쎌슦 鍮?DataFrame 諛섑솚
+            toyo_data = pd.DataFrame(columns=self.toyo_column_list[0:4])
+            used_chnl = 0
         return [toyo_data, used_chnl]
 
     def toyo_data_make(self, toyo_num, blkname):
@@ -11957,7 +13062,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
             fig, ((ax1), (ax2)) = plt.subplots(nrows=1, ncols=2, figsize=(8, 3))
             filecount = 0
             mincapa = int(self.SetMincapacity.text())
-            graphcolor = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf']
+            graphcolor = THEME['PALETTE']
             if self.saveok.isChecked():
                 save_file_name = filedialog.asksaveasfilename(initialdir="D://", title="Save File Name", defaultextension=".xlsx")
                 if save_file_name:
@@ -12399,7 +13504,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
             canvas = FigureCanvas(fig)
             toolbar = NavigationToolbar(canvas, None)
             filecount = 0
-            graphcolor = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf']
+            graphcolor = THEME['PALETTE']
             if self.saveok.isChecked():
                 save_file_name = filedialog.asksaveasfilename(initialdir="D://", title="Save File Name", defaultextension=".xlsx")
                 if save_file_name:
@@ -13069,7 +14174,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
             if save_file_name:
                 writer = pd.ExcelWriter(save_file_name, engine="xlsxwriter")
         self.pathappcycestimation.setEnabled(True)
-        graphcolor = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf']
+        graphcolor = THEME['PALETTE']
         for i, cyclefolder in enumerate(all_data_folder):
             # tab 洹몃옒??異붽?
             fig, ax1 = plt.subplots(nrows=1, ncols=1, figsize=(8, 6))
@@ -13151,7 +14256,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                                      label='媛??= %5.3f' % tuple(popt2[0] / p2))
                             ax1.plot(df2.x2, cyccapparameter02((df2.x2, df2.t2), *popt2) * cyctemp[4], '--', color=graphcolor[colorno],
                                      label='?ㅼ감 = %5.3f' % r_squared2)
-                            colorno = colorno % 9 + 1
+                            colorno = colorno % len(THEME['PALETTE']) + 1
                             # Data output option
                             output_df_all = cyctemp[7][["Dchg", "Temp", "Curr", "max_vol", "min_vol"]]
                             output_df_05c = cyctemp[1][["Dchg", "Temp", "Curr", "max_vol", "min_vol"]]
@@ -13162,9 +14267,9 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                                 output_df_02c.to_excel(writer, sheet_name="rate02c_cycle", startcol=writecolno)
                                 writecolno = writecolno + 6
                             if len(all_data_name) != 0:
-                                plt.suptitle(title, fontsize= 15, fontweight='bold')
+                                plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
                             else:
-                                plt.suptitle(title, fontsize= 15, fontweight='bold')
+                                plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
                             ax1.tick_params(axis='both', which='major', labelsize=12) 
                             ax1.legend(loc="center left", bbox_to_anchor=(1, 0.5))
                             ax1.set_ylim(float(self.simul_y_min.text()), float(self.simul_y_max.text()))
@@ -13221,7 +14326,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         self.folderappcycestimation.setDisabled(True)
         pne_path = filedialog.askopenfilenames(initialdir="D://", title="Data File Name", defaultextension=".txt")
         self.folderappcycestimation.setEnabled(True)
-        graphcolor = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf']
+        graphcolor = THEME['PALETTE']
         for i, cyclefolder in enumerate(pne_path):
             # tab 洹몃옒??異붽?
             if os.path.exists(cyclefolder):
@@ -13297,7 +14402,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                                      label='0.2C 媛??= %5.3f' % tuple(popt2[0] / p2))
                             ax1.plot(df2.x2, cyccapparameter02((df2.x2, df2.t2), *popt2) * cyctemp[4], '--', color=graphcolor[colorno],
                                      label='0.2C ?ㅼ감 = %5.3f' % r_squared2)
-                            colorno = colorno % 9 + 1
+                            colorno = colorno % len(THEME['PALETTE']) + 1
                             ax1.tick_params(axis='both', which='major', labelsize=12) 
                             ax1.legend(loc="center left", bbox_to_anchor=(1, 0.5))
                             ax1.set_ylim(float(self.simul_y_min.text()), float(self.simul_y_max.text()))
@@ -13305,7 +14410,7 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
                             ax1.set_xlabel('cycle or day', fontsize = 14)
                             ax1.grid(which="major", axis="both", alpha=.5)
                             plt.tight_layout(pad=1, w_pad=1, h_pad=1)
-                            plt.suptitle(title, fontsize= 15, fontweight='bold')
+                            plt.suptitle(title, fontsize=THEME['SUPTITLE_SIZE'], fontweight=THEME['SUPTITLE_WEIGHT'])
                             tab_layout.addWidget(toolbar)
                             tab_layout.addWidget(canvas)
                             self.cycle_simul_tab.addTab(tab, f"?덉륫{num}")
@@ -14696,8 +15801,508 @@ class WindowClass(QtWidgets.QMainWindow, Ui_sitool):
         if len(self.ptn_df_select) == 0:
             self.ptn_df_select = [""]
 
+    # ===================================================================
+    # PNE ??Toyo ?⑦꽩 蹂??湲곕뒫
+    # ===================================================================
+
+    # --- Toyo PATRN ?쒕툕?ㅽ뀦 ?쒗뵆由?(PATRN1.1 湲곗? 異붿텧) ---
+    # LEFT ?쒕툕?ㅽ뀦 = 261 chars, RIGHT ?쒕툕?ㅽ뀦 = 272 chars, LOOP = 10 chars
+    TOYO_CHARGE_LEFT = (
+        " 10       399    4.47       0       -       -       -    39.9"
+        "       -       -       -       -       -      60       -"
+        "       -       -       -       -       -       -       -"
+        "       -       -   0 - 0                      -       -0"
+        "  - -  010       -       -    60"
+    )
+    TOYO_CHARGE_CC_LEFT = (
+        " 10    2593.5    4.16       0       -       -       -    1995"
+        "       -       -       -       -       -      60       -"
+        "       -       -       -       -       -       -       -"
+        "       -       -   0 - 0                      -       -0"
+        "  - -  0 0       -       -    60"
+    )
+    TOYO_REST_LEFT = (
+        " 30         0       0       0       -       -       -       -"
+        "       -       -       -       -       -       -       -"
+        "       -       -       -       -       -       -       -"
+        "       -       -   0 0 0                      -       -0"
+        "  0 0  0 0       -       -     -"
+    )
+    TOYO_DCHG_RIGHT = (
+        " 00       399       0       0                      2.75"
+        "       -       -       -       -       -      60       -"
+        "       -       -       -       -       -       -       -"
+        "       -       -   0 - 0                    -       -0"
+        "                    - -  010       -       -    60 "
+    )
+    TOYO_DCHG_NO_INTERVAL_RIGHT = (
+        " 00       399       0       0                      2.75"
+        "       -       -       -       -       -       -       -"
+        "       -       -       -       -       -       -       -"
+        "       -       -   0 - 0                    -       -0"
+        "                    - -  010       -       -    60 "
+    )
+    TOYO_REST_RIGHT = (
+        " 30         0       0       0                         -"
+        "       -       -       -       -       -       -       -"
+        "       -       -       -       -       -       -       -"
+        "       -       -   0 0 0                    -       -0"
+        "                    0 0  0 0       -       -     - "
+    )
+    TOYO_LOOP_NONE = " 1      01"
+    # ?ㅻ뜑 ?쒗뵆由?(PATRN1.1 湲곗?, ?대쫫/?쇱씤???쒖쇅??怨좎젙 遺遺?= 202 諛붿씠??
+    TOYO_HEADER_PREFIX = (
+        "0 00009       -        -    4.55"
+        "       0       -       -      60       0       -       -"
+        "  20000000000000000000000000000000000000000000000000000000000001"
+        "  10111001010000000000     11100  1 1   0   0   00"
+    )
+
+    @staticmethod
+    def _toyo_fmt_num(value):
+        """?レ옄瑜?Toyo PATRN ?뺤떇 臾몄옄?대줈 蹂??(?뺤닔硫??뺤닔, ?뚯닔硫??뚯닔)"""
+        if value == 0:
+            return "0"
+        if value == int(value):
+            return str(int(value))
+        return f"{value:g}"
+
+    def _toyo_substitute(self, template, positions):
+        """?쒗뵆由?臾몄옄?댁쓽 吏???꾩튂??媛믪쓣 right-justify濡????""
+        t = list(template)
+        for (start, end), value_str in positions:
+            field_width = end - start
+            t[start:end] = list(value_str.rjust(field_width))
+        return "".join(t)
+
+    def _toyo_build_charge_left(self, current_mA, voltage_V, endI_mA, is_cccv=True, interval_s=60):
+        """異⑹쟾 LEFT ?쒕툕?ㅽ뀦 ?앹꽦 (261 chars)"""
+        template = self.TOYO_CHARGE_LEFT if is_cccv else self.TOYO_CHARGE_CC_LEFT
+        subs = [
+            ((3, 13), self._toyo_fmt_num(current_mA)),
+            ((13, 21), self._toyo_fmt_num(voltage_V)),
+            ((53, 61), self._toyo_fmt_num(endI_mA)),
+        ]
+        if interval_s > 0:
+            subs.append(((101, 109), str(int(interval_s))))
+        return self._toyo_substitute(template, subs)
+
+    def _toyo_build_dchg_right(self, current_mA, endV_V, interval_s=60):
+        """諛⑹쟾 RIGHT ?쒕툕?ㅽ뀦 ?앹꽦 (272 chars)"""
+        template = self.TOYO_DCHG_RIGHT if interval_s > 0 else self.TOYO_DCHG_NO_INTERVAL_RIGHT
+        subs = [
+            ((3, 13), self._toyo_fmt_num(current_mA)),
+            ((29, 55), self._toyo_fmt_num(endV_V)),
+        ]
+        if interval_s > 0:
+            subs.append(((95, 103), str(int(interval_s))))
+        return self._toyo_substitute(template, subs)
+
+    def _toyo_build_rest_left(self):
+        """?댁? LEFT ?쒕툕?ㅽ뀦 ?앹꽦 (261 chars)"""
+        return self.TOYO_REST_LEFT
+
+    def _toyo_build_rest_right(self):
+        """?댁? RIGHT ?쒕툕?ㅽ뀦 ?앹꽦 (272 chars)"""
+        return self.TOYO_REST_RIGHT
+
+    def _toyo_build_loop(self, target_line=0, count=0):
+        """猷⑦봽 ?뺣낫 臾몄옄???앹꽦 (10 chars)"""
+        if target_line <= 0 or count <= 0:
+            return self.TOYO_LOOP_NONE
+        return f" 1{target_line:>2}{count:>4}01"
+
+    def _toyo_build_line(self, left_sub, right_sub, loop_str):
+        """PATRN ?곗씠???쇱씤 = LEFT(261) + RIGHT(272) + LOOP(10) = 543"""
+        return left_sub + right_sub + loop_str
+
+    def _toyo_build_header(self, pattern_name, num_lines):
+        """PATRN ?ㅻ뜑 ?쇱씤 ?앹꽦 (265 諛붿씠?? cp949 湲곗? 42諛붿씠???대쫫 ?꾨뱶)"""
+        # ?대쫫??cp949濡??몄퐫?⑺븯??42諛붿씠?몄뿉 留욎땄
+        name_bytes = pattern_name.encode("cp949", errors="replace")[:42]
+        name_bytes = name_bytes.ljust(42, b" ")
+        # ?곸닔 遺遺?(諛붿씠??43~265)
+        suffix = self.TOYO_HEADER_PREFIX.encode("ascii")
+        line_count = f"{num_lines:>21}".encode("ascii")
+        return (name_bytes + suffix + line_count).decode("cp949")
+
+    def _toyo_build_option(self, capacity_mAh):
+        """Patrn.option ?뚯씪 ?댁슜 ?앹꽦"""
+        return f"[BaseCellCapacity]\nPattern_BaseCellCapacity={int(capacity_mAh)}\n"
+
+    def _toyo_build_option2(self, line_types):
+        """Patrn.option2 ?뚯씪 ?댁슜 ?앹꽦 (PATRN ?곗씠???쇱씤 ?⑥쐞)
+        
+        Args:
+            line_types: list of str, 媛?PATRN ?쇱씤?????("active" ?먮뒗 "rest")
+                        RIGHT ?쒕툕?ㅽ뀦??discharge硫?"active", ?꾨땲硫?"rest"
+        """
+        # ?ㅻ뜑 ?쇱씤 (怨좎젙 266 chars)
+        header = (
+            "0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,-,-,-,-,-,-,-,0,1,-,-,,,-,-,TOYO,,-,-,-,"
+            "-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,"
+            "1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,,1000,0,0,-,0,0,0,0,1,1,,1,,"
+        )
+        # 泥?踰덉㎏ ?쇱씤 (295 chars) ??active/rest
+        first_active = (
+            "0,0,0,1,0,1,0,1,0,-,-,0,-,-,,,-,-,,,-,-,1,0,0,0,,,,,-,-,0,0,0,0,0,0,-,-,-,-,-,-,-,-,0,0,0,0,0,0,-,-,"
+            "0,1,0,1,0,0,1,0,1,0,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,,,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-"
+        )
+        first_rest = (
+            "0,0,0,0,0,0,0,0,0,-,-,0,-,-,,,-,-,,,-,-,1,0,0,0,,,,,-,-,0,0,0,0,0,0,-,-,-,-,-,-,-,-,0,0,0,0,0,0,-,-,"
+            "0,1,0,1,0,0,1,0,1,0,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,,,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-"
+        )
+        # 以묎컙 ?쇱씤 (299 chars) ??active/rest
+        middle_active = (
+            "0,0,0,1,0,1,0,1,0,-,-,0,-,-,-,-,-,-,-,-,-,-,1,0,0,0,,,,,-,-,0,0,0,0,0,0,-,-,-,-,-,-,-,-,0,0,0,0,0,0,-,-,"
+            "0,1,0,1,0,0,1,0,1,0,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,,,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-"
+        )
+        middle_rest = (
+            "0,0,0,0,0,0,0,0,0,-,-,0,-,-,-,-,-,-,-,-,-,-,1,0,0,0,,,,,-,-,0,0,0,0,0,0,-,-,-,-,-,-,-,-,0,0,0,0,0,0,-,-,"
+            "0,1,0,1,0,0,1,0,1,0,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,,,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-"
+        )
+        # 留덉?留??쇱씤 (295 chars) ????긽 end ?뺤떇
+        end_line = (
+            "0,0,0,0,0,0,0,0,0,-,-,0,-,-,-,-,,,-,-,,,1,0,0,0,,,,,-,-,0,0,0,0,0,0,-,-,-,-,-,-,-,-,0,0,0,0,0,0,-,-,"
+            "0,1,0,1,0,0,1,0,1,0,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,0,1,0,1,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,,,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-"
+        )
+
+        lines = [header]
+        for i, ltype in enumerate(line_types):
+            if i == len(line_types) - 1:
+                lines.append(end_line)
+            elif i == 0:
+                lines.append(first_active if ltype == "active" else first_rest)
+            else:
+                lines.append(middle_active if ltype == "active" else middle_rest)
+        return "\n".join(lines) + "\n"
+
+    def _toyo_build_puls_dir(self, num_lines):
+        """Fld_Puls.DIR ?뚯씪 ?앹꽦 (PATRN ?곗씠???쇱씤 ?섎쭔??"""
+        return ",\n" * num_lines
+
+    def _pne_steps_to_toyo_substeps(self, steps_df):
+        """PNE Step ?뚯씠釉?rows ??Toyo ?쒕툕?ㅽ뀦 由ъ뒪??蹂??+        
+        Args:
+            steps_df: DataFrame with StepType, Iref, EndI, Vref_Charge, Vref_DisCharge, EndV, Value2
+        
+        Returns:
+            list of dicts: [{type, left_sub, right_sub, loop_target, loop_count}, ...]
+            媛?dict = PATRN ?곗씠???쇱씤 1媛?(?쒕툕?ㅽ뀦 2媛???
+        """
+        # PNE ?ㅽ뀦??Toyo ?쒕툕?ㅽ뀦?쇰줈 蹂??(Loop ?쒖쇅)
+        substeps = []  # [(type_str, ...)]
+        pne_step_indices = []  # substeps? 1:1 留ㅽ븨, PNE ?먮낯 ?몃뜳??(0-based)
+        loop_info = {}  # {substeps_index: (target_pne_step_1based, count)}
+        pne_idx = 0  # PNE DataFrame ???몃뜳??(0-based)
+
+        for idx, row in steps_df.iterrows():
+            step_type = int(row.get("StepType", 0))
+            iref = float(row.get("Iref", 0) or 0)
+            end_i = float(row.get("EndI", 0) or 0)
+            vref_chg = float(row.get("Vref_Charge", 0) or 0)
+            vref_dchg = float(row.get("Vref_DisCharge", 0) or 0)
+            end_v = float(row.get("EndV", 0) or 0)
+            value2 = str(row.get("Value2", "") or "").strip()
+
+            if step_type == 1:  # 異⑹쟾
+                voltage_V = vref_chg / 1000.0 if vref_chg > 0 else 4.2
+                # CC-CV ?먮떒: EndI/Iref < 0.3 ??CV cutoff (?뚮웾 ?꾨쪟)
+                # EndI/Iref >= 0.3 ??CC 紐⑤뱶 (?⑸웾 ?쒗븳)
+                if end_i > 0 and iref > 0:
+                    is_cccv = (end_i / iref) < 0.3
+                else:
+                    is_cccv = False
+                end_val = end_i if end_i > 0 else iref
+                substeps.append(("charge", iref, voltage_V, end_val, is_cccv))
+                pne_step_indices.append(pne_idx)
+            elif step_type == 2:  # 諛⑹쟾
+                endV_V = vref_dchg / 1000.0 if vref_dchg > 0 else (end_v / 1000.0 if end_v > 0 else 3.0)
+                substeps.append(("discharge", iref, endV_V))
+                pne_step_indices.append(pne_idx)
+            elif step_type == 3 or step_type == 4:  # ?댁? / OCV
+                substeps.append(("rest",))
+                pne_step_indices.append(pne_idx)
+            elif step_type == 5:  # Impedance (?꾩뒪 痢≪젙)
+                # 吏㏃? 諛⑹쟾 ?꾩뒪濡?蹂??+                substeps.append(("discharge", iref, 0))
+                pne_step_indices.append(pne_idx)
+            elif step_type == 8:  # Loop
+                # Value2?먯꽌 loop ????ㅽ뀦 踰덊샇 異붿텧
+                import re as _re
+                nums = _re.findall(r'\d+', value2)
+                if nums:
+                    target_pne_step = int(nums[0])  # 1-based PNE step number
+                    loop_count = int(iref) if iref > 0 else 99
+                    loop_info[len(substeps)] = (target_pne_step, loop_count)
+                substeps.append(("loop",))
+                pne_step_indices.append(pne_idx)
+            elif step_type == 6:  # End
+                pne_idx += 1
+                continue  # 嫄대꼫?
+            elif step_type == 9:  # Continuation
+                # ?댁쟾 ?ㅽ뀦 而⑦뀓?ㅽ듃???곕씪 異⑹쟾/諛⑹쟾
+                if len(substeps) > 0 and substeps[-1][0] == "charge":
+                    voltage_V = vref_chg / 1000.0 if vref_chg > 0 else 4.2
+                    if end_i > 0 and iref > 0:
+                        is_cccv = (end_i / iref) < 0.3
+                    else:
+                        is_cccv = False
+                    end_val = end_i if end_i > 0 else iref
+                    substeps.append(("charge", iref, voltage_V, end_val, is_cccv))
+                else:
+                    endV_V = vref_dchg / 1000.0 if vref_dchg > 0 else 3.0
+                    substeps.append(("discharge", iref, endV_V))
+                pne_step_indices.append(pne_idx)
+            else:
+                # 誘몄?????????댁?濡?泥섎━
+                substeps.append(("rest",))
+                pne_step_indices.append(pne_idx)
+
+            pne_idx += 1
+
+        # Loop ?ㅽ뀦 ?먯껜??Toyo?먯꽌 蹂꾨룄 ?쇱씤???꾨떂 ???쒓굅?섍퀬 ?댁쟾 ?쇱씤??loop ?뺣낫 遺李?+        # ?ㅼ젣 ?쒕툕?ㅽ뀦留??④린湲?(loop ?쒖쇅)
+        actual_substeps = []
+        actual_pne_indices = []  # actual_substeps? 1:1 留ㅽ븨
+        actual_loop_attach = {}  # {actual_idx: (target_pne_step_1based, count)}
+        for i, sub in enumerate(substeps):
+            if sub[0] == "loop":
+                # ?댁쟾 actual ?쒕툕?ㅽ뀦??loop ?뺣낫 遺李?+                if i in loop_info and len(actual_substeps) > 0:
+                    actual_loop_attach[len(actual_substeps) - 1] = loop_info[i]
+            else:
+                actual_substeps.append(sub)
+                actual_pne_indices.append(pne_step_indices[i])
+
+        # ?쒕툕?ㅽ뀦???쇱씤?쇰줈 議곕┰?섎㈃??pne_idx ??toyo_line 留ㅽ븨 ?앹꽦
+        patrn_lines = []
+        line_types = []  # option2?? ?쇱씤 ??"active"(RIGHT=諛⑹쟾) ?먮뒗 "rest"
+        pne_to_toyo_line = {}  # {pne_step_0based: toyo_line_1based}
+        queue = list(enumerate(zip(actual_substeps, actual_pne_indices)))  # [(actual_idx, (sub, pne_idx))]
+
+        while queue:
+            actual_idx_a, (sub_a, pne_idx_a) = queue.pop(0)
+            toyo_line_no = len(patrn_lines) + 1  # ?꾩옱 ?쇱씤 踰덊샇 (1-based)
+
+            # pne_idx ??toyo_line 留ㅽ븨 ?깅줉
+            if pne_idx_a not in pne_to_toyo_line:
+                pne_to_toyo_line[pne_idx_a] = toyo_line_no
+
+            # LEFT ?쒕툕?ㅽ뀦 寃곗젙
+            if sub_a[0] == "charge":
+                _, curr, volt, end_val, is_cccv = sub_a
+                left = self._toyo_build_charge_left(curr, volt, end_val, is_cccv)
+                # RIGHT: ?ㅼ쓬 ?쒕툕?ㅽ뀦 ?뚮퉬
+                if queue:
+                    actual_idx_b, (sub_b, pne_idx_b) = queue.pop(0)
+                else:
+                    sub_b = ("rest",)
+                    actual_idx_b = -1
+                    pne_idx_b = -1
+            elif sub_a[0] == "discharge":
+                # 諛⑹쟾? RIGHT濡???LEFT??REST, sub_a瑜?RIGHT濡??ъ슜
+                left = self._toyo_build_rest_left()
+                sub_b = sub_a
+                actual_idx_b = actual_idx_a
+                pne_idx_b = pne_idx_a
+            else:  # rest, OCV ??+                left = self._toyo_build_rest_left()
+                if queue:
+                    actual_idx_b, (sub_b, pne_idx_b) = queue.pop(0)
+                else:
+                    sub_b = ("rest",)
+                    actual_idx_b = -1
+                    pne_idx_b = -1
+
+            # pne_idx_b ??toyo_line 留ㅽ븨 ?깅줉
+            if pne_idx_b >= 0 and pne_idx_b not in pne_to_toyo_line:
+                pne_to_toyo_line[pne_idx_b] = toyo_line_no
+
+            # RIGHT ?쒕툕?ㅽ뀦 鍮뚮뱶 + ?쇱씤 ???寃곗젙
+            right_is_discharge = False
+            if sub_b[0] == "discharge":
+                curr = sub_b[1]
+                endV = sub_b[2] if len(sub_b) > 2 else 3.0
+                # LEFT媛 REST?대㈃ interval ?놁쓬 (泥??쇱씤 珥덇린 諛⑹쟾 ??
+                iv = 0 if sub_a[0] == "rest" or sub_a[0] == "discharge" else 60
+                right = self._toyo_build_dchg_right(curr, endV, interval_s=iv)
+                right_is_discharge = True
+            elif sub_b[0] == "charge":
+                # 異⑹쟾??RIGHT???ㅻ㈃ ??REST RIGHT濡??泥? 異⑹쟾? ?ㅼ쓬 ?쇱씤 LEFT濡??댁썡
+                right = self._toyo_build_rest_right()
+                queue.insert(0, (actual_idx_b, (sub_b, pne_idx_b)))  # ?ㅼ떆 ???욎뿉 ?ｊ린
+                # pne_to_toyo_line ?깅줉 痍⑥냼 (?ㅼ쓬 ?쇱씤?먯꽌 ?ㅼ떆 ?깅줉??
+                if pne_idx_b in pne_to_toyo_line and pne_to_toyo_line[pne_idx_b] == toyo_line_no:
+                    del pne_to_toyo_line[pne_idx_b]
+            else:  # rest
+                right = self._toyo_build_rest_right()
+
+            line_types.append("active" if right_is_discharge else "rest")
+
+            # Loop ?뺣낫 ?뺤씤 ??actual_idx 湲곕컲?쇰줈 actual_loop_attach 議고쉶
+            loop_target = 0
+            loop_count = 0
+            for check_idx in [actual_idx_a, actual_idx_b]:
+                if check_idx >= 0 and check_idx in actual_loop_attach:
+                    target_pne_1based, count = actual_loop_attach[check_idx]
+                    # target_pne??1-based PNE ?ㅽ뀦 踰덊샇
+                    # pne_to_toyo_line?먯꽌 ?대떦 PNE ?ㅽ뀦??Toyo ?쇱씤 踰덊샇 議고쉶
+                    target_pne_0based = target_pne_1based - 1
+                    if target_pne_0based in pne_to_toyo_line:
+                        loop_target = pne_to_toyo_line[target_pne_0based]
+                    else:
+                        # 留ㅽ븨???놁쑝硫?洹쇱궗 怨꾩궛
+                        loop_target = max(1, (target_pne_1based + 1) // 2)
+                    loop_count = count
+
+            loop_str = self._toyo_build_loop(loop_target, loop_count)
+            line = self._toyo_build_line(left, right, loop_str)
+            patrn_lines.append(line)
+
+        return patrn_lines, line_types
+
+    def ptn_toyo_convert_button(self):
+        """PNE ?⑦꽩??Toyo PATRN ?뚯씪濡?蹂??""
+        self.progressBar.setValue(0)
+        ptn_ori_path = str(self.ptn_ori_path.text())
+
+        # ?좏깮???⑦꽩 ?뺤씤
+        if (not hasattr(self, "ptn_df_select")) or len(self.ptn_df_select) == 0 or self.ptn_df_select[0] == "":
+            QtWidgets.QMessageBox.warning(self, "?뚮┝", "?⑦꽩??癒쇱? ?좏깮?섏꽭??\n?⑦꽩 Load ??紐⑸줉?먯꽌 ?됱쓣 ?좏깮?섏꽭??")
+            return
+
+        # MDB 寃쎈줈 ?뺤씤
+        if not os.path.isfile(ptn_ori_path):
+            ptn_ori_path = filedialog.askopenfilename(
+                initialdir="c:\\Program Files\\PNE CTSPro\\Database\\",
+                title="MDB ?뚯씪 ?좏깮",
+                filetypes=[("Access DB", "*.mdb *.accdb")]
+            )
+            if not ptn_ori_path:
+                return
+            self.ptn_ori_path.setText(str(ptn_ori_path))
+
+        # 異쒕젰 ?대뜑 ?좏깮
+        output_dir = QtWidgets.QFileDialog.getExistingDirectory(self, "Toyo ?⑦꽩 ????대뜑 ?좏깮")
+        if not output_dir:
+            return
+
+        # ?⑦꽩 踰덊샇 ?낅젰
+        patrn_num, ok = QtWidgets.QInputDialog.getInt(
+            self, "?⑦꽩 踰덊샇", "Toyo ?⑦꽩 踰덊샇 (PATRN{N}.1):", 1, 1, 999
+        )
+        if not ok:
+            return
+
+        # ?⑸웾 ?낅젰 (ptn_capacity 媛??ъ슜)
+        try:
+            capacity_mAh = float(self.ptn_capacity.text())
+        except (ValueError, AttributeError):
+            capacity_mAh = 1000
+
+        # MDB ?곌껐
+        conn_str = (
+            r'DRIVER={Microsoft Access Driver (*.mdb, *.accdb)};'
+            r'DBQ=' + ptn_ori_path + ';'
+        )
+        try:
+            conn = pyodbc.connect(conn_str)
+        except Exception as e:
+            QtWidgets.QMessageBox.critical(self, "?ㅻ쪟", f"MDB ?곌껐 ?ㅽ뙣:\n{e}")
+            return
+
+        results = []
+        for idx, test_id in enumerate(self.ptn_df_select):
+            current_patrn_num = patrn_num + idx
+
+            # Step ?곗씠??議고쉶
+            steps_df = pd.read_sql(
+                f"SELECT * FROM Step WHERE TestID = {test_id} ORDER BY StepID", conn
+            )
+            if steps_df.empty:
+                results.append(f"TestID {test_id}: Step ?곗씠???놁쓬")
+                continue
+
+            # TestName 議고쉶
+            try:
+                test_info = pd.read_sql(
+                    f"SELECT TestName FROM TestName WHERE TestID = {test_id}", conn
+                )
+                pattern_name = test_info.iloc[0]["TestName"] if not test_info.empty else f"Pattern_{test_id}"
+            except Exception:
+                pattern_name = f"Pattern_{test_id}"
+
+            # PNE ??Toyo 蹂??+            try:
+                patrn_lines, line_types = self._pne_steps_to_toyo_substeps(steps_df)
+            except Exception as e:
+                results.append(f"TestID {test_id}: 蹂???ㅻ쪟 - {e}")
+                continue
+
+            if not patrn_lines:
+                results.append(f"TestID {test_id}: 蹂??寃곌낵 ?놁쓬")
+                continue
+
+            num_lines = len(patrn_lines)
+
+            # 1) PATRN{N}.1 ?앹꽦
+            header = self._toyo_build_header(pattern_name, num_lines)
+            patrn_content = header + "\n" + "\n".join(patrn_lines) + "\n"
+            patrn_path = os.path.join(output_dir, f"PATRN{current_patrn_num}.1")
+            with open(patrn_path, "w", encoding="cp949") as f:
+                f.write(patrn_content)
+
+            # 2) Patrn{N}.option ?앹꽦
+            option_content = self._toyo_build_option(capacity_mAh)
+            option_path = os.path.join(output_dir, f"Patrn{current_patrn_num}.option")
+            with open(option_path, "w", encoding="cp949") as f:
+                f.write(option_content)
+
+            # 3) Patrn{N}.option2 ?앹꽦
+            option2_content = self._toyo_build_option2(line_types)
+            option2_path = os.path.join(output_dir, f"Patrn{current_patrn_num}.option2")
+            with open(option2_path, "w", encoding="cp949") as f:
+                f.write(option2_content)
+
+            # 4) Fld_Puls{N}.DIR ?앹꽦
+            puls_content = self._toyo_build_puls_dir(num_lines)
+            puls_path = os.path.join(output_dir, f"Fld_Puls{current_patrn_num}.DIR")
+            with open(puls_path, "w", encoding="cp949") as f:
+                f.write(puls_content)
+
+            # 5) Fld_Thermo{N}.DIR ?앹꽦 (鍮??뚯씪)
+            thermo_path = os.path.join(output_dir, f"Fld_Thermo{current_patrn_num}.DIR")
+            with open(thermo_path, "w", encoding="cp949") as f:
+                f.write("")
+
+            # 6) THPTNNO.1 ?앹꽦 (鍮??뚯씪, ?놁쑝硫?
+            thptn_path = os.path.join(output_dir, "THPTNNO.1")
+            if not os.path.exists(thptn_path):
+                with open(thptn_path, "w", encoding="cp949") as f:
+                    f.write("")
+
+            results.append(
+                f"TestID {test_id} ??PATRN{current_patrn_num}.1 "
+                f"({num_lines}?쇱씤, {len(steps_df)}?ㅽ뀦)"
+            )
+            self.progressBar.setValue(int((idx + 1) / len(self.ptn_df_select) * 100))
+
+        conn.close()
+
+        # 寃곌낵 ?쒖떆
+        msg = "Toyo ?⑦꽩 蹂???꾨즺\n\n" + "\n".join(results) + f"\n\n????꾩튂: {output_dir}"
+        QtWidgets.QMessageBox.information(self, "蹂???꾨즺", msg)
+        self.progressBar.setValue(100)
+
 # UI ?ㅽ뻾
 if __name__ == "__main__":
+    # ?щ’ ?대? ?덉쇅瑜?肄섏넄??異쒕젰
+    def _exception_hook(exctype, value, traceback):
+        sys.__excepthook__(exctype, value, traceback)
+    sys.excepthook = _exception_hook
+
     # HiDPI ?ㅼ??쇰쭅??紐낆떆?곸쑝濡?鍮꾪솢?깊솕?⑸땲??
     # os.environ['QT_ENABLE_HIGHDPI_SCALING'] = '0'
     # os.environ['QT_SCALE_FACTOR'] = '1.0'
